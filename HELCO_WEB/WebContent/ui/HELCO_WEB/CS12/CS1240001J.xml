<?xml version="1.0" encoding="utf-8"?>
<Window>
	<Form Height="280" Id="CS1240001J" Left="8" OnLoadCompleted="fn_OnLoadCompleted" OnUnloadCompleted="fn_OnUnloadCompleted" PidAttrib="7" Title="인원상주" Top="8" Ver="1.0" Width="528" WorkArea="true">
		<Datasets>
			<Dataset CanColumnChange="ds_list3_CanColumnChange" DataSetType="Dataset" Id="ds_list3" OnColumnChanged="ds_list3_OnColumnChanged">
				<Contents>
					<colinfo id="FLAG" size="256" summ="default" type="STRING"/>
					<colinfo id="TEM" size="256" summ="default" type="STRING"/>
					<colinfo id="RDT" size="256" summ="default" type="STRING"/>
					<colinfo id="SEQ" size="256" summ="default" type="STRING"/>
					<colinfo id="SIR" size="256" summ="default" type="STRING"/>
					<colinfo id="BSU" size="256" summ="default" type="STRING"/>
					<colinfo id="TEMP_YN" size="256" summ="default" type="STRING"/>
					<colinfo id="BSU_GB" size="256" summ="default" type="STRING"/>
					<colinfo id="SJ_HOUR" size="256" summ="default" type="STRING"/>
					<colinfo id="SJ_RAT" size="256" summ="default" type="STRING"/>
					<colinfo id="SJ_AMT" size="256" summ="default" type="STRING"/>
					<colinfo id="BDGBN" size="256" summ="default" type="STRING"/>
				</Contents>
			</Dataset>
			<Dataset DataSetType="Dataset" Id="ds_temp_cd">
				<Contents>
					<colinfo id="CODE" size="256" summ="default" type="STRING"/>
					<colinfo id="CODE_NAME" size="256" summ="default" type="STRING"/>
					<record>
						<CODE></CODE>
						<CODE_NAME>-&#32;선택&#32;-</CODE_NAME>
					</record>
					<record>
						<CODE>N</CODE>
						<CODE_NAME>N</CODE_NAME>
					</record>
					<record>
						<CODE>Y</CODE>
						<CODE_NAME>Y</CODE_NAME>
					</record>
				</Contents>
			</Dataset>
			<Dataset DataSetType="Dataset" Id="ds_list4_d">
				<Contents>
					<colinfo id="FLAG" size="256" summ="default" type="STRING"/>
					<colinfo id="TEM" size="256" summ="default" type="STRING"/>
					<colinfo id="RDT" size="256" summ="default" type="STRING"/>
					<colinfo id="SEQ" size="256" summ="default" type="STRING"/>
					<colinfo id="SIR" size="256" summ="default" type="STRING"/>
					<colinfo id="BSU" size="256" summ="default" type="STRING"/>
					<colinfo id="TEMP_YN" size="256" summ="default" type="STRING"/>
					<colinfo id="BSU_GB" size="256" summ="default" type="STRING"/>
					<colinfo id="SJ_HOUR" size="256" summ="default" type="STRING"/>
					<colinfo id="SJ_RAT" size="256" summ="default" type="STRING"/>
					<colinfo id="SJ_AMT" size="256" summ="default" type="STRING"/>
					<colinfo id="CS313_ISR" size="256" summ="default" type="STRING"/>
					<colinfo id="BDGBN" size="256" summ="default" type="STRING"/>
				</Contents>
			</Dataset>
			<Dataset DataSetType="Dataset" Id="ds_cond3">
				<Contents>
					<colinfo id="TEM" size="256" summ="default" type="STRING"/>
					<colinfo id="RDT" size="256" summ="default" type="STRING"/>
					<colinfo id="SEQ" size="256" summ="default" type="STRING"/>
					<colinfo id="SIR" size="256" summ="default" type="STRING"/>
					<colinfo id="DOC" size="256" summ="default" type="STRING"/>
					<colinfo id="AMG" size="256" summ="default" type="STRING"/>
					<record>
						<AMG></AMG>
						<DOC></DOC>
						<RDT></RDT>
						<SEQ></SEQ>
						<SIR></SIR>
						<TEM></TEM>
					</record>
				</Contents>
			</Dataset>
			<Dataset DataSetType="Dataset" Id="ds_bsu_cd">
				<Contents>
					<colinfo id="CODE" size="256" summ="default" type="STRING"/>
					<colinfo id="CODE_NAME" size="256" summ="default" type="STRING"/>
					<colinfo id="BSU_GB" size="256" summ="default" type="STRING"/>
					<colinfo id="USED" size="256" summ="default" type="STRING"/>
					<colinfo id="VKGRP" size="256" summ="default" type="STRING"/>
					<colinfo id="VKBUR" size="256" summ="default" type="STRING"/>
				</Contents>
			</Dataset>
			<Dataset DataSetType="Dataset" Id="ds_bsu_gb">
				<Contents>
					<colinfo id="CODE" size="256" summ="default" type="STRING"/>
					<colinfo id="CODE_NAME" size="256" summ="default" type="STRING"/>
					<record>
						<CODE>1</CODE>
						<CODE_NAME>직영</CODE_NAME>
					</record>
					<record>
						<CODE>3</CODE>
						<CODE_NAME>협력</CODE_NAME>
					</record>
				</Contents>
			</Dataset>
			<Dataset DataSetType="Dataset" Id="ds_list4_h">
				<Contents>
					<colinfo id="FLAG" size="256" summ="default" type="STRING"/>
					<colinfo id="TEM" size="256" summ="default" type="STRING"/>
					<colinfo id="RDT" size="256" summ="default" type="STRING"/>
					<colinfo id="SEQ" size="256" summ="default" type="STRING"/>
					<colinfo id="SIR" size="256" summ="default" type="STRING"/>
					<colinfo id="PNT" size="256" summ="default" type="STRING"/>
					<colinfo id="SAJ" size="256" summ="default" type="STRING"/>
					<colinfo id="GIS" size="256" summ="default" type="STRING"/>
				</Contents>
			</Dataset>
		</Datasets>
		<Div Height="36" Id="div_btn" TabOrder="1" Text="Div0" ToolTipFont="Default,0" Url="WB01::CommBtnForm.xml" Width="517">
			<Contents></Contents>
		</Div>
		<Grid AreaSelect="TRUE" AutoEnter="TRUE" AutoFitEndLine="Hide" BindDataset="ds_list3" BkColor2="default" BoldHead="true" Border="Flat" Bottom="272" CellMoving="TRUE" ColSelect="TRUE" ColSizing="TRUE" Editable="TRUE" Enable="true" EndLineColor="default" HeadBorder="Flat" HeadHeight="20" Height="226" Id="grd_list" InputPanel="FALSE" Left="5" LineColor="user20" LineType="ExHORZ" OnCellClick="grd_list_OnCellClick" OnCellPosChanged="grd_list_OnCellPosChanged" Right="522" RowHeight="20" Style="sty_grid" TabOrder="2" TabStop="true" Top="46" UseDBuff="true" UsePopupMenu="true" UseSelColor="true" Visible="true" VLineColor="default" WheelScrollRow="1" Width="517">
			<contents>
				<format id="Default">
					<columns>
						<col width="30"/>
						<col width="150"/>
						<col width="35"/>
						<col width="70"/>
						<col width="60"/>
						<col width="30"/>
						<col width="60"/>
						<col width="80"/>
					</columns>
					<head>
						<cell align="center" col="0" display="text" font="굴림,9" rowspan="2" text="순번"/>
						<cell align="center" col="1" display="text" font="굴림,9" rowspan="2" text="보수업체"/>
						<cell align="center" col="2" display="text" font="굴림,9" rowspan="2" text="구분"/>
						<cell align="center" col="3" display="text" font="굴림,9" rowspan="2" text="계약직&#32;여부"/>
						<cell align="center" col="4" display="text" font="굴림,9" rowspan="2" text="상주시간"/>
						<cell align="center" col="5" display="text" font="굴림,9" rowspan="2" text="분담&#10;이행"/>
						<cell align="center" col="6" display="text" font="굴림,9" rowspan="2" text="기성율"/>
						<cell col="7" display="text" font="굴림,9" rowspan="2" text="상주금액"/>
					</head>
					<body>
						<cell align="center" bkcolor2="user22" bkimagealign="right" col="0" display="text" expandsize="18" expr="currow+1"/>
						<cell align="left" bkcolor2="user22" col="1" colid="BSU" combocol="CODE" combodataset="ds_bsu_cd" combotext="CODE_NAME" display="combo" edit="combo"/>
						<cell align="center" bkcolor2="user22" bkimagealign="right" col="2" colid="BSU_GB" combocol="CODE" combodataset="ds_bsu_gb" combotext="CODE_NAME" display="combo" expandsize="18"/>
						<cell align="center" bkcolor2="user22" col="3" colid="TEMP_YN" combocol="CODE" combodataset="ds_temp_cd" combotext="CODE_NAME" display="combo" edit="combo"/>
						<cell align="right" bkcolor2="user22" bkimagealign="left" bkimageid="icon_grid_edit" col="4" colid="SJ_HOUR" display="number" edit="number" LimitDec="2"/>
						<cell align="center" bkcolor2="user22" bkimagealign="right" col="5" colid="BDGBN" display="checkbox" edit="checkbox" expandsize="18"/>
						<cell align="right" bkcolor2="user22" col="6" colid="SJ_RAT" display="text" edit="number"/>
						<cell align="right" bkcolor2="user22" col="7" colid="SJ_AMT" display="number" edit="number" Mask="###,###"/>
					</body>
					<summary>
						<cell align="center" col="0" colspan="7" display="text" text="합계"/>
						<cell align="right" bkcolor="user25" col="7" display="number" expr='SUM(&quot;SJ_AMT&quot;)' Mask="###,###"/>
					</summary>
				</format>
			</contents>
		</Grid>
	</Form>
	<Script><![CDATA[﻿﻿﻿﻿﻿﻿﻿﻿/*
 ******************************************************************************************
 * 기      능   : 인원상주 견적 정보 입력 화면
 * 작  성  자   : 이하림
 * 작성  일자   : 201512
 * ----------------------------------------------------------------------------------------
 * HISTORY    :
 ******************************************************************************************
 */
#include "LIB::commons.js";	// 공통 스크립트 
#include "LIB::utility.js";	// 다중 선택 
//=========================================================================================
// [ PART 1 ]
// Form에서 사용될 전역변수를 선언
// FORM에서 사용되는 전역변수는 대문자로 작성하며, F_XXX 의 형태를 갖도록 한다. 
//=========================================================================================
var userGroup;
//=========================================================================================
// [ PART 2 ]
// Form Loading / Unloading 시 작업 정의
//=========================================================================================
function fn_OnLoadCompleted(obj) {
	gfn_initForm();
	fn_query();

}

/********************************************************************************
* 기      능   : 공통코드가 조회된 후의 Callback 함수 
********************************************************************************/
function fn_completeInit(sCode, sDsObj, sCodeType) {

}

/********************************************************************************
* 기      능   : form UnloadCompleted 
********************************************************************************/
function fn_OnUnloadCompleted(obj) {
	return gfn_isFormUnload(obj);
}

//=========================================================================================
// [ PART 3 ]
// Main Process Event 정의(조회,입력,삭제,저장,인쇄,form닫기)
//=========================================================================================

/********************************************************************************
* 기      능   : 조회 
********************************************************************************/
function fn_query() {


	ds_cond3.SetColumn(0, "TEM", ds_cond2.GetColumn(0, "TEM"));
	ds_cond3.SetColumn(0, "RDT", ds_cond2.GetColumn(0, "RDT"));
	ds_cond3.SetColumn(0, "SEQ", ds_cond2.GetColumn(0, "SEQ"));
	ds_cond3.SetColumn(0, "SIR", ds_cond2.GetColumn(0, "SIR"));

	tit_clearActionInfo();
	tit_addSearchActionInfo("cs12:CS1240001J_S1");
	tit_addSearchActionInfo("cs12:CS1240001J_S2");
	
	tit_callService(
        ""
        , ""
        , "ds_cond3=ds_cond3"
        , "ds_bsu_cd=ds_bsu_list ds_list3=ds_list3"
        , ""
        , "fn_afterQuery"
        , true);
}

/********************************************************************************
* 기      능   : 조회 Callback  
********************************************************************************/
function fn_afterQuery(errCode, errMsg) {
	gfn_showMsg("CI00002", ds_list3.RowCount()+"");
	
	// 버튼 활성화 설정
	// 견적 작성 상태인 경우만 인원상주 수정이 가능
	if(t_pst != "A1") {
		div_btn.btn_input.Enable   = false ;
		div_btn.btn_save.Enable    = false ;
		div_btn.btn_delete.Enable  = false ;
	} else {
		var vVkbur = gfn_getBsu(t_bsu, "VKBUR");
		if (vVkbur == "H100"){
			ds_bsu_cd.Filter("VKBUR=='H100'");
		} else {
			ds_bsu_cd.Filter("VKBUR!='H100'");
		}
	}
}

var pnt; // 상주인원수 합산
var saj; // 상주금액 합산
var gis; // 기성율 평균

/********************************************************************************
* 기      능   : 저장
********************************************************************************/
function fn_save() {
	if(t_pst > "A1") {
		gfn_showAlert("작성상태에서만 입력 가능합니다.");
		return false;
	}

	if(length(t_apstat) > 0) {
		gfn_showAlert("결재상신후 수정은 불가능합니다.");
		return false;
	}

	pnt = 0; // 상주인원수 합산
	saj = 0; // 상주금액 합산
	gis = 0; // 기성율 평균
	var j = 0;
	ds_list4_d.ClearData();
	for(var i=0; i<ds_list3.rowcount; i++) {
	
		var gb     = ds_list3.GetColumn(i, "BSU_GB");
		var temp   = ds_list3.GetColumn(i, "TEMP_YN");
			
		if(length(ds_list3.GetColumn(i, "BSU")) == 0) {
			gfn_showAlert(i + 1 + " 번째 행의 업체를 지정하세요.");
			return false;
		}
		if(gb == "1"){ // 직영	
			if(length(ds_list3.GetColumn(i, "TEMP_YN")) == 0) {
				gfn_showAlert(i + 1 + " 번째 행의 계약직 여부를 입력하세요.");
				return false;
			}
			if(temp == "N") {
				if(ds_list3.GetColumn(i, "SJ_HOUR") == 0) {
					gfn_showAlert(i + 1 + " 번째 행의 상주 시간을 입력하세요.");
					return false;
				}
			}
		} else { // 협력사
			if(ds_list3.GetColumn(i, "SJ_RAT") == 0) {
				gfn_showAlert(i + 1 + " 번째 행의 기성율을 입력하세요.");
				return false;
			}
		}
		if(ds_list3.GetColumn(i, "SJ_AMT") == 0) {
			gfn_showAlert(i + 1 + " 번째 행의 상주금액을 입력하세요.");
			return false;
		}
	
		ds_list4_d.AddRow();
		ds_list4_d.SetColumn(j, "TEM", ds_cond2.GetColumn(0, "TEM"));
		ds_list4_d.SetColumn(j, "RDT", ds_cond2.GetColumn(0, "RDT"));
		ds_list4_d.SetColumn(j, "SEQ", ds_cond2.GetColumn(0, "SEQ"));
		ds_list4_d.SetColumn(j, "SIR", ds_cond2.GetColumn(0, "SIR"));
		ds_list4_d.SetColumn(j, "BSU"     , ds_list3.GetColumn(i, "BSU"));
		ds_list4_d.SetColumn(j, "BSU_GB"  , ds_list3.GetColumn(i, "BSU_GB"));
		ds_list4_d.SetColumn(j, "TEMP_YN"  , ds_list3.GetColumn(i, "TEMP_YN"));
		ds_list4_d.SetColumn(j, "SJ_HOUR" , ds_list3.GetColumn(i, "SJ_HOUR"));
		ds_list4_d.SetColumn(j, "SJ_RAT"  , ds_list3.GetColumn(i, "SJ_RAT"));
		ds_list4_d.SetColumn(j, "SJ_AMT"  , ds_list3.GetColumn(i, "SJ_AMT"));
		ds_list4_d.SetColumn(j, "CS313_ISR"  ,"0"+(j+1));
		ds_list4_d.SetColumn(j, "BDGBN", ds_list3.GetColumn(i, "BDGBN"));
		j++;
	}
	pnt = ds_list4_d.RowCount();
	saj = ds_list4_d.Sum("SJ_AMT");
	gis = ds_list4_d.Avg("SJ_RAT");
	
	ds_list4_h.ClearData();
	ds_list4_h.AddRow();
	ds_list4_h.SetColumn(0, "TEM", ds_cond2.GetColumn(0, "TEM"));
	ds_list4_h.SetColumn(0, "RDT", ds_cond2.GetColumn(0, "RDT"));
	ds_list4_h.SetColumn(0, "SEQ", ds_cond2.GetColumn(0, "SEQ"));
	ds_list4_h.SetColumn(0, "SIR", ds_cond2.GetColumn(0, "SIR"));
	ds_list4_h.SetColumn(0, "PNT", pnt);
	ds_list4_h.SetColumn(0, "SAJ", saj);
	ds_list4_h.SetColumn(0, "GIS", gis);

	// trace(ds_list4_h.SaveXML());
	// trace(ds_list4_d.SaveXML());

	tit_clearActionInfo();
	// zcst313 인원상주 정보 삭제
	tit_addSingleActionInfo("cs12:CS1240001J_D1");
	// zcst301 인원상주 정보 업데이트
	tit_addSingleActionInfo("cs12:CS1240001J_U1");
	// zcst313 인원상주 정보 인서트
	if (ds_list4_d.RowCount() != 0) {
		tit_addMultiActionInfo("cs12:CS1240001J_I1");
	}
	tit_callService(
		""
		, ""
		, "ds_list4_h=ds_list4_h ds_list4_d=ds_list4_d "
		, ""
		, ""
		, "fn_afterSave"
		, true);
}

/********************************************************************************
* 기      능   : 삽입 
* 인원상주 정보 최대 5건 까지 입력하도록 기준
********************************************************************************/
function fn_input() {
	if(ds_list3.RowCount() >= 6) {
		gfn_showAlert("최대 6건의 정보를 입력할 수 있습니다.");
		return false;
	} else {
		ds_list3.AddRow();
		ds_list3.SetColumn(ds_list3.row, "FLAG", "I");
		ds_list3.SetColumn(ds_list3.row, "TEM", ds_cond2.GetColumn(0, "TEM"));
		ds_list3.SetColumn(ds_list3.row, "RDT", ds_cond2.GetColumn(0, "RDT"));
		ds_list3.SetColumn(ds_list3.row, "SEQ", ds_cond2.GetColumn(0, "SEQ"));
		ds_list3.SetColumn(ds_list3.row, "SIR", ds_cond2.GetColumn(0, "SIR"));
		ds_list3.SetColumn(ds_list3.row, "BSU", "");
		ds_list3.SetColumn(ds_list3.row, "BSU_GB", "");
		ds_list3.SetColumn(ds_list3.row, "TEMP_YN", "");
		ds_list3.SetColumn(ds_list3.row, "SJ_HOUR", 0);
		ds_list3.SetColumn(ds_list3.row, "BDGBN", "");
		ds_list3.SetColumn(ds_list3.row, "SJ_RAT", 0);
		ds_list3.SetColumn(ds_list3.row, "SJ_AMT", 0);
		ds_list3.SetColumn(ds_list3.row, "BSU", t_bsu);
	}
}

/********************************************************************************
* 기      능   : 삭제
********************************************************************************/
function fn_delete() {	
	var row = ds_list3.rowpos;
	ds_list3.DeleteRow(ds_list3.rowpos);
}

/********************************************************************************
* 기      능   : 저장 Callback  
********************************************************************************/
function fn_afterSave(errCode, errMsg) {
	if(errCode != 0) {
		gfn_showMsg("CE00001");
	} else {
		gfn_showMsg("CI00005");
		fn_setParent();
		fn_close();
	}
}

/********************************************************************************
* 기      능   : 삭제 Callback  
********************************************************************************/
function fn_afterDelete(errCode, errMsg) {
	if(errCode != 0) {
		gfn_showMsg("CE00001");
	} else {
		gfn_showMsg("CI00005");
	}
}

/********************************************************************************
* 기      능   : 닫기  
********************************************************************************/
function fn_close() {
	close();
}

//=========================================================================================
// [ PART 4]
// Callback 함수 정의 : callback 함수명은 메인 함수의 fn_xxxx() 에서 xxxx 부분은 fn_afterXXXX()
// 형태가 되도록 작성 
//=========================================================================================
function ds_list3_CanColumnChange(obj,nRow,strColumnID,varOldValue,varNewValue,nPivotIndex)
{
	if (strColumnID == "BDGBN"){
		if (obj.GetColumn(nRow, "BSU_GB") != "3"){
			return false;
		}
	} else if (strColumnID == "BSU"){
		var idx    = ds_bsu_cd.FindRow("CODE", varNewValue );
		if (ds_bsu_cd.GetColumn(idx, "USED") == "N"){
			alert("중지된 보수업체 입니다.");
			return false;
		}
	}
}

function ds_list3_OnColumnChanged(obj,nRow,strColumnID,varOldValue,varNewValue,nPivotIndex) {
	var bsu    = ds_list3.GetColumn(nRow, "BSU");
	var temp   = ds_list3.GetColumn(nRow, "TEMP_YN");
	var idx    = ds_bsu_cd.FindRow("CODE", bsu );
	var gb     = ds_bsu_cd.GetColumn(idx, "BSU_GB");
	var used   = ds_bsu_cd.GetColumn(idx, "USED");
	
	if (strColumnID == "BSU") { 

		ds_list3.SetColumn(nRow, "BSU_GB" , gb );
		fn_setDetail(nRow);		
	} else if (strColumnID == "TEMP_YN") {
		fn_setDetail(nRow);		
	}
	
}

function fn_setDetail(nRow){

	var gb2  = ds_list3.GetColumn(nRow, "BSU_GB");
	var temp = ds_list3.GetColumn(nRow, "TEMP_YN");
	 // 직영의 경우 계약직 여부 체크, 분담이행은 CHECK할 수 없다
	if(gb2 == "1") {
		if(temp == "Y") {
			ds_list3.SetColumn(nRow, "SJ_HOUR" , 0);					
		}
		ds_list3.SetColumn(nRow, "SJ_RAT" , 0);	
		ds_list3.FireEvent = false;
		ds_list3.SetColumn(nRow, "BDGBN"  ,"");
		ds_list3.FireEvent = true;

	 // 협력의 경우 계약직 여부 초기 N 설정, 및 분담이행은 '1'로 설정
	} else if (gb2 == "3") {
		ds_list3.SetColumn(nRow, "TEMP_YN" , "N");	
		ds_list3.SetColumn(nRow, "SJ_HOUR" , 0);	
		ds_list3.SetColumn(nRow, "BDGBN"   ,"1");
	}

}

function fn_setParent() {
	parent.ds_head.SetColumn(0, "PNT", pnt);
	parent.ds_head.SetColumn(0, "SAJ", saj);
	parent.ds_head.SetColumn(0, "GIS", gis);
	
}

function grd_list_OnCellClick(obj,nRow,nCell,nX,nY,nPivotIndex)
{
	var vColId = obj.GetCellProp("BODY",nCell,"colid");
	// 업체 입력 후 계약직 여부 선택
	if (vColId == "TEMP_YN"){		//if(nCell == 3) { // "TEMP_YN"
		var bsu    = ds_list3.GetColumn(nRow, "BSU");
		var temp   = ds_list3.GetColumn(nRow, "TEMP_YN");
		if(bsu == ""){
			alert("업체를 먼저 지정하세요.");
			ds_list3.SetColumn(nRow, "TEMP_YN", "");	
			grd_list.SetCellPos(1);
		} 	
	}	 	
}

function grd_list_OnCellPosChanged(obj,nRow,nCell,nOldRow,nOldCell,nPivotIndex,nOldPivotIndex)
{	
	var bsu    = ds_list3.GetColumn(nRow, "BSU");
	var temp   = ds_list3.GetColumn(nRow, "TEMP_YN");
	var idx    = ds_bsu_cd.FindRow("CODE", bsu );
	var gb     = ds_bsu_cd.GetColumn(idx, "BSU_GB");
	
	if(temp == "Y"){
		ds_list3.SetColumn(nRow, "SJ_HOUR" , 0);
		ds_list3.SetColumn(nRow, "SJ_RAT"  , 0);	
	}	
	if(gb == "3"){
		ds_list3.SetColumn(nRow, "SJ_HOUR" , 0);
	}	
}
]]></Script>
</Window>