<?xml version="1.0" encoding="utf-8"?>
<Window>
	<Form Height="560" Id="PS0207001F" Left="8" OnLoadCompleted="fn_OnLoadCompleted" OnUnloadCompleted="fn_OnUnloadCompleted" PidAttrib="7" Title="작업일보&#32;COPY&#32;TOOL" Top="8" Ver="1.0" Width="592" WorkArea="true">
		<Datasets>
			<Dataset DataSetType="Dataset" Id="ds_cond" LastLoadDataOnly="1">
				<Contents>
					<colinfo id="INP_DT" size="256" summ="default" type="STRING"/>
					<colinfo id="LIFNR" size="256" summ="default" type="STRING"/>
					<colinfo id="TMCD" size="256" summ="default" type="STRING"/>
					<colinfo id="INP_DT2" size="256" summ="default" type="STRING"/>
				</Contents>
			</Dataset>
			<Dataset DataSetType="Dataset" Id="ds_list" OnColumnChanged="ds_list_OnColumnChanged">
				<Contents>
					<colinfo id="GUBUN" size="256" summ="default" type="STRING"/>
					<colinfo id="INPUT" size="256" summ="default" type="STRING"/>
					<colinfo id="POSIT" size="256" summ="default" type="STRING"/>
					<colinfo id="NAMEE" size="256" summ="default" type="STRING"/>
					<colinfo id="CHK" size="256" summ="default" type="STRING"/>
					<colinfo id="CDATE" size="256" summ="default" type="STRING"/>
					<colinfo id="PDATE" size="256" summ="default" type="STRING"/>
					<colinfo id="LIFNR" size="256" summ="default" type="STRING"/>
					<colinfo id="PERNO" size="256" summ="default" type="STRING"/>
					<colinfo id="TMCD" size="256" summ="default" type="STRING"/>
					<colinfo id="TUIP_CHKA" size="256" summ="default" type="STRING"/>
					<colinfo id="TUIP_CHKB" size="256" summ="default" type="STRING"/>
				</Contents>
			</Dataset>
			<Dataset DataSetType="Dataset" Id="ds_input">
				<Contents>
					<colinfo id="CODE" size="256" summ="default" type="STRING"/>
					<colinfo id="CODE_NM" size="256" summ="default" type="STRING"/>
					<record>
						<CODE>Y</CODE>
						<CODE_NM>입력</CODE_NM>
					</record>
					<record>
						<CODE>N</CODE>
						<CODE_NM>미입력</CODE_NM>
					</record>
				</Contents>
			</Dataset>
			<Dataset DataSetType="Dataset" Id="ds_head">
				<Contents>
					<colinfo id="GUBUN" size="256" summ="default" type="STRING"/>
					<colinfo id="INPUT" size="256" summ="default" type="STRING"/>
					<colinfo id="POSIT" size="256" summ="default" type="STRING"/>
					<colinfo id="NAMEE" size="256" summ="default" type="STRING"/>
					<colinfo id="CHK" size="256" summ="default" type="STRING"/>
					<colinfo id="CDATE" size="256" summ="default" type="STRING"/>
					<colinfo id="PDATE" size="256" summ="default" type="STRING"/>
				</Contents>
			</Dataset>
			<Dataset DataSetType="Dataset" Id="ds_list2">
				<Contents>
					<colinfo id="GUBUN" size="256" summ="default" type="STRING"/>
					<colinfo id="INPUT" size="256" summ="default" type="STRING"/>
					<colinfo id="POSIT" size="256" summ="default" type="STRING"/>
					<colinfo id="NAMEE" size="256" summ="default" type="STRING"/>
					<colinfo id="CHK" size="256" summ="default" type="STRING"/>
					<colinfo id="CDATE" size="256" summ="default" type="STRING"/>
					<colinfo id="PDATE" size="256" summ="default" type="STRING"/>
					<colinfo id="TUIP_CHKA" size="256" summ="default" type="STRING"/>
					<colinfo id="TUIP_CHKB" size="256" summ="default" type="STRING"/>
				</Contents>
			</Dataset>
			<Dataset DataSetType="Dataset" Id="ds_pro">
				<Contents>
					<colinfo id="GUBUN" size="256" summ="default" type="STRING"/>
					<colinfo id="INPUT" size="256" summ="default" type="STRING"/>
					<colinfo id="POSIT" size="256" summ="default" type="STRING"/>
					<colinfo id="NAMEE" size="256" summ="default" type="STRING"/>
					<colinfo id="CHK" size="256" summ="default" type="STRING"/>
					<colinfo id="CDATE" size="256" summ="default" type="STRING"/>
					<colinfo id="PDATE" size="256" summ="default" type="STRING"/>
				</Contents>
			</Dataset>
			<Dataset DataSetType="Dataset" Id="ds_cond2">
				<Contents>
					<colinfo id="INP_DT" size="256" summ="default" type="STRING"/>
					<colinfo id="LIFNR" size="256" summ="default" type="STRING"/>
					<colinfo id="PERNO" size="256" summ="default" type="STRING"/>
					<colinfo id="INP_DT2" size="256" summ="default" type="STRING"/>
				</Contents>
			</Dataset>
			<Dataset DataSetType="Dataset" Id="ds_chk">
				<Contents>
					<colinfo id="CNT" size="256" summ="default" type="STRING"/>
					<colinfo id="TUIP_CHKA" size="256" summ="default" type="STRING"/>
					<colinfo id="TUIP_CHKB" size="256" summ="default" type="STRING"/>
					<colinfo id="CNT2" size="256" summ="default" type="STRING"/>
				</Contents>
			</Dataset>
			<Dataset DataSetType="Dataset" Id="ds_list3">
				<Contents>
					<colinfo id="GUBUN" size="256" summ="default" type="STRING"/>
					<colinfo id="INPUT" size="256" summ="default" type="STRING"/>
					<colinfo id="POSIT" size="256" summ="default" type="STRING"/>
					<colinfo id="NAMEE" size="256" summ="default" type="STRING"/>
					<colinfo id="CHK" size="256" summ="default" type="STRING"/>
					<colinfo id="CDATE" size="256" summ="default" type="STRING"/>
					<colinfo id="PDATE" size="256" summ="default" type="STRING"/>
					<colinfo id="TUIP_CHKA" size="256" summ="default" type="STRING"/>
					<colinfo id="TUIP_CHKB" size="256" summ="default" type="STRING"/>
				</Contents>
			</Dataset>
			<Dataset DataSetType="Dataset" Id="ds_pspid">
				<Contents>
					<colinfo id="PSPID" size="256" summ="default" type="STRING"/>
					<colinfo id="POSID" size="256" summ="default" type="STRING"/>
					<colinfo id="INP_DT" size="256" summ="default" type="STRING"/>
					<colinfo id="INP_DT2" size="256" summ="default" type="STRING"/>
				</Contents>
			</Dataset>
			<Dataset DataSetType="Dataset" Id="ds_pspid2">
				<Contents>
					<colinfo id="PSPID" size="256" summ="default" type="STRING"/>
					<colinfo id="POSID" size="256" summ="default" type="STRING"/>
					<colinfo id="INP_DT" size="256" summ="default" type="STRING"/>
					<colinfo id="INP_DT2" size="256" summ="default" type="STRING"/>
				</Contents>
			</Dataset>
		</Datasets>
		<Div Height="36" Id="div_btn" TabOrder="2" Text="Div0" Url="WB01::CommBtnForm.xml" Width="592">
			<Contents></Contents>
		</Div>
		<Grid AutoFitEndLine="Hide" BindDataset="ds_list" BkColor2="default" BoldHead="true" Border="Flat" Bottom="496" CellMoving="TRUE" ColSelect="TRUE" ColSizing="TRUE" Editable="TRUE" Enable="true" EndLineColor="default" HeadBorder="Flat" HeadHeight="20" Height="384" Id="grd_list" InputPanel="FALSE" Left="40" LineColor="user20" LineType="ExHORZ" OnExpandEdit="grd_list_OnExpandEdit" Right="544" RowHeight="20" Style="sty_grid" TabOrder="1" TabStop="true" Top="112" UseDBuff="true" UsePopupMenu="true" UseSelColor="true" Visible="true" VLineColor="default" WheelScrollRow="1" Width="504">
			<contents>
				<format id="Default">
					<columns>
						<col width="36"/>
						<col width="35"/>
						<col width="60"/>
						<col width="60"/>
						<col width="60"/>
						<col width="40"/>
						<col width="100"/>
						<col width="100"/>
					</columns>
					<head>
						<cell col="0" display="text" font="굴림,9" text="No"/>
						<cell col="1" display="text" font="굴림,9" text="복사"/>
						<cell col="2" display="text" font="굴림,9" text="등록구분"/>
						<cell col="3" display="text" font="굴림,9" text="입력구분"/>
						<cell col="4" display="text" font="굴림,9" text="이름"/>
						<cell col="5" display="text" font="굴림,9" text="직위"/>
						<cell col="6" display="text" font="굴림,9" text="Copy일자&#32;"/>
						<cell col="7" display="text" font="굴림,9" text="Paste&#32;일자"/>
					</head>
					<body>
						<cell align="center" col="0" display="text" expr="currow+1"/>
						<cell align="center" col="1" colid="CHK" display="checkbox" edit='expr:iif(INPUT=&apos;N&apos;&#32;,&quot;checkbox&quot;&#32;,&quot;none&quot;)'/>
						<cell align="center" col="2" colid="INPUT" combocol="CODE" combodataset="ds_input" combotext="CODE_NM" display="combo"/>
						<cell align="center" col="3" colid="GUBUN" display="text"/>
						<cell align="center" col="4" colid="NAMEE" display="text"/>
						<cell align="center" col="5" colid="POSIT" display="text"/>
						<cell align="center" col="6" colid="CDATE" display="text" edit="normal" expandimage="btn_grid_icon_pen" expandshow="true" expandsize="20" limit="8" Mask="####.##.##"/>
						<cell align="center" col="7" colid="PDATE" display="text" edit="normal" expandimage="btn_grid_icon_pen" expandshow="true" expandsize="20" limit="8" Mask="####.##.##"/>
					</body>
				</format>
			</contents>
		</Grid>
		<Static Color="user8" Font="굴림,9,Bold" Height="32" Id="Static8" Left="64" TabOrder="3" Text="▶&#32;&#32;전일과&#32;동일한&#32;현장의&#32;경우&#32;전일&#32;Copy일자&#32;선택&#32;후&#32;금일" Top="48" VAlign="Middle" Width="504"></Static>
		<Static Color="user8" Font="굴림,9,Bold" Height="32" Id="Static0" Left="88" TabOrder="4" Text="Paste&#32;일자&#32;선택하여&#32;복사하시고,&#32;입력분에&#32;금일&#32;공정&#32;수정함" Top="72" VAlign="Middle" Width="504"></Static>
		<Calendar Border="Flat" ClickedBkColor="user32" ClickedTextColor="user33" Dateformat="yyyy.MM.dd" DayFont="돋움,9" DaySelect="Auto" DaySpacingHeight="6" DrawWeekSeparator="FALSE" EditAlign="CENTER" Font="돋움,9" HeaderBorder="NONE" HeaderFont="돋움,10,Bold" Height="146" Id="cal_temp" Left="848" MonthOnly="TRUE" MonthPickerFormat="yyyy년&#32;MMMM" MonthPopupBorder="FLAT" OnDayClick="cal_temp_OnDayClick" OnKillFocus="cal_temp_OnKillFocus" SaturdayTextColor="user34" SelectedDayFont="돋움,9,Bold" Style="sty_ipt_form" SundayTextColor="user35" TabOrder="5" TextColor="user36" TitleBKColor="user37" TitleTextColor="user38" TodayColor="user39" Top="48" Value="20080401" Visible="FALSE" WeekBKColor="user40" WeekColor="user41" WeeksFont="돋움,10" Width="152"></Calendar>
	</Form>
	<Script><![CDATA[﻿﻿﻿﻿﻿﻿/*
 ******************************************************************************************
 * 기      능   : 
 * 작  성  자   : 
 * 작성  일자   : 
 * ----------------------------------------------------------------------------------------
 * HISTORY    :
 ******************************************************************************************
 */
#include "LIB::commons.js";	// 공통 스크립트 
//=========================================================================================
// [ PART 1 ]
// Form에서 사용될 전역변수를 선언
// FORM에서 사용되는 전역변수는 대문자로 작성하며, F_XXX 의 형태를 갖도록 한다. 
//=========================================================================================
var F_LIFNR;
var F_INP;
var F_CHK;
var F_TMCD;
//=========================================================================================
// [ PART 2 ]
// Form Loading / Unloading 시 작업 정의
//=========================================================================================
function fn_OnLoadCompleted(obj) {
	// Form 로드 이벤트 맨 첫줄에 기술 
	gfn_initForm();	
	
	fn_query();
}

/********************************************************************************
* 기      능   : 조회 (header 조회)
********************************************************************************/
function fn_query() {
 ds_chk.ClearData();
//alert(F_LIFNR);
//alert(F_INP);
	
   var arr  = F_INP; // 일보입력일
   var arr2 =  gfn_getBeforeDate(arr, 1); // 일보입력일 하루 전날로 셋팅(COPY 일자)
   
	ds_cond.ClearData();
    ds_cond.addRow();
	ds_cond.SetColumn(0,"LIFNR" ,F_LIFNR );
	ds_cond.SetColumn(0, "INP_DT2", arr2);
	ds_cond.SetColumn(0,"INP_DT" ,F_INP );
	ds_cond.SetColumn(0,"TMCD" ,F_TMCD );
	
   
   

	tit_clearActionInfo();
    tit_addSearchActionInfo("ps02:PS0207001F_S1");
	tit_callService(
		""
		, ""
		, "ds_cond=ds_cond"
		, "ds_list=ds_list"
		, ""
		, "fn_afterQuery"
		, true);
 
}
/********************************************************************************
* 기      능   : 조회 Callback  
********************************************************************************/
function fn_afterQuery(errCode, errMsg) {
  gfn_showMsg("CI00002",ds_list_p.RowCount()+"");
}
/********************************************************************************
* 기      능   : 공통코드가 조회된 후의 Callback 함수 
********************************************************************************/
function fn_completeInit(sCode, sDsObj, sCodeType) {
}
/********************************************************************************
* 기      능   : form UnloadCompleted 
********************************************************************************/
function fn_OnUnloadCompleted(obj) {
	return gfn_isFormUnload(obj);
}
//=========================================================================================
// [ PART 3 ]
// Main Process Event 정의(조회,입력,삭제,저장,인쇄,form닫기)
//=========================================================================================

/********************************************************************************
* 기      능   : 닫기  
********************************************************************************/
function fn_close() {
   parent.fn_query();
   close();
}
/********************************************************************************
* 기      능   : 그리드 헤더 클릭시 정렬 처리 
********************************************************************************/
function grd_list_OnHeadClick(obj,nCell,nX,nY,nPivotIndex)
{
	if ( nCell == 0 ) {
		// 현재 처리할 format 기억
		gfn_selectGridCol("grd_list");
	} else {
		gfn_sortGrid(obj,nCell);
	}
}

/********************************************************************************
* 기      능   : cofy
********************************************************************************/
function fn_copy() {
 ds_chk.ClearData();
// 대상 로우 체크
  if(ds_list.FindRow("CHK", 1)==-1){
		gfn_showMsg('CW00046');
		return;
	}
	

	ds_list.Filter("CHK=='1'");
	ds_list2.copyF(ds_list);
	ds_list.unFilter();

	ds_list3.Filter("CHK=='1' && TUIP_CHKA=='X'");
	ds_list3.copyF(ds_list2);
	ds_list2.unFilter();
	//공정현장 구하기(sum)

    for(var i=0;i<ds_list3.GetRowCount();i++){
	
	   if(ds_cond2.GetRowCount()==0)	ds_cond2.AddRow();
        ds_cond2.SetColumn(0,"LIFNR"  , ds_list3.GetColumn(i, "LIFNR"));
	    ds_cond2.SetColumn(0,"INP_DT" , ds_list3.GetColumn(i, "CDATE"));
	    ds_cond2.SetColumn(0,"PERNO"  , ds_list3.GetColumn(i, "PERNO"));
   	    ds_cond2.SetColumn(0,"INP_DT2" , ds_list3.GetColumn(i, "PDATE"));
   
	    tit_clearActionInfo();
        tit_addSearchActionInfo("ps02:PS0207001F_S3");
	    tit_callService(
	      ""
	    , ""
		, "ds_cond2=ds_cond2"
		, "ds_pspid=ds_pspid"
	    , ""
	    , ""//"fn_afterCheck"
		, ""
        , ""
		, true);	
		
		
		for(var j=0; j<= ds_pspid2.rowcount; j++){
          for (var i=0; i<= ds_pspid.rowcount; i++) {
            if((ds_pspid.GetColumn(i, "POSID") == ds_pspid2.GetColumn(j, "POSID")) && (ds_pspid.GetColumn(i, "INP_DT2") == ds_pspid2.GetColumn(j, "INP_DT2")) ) {
              ds_pspid.DeleteRow(i);
             } 
          }
        }
		
		  ds_pspid2.AppendDataset(ds_pspid);
		
	}	 
	 

     //zpstw0301 인원
	if(ds_list2.RowCount() > 0) {
	
	tit_clearActionInfo();		
    tit_addMultiActionInfo("ps02:PS0207001F_I1");
    tit_callService(
	 ""
   , ""
   , "ds_list2=ds_list2"
   , ""
   , ""
   , ""// "fn_afterSave"
   , true);	
  
    }
    //zpstw0302 현장
    if(ds_list3.RowCount() > 0) {
	
		
    tit_clearActionInfo();	
    tit_addMultiActionInfo("ps02:PS0207001F_I2");
    tit_callService(
	 ""
   , ""
   , "ds_list3=ds_list3"
   , ""
   , ""
   , ""// "fn_afterSave"
   , true);	
   
   }
   
   //ZPSTW0304 공정
   
   if(ds_pspid2.RowCount() > 0)
   {
     	
    tit_clearActionInfo();	
    tit_addMultiActionInfo("ps02:PS0207001F_D1");
    tit_addMultiActionInfo("ps02:PS0207001F_I3");
    tit_callService(
	 ""
   , ""
   , "ds_pspid2=ds_pspid2"
   , ""
   , ""
   , ""// "fn_afterSave"
   , true);	
   
   }

    gfn_showAlert("저장되었습니다.");
    //fn_close();
 
}

/********************************************************************************
* 기      능   : 달력에서 일자 선택했을 경우 
********************************************************************************/
function cal_temp_OnDayClick(obj,strText)
{
	if(grd_list.GetClickedCell() == 6)
	{
		ds_list.SetColumn(ds_list.row, "CDATE", strText);
	} else if(grd_list.GetClickedCell() == 7){
	    ds_list.SetColumn(ds_list.row, "PDATE", strText);
	}
	
	obj.Visible = false;
}
/********************************************************************************
* 기      능   : 달력에서 포커스 잃었을 경우 
********************************************************************************/
function cal_temp_OnKillFocus(obj)
{
	obj.Visible = false;
}
// 달력 처리 부분 
/********************************************************************************
* 기      능   : 그리드에서 날짜 입력시 
********************************************************************************/
function grd_list_OnExpandEdit(obj,nRow,nCell,strVal,nPivotIndex)
{
		
		var rect = obj.GetCellRect(nRow, ncell);
		cal_temp.top = rect[1] + 100;
		if (cal_temp.top > 400)
		{
			cal_temp.top = 400;
		}
		cal_temp.Left = rect[0] + 20;
		if (cal_temp.Left > 790)
		{
			cal_temp.Left = 790;
		}	 
		cal_temp.Visible = true;
	
		if(nCell == 6)
		{
			cal_temp.value = ds_list.getColumn(nRow, "CDATE");
		} else if(nCell == 7){
		    cal_temp.value = ds_list.getColumn(nRow, "PDATE");
		}
		
		cal_temp.SetFocus();
		
}
/********************************************************************************
* 기      능   : 이벤트처리
********************************************************************************/
function ds_list_OnColumnChanged(obj,nRow,strColumnID,varOldValue,varNewValue,nPivotIndex)
{
	
   ds_chk.ClearData();

  if(strColumnID=="CDATE" || strColumnID=="PDATE" ){
  	
  	if(ds_list.GetColumn(nRow, "PDATE") <= ds_list.GetColumn(nRow, "CDATE"))
    {     ds_list.SetColumn(nRow,"CHK"  , '0');
          gfn_showAlert("CW00022","Paste일자가 Copy일자보다 이전이거나 같습니다. 일자");
	      return false;
    }
    
    if(ds_cond2.GetRowCount()==0)	ds_cond2.AddRow();
        ds_cond2.SetColumn(0,"LIFNR"  , ds_list.GetColumn(nRow, "LIFNR"));
	    ds_cond2.SetColumn(0,"INP_DT" , ds_list.GetColumn(nRow, "CDATE"));
	    ds_cond2.SetColumn(0,"INP_DT2" , ds_list.GetColumn(nRow, "PDATE"));
	    ds_cond2.SetColumn(0,"PERNO"  , ds_list.GetColumn(nRow, "PERNO"));
	
   
	    tit_clearActionInfo();
        tit_addSearchActionInfo("ps02:PS0207001F_S2");
	    tit_callService(
	      ""
	    , ""
		, "ds_cond2=ds_cond2"
		, "ds_chk=ds_chk"
	    , ""
	    , ""//"fn_afterCheck"
		, ""
        , ""
		, true);	
			                                                                          
		//	   iif(INPUT='N' ,"checkbox" ,"none")
	
    if(ds_chk.GetColumn(0,"CNT") == 0 or ds_chk.GetRowCount() == 0)
	{   ds_list.SetColumn(nRow,"CHK"  , '0');
	    gfn_showAlert("CW00022","Copy할 작업일보 내역이 없습니다. Copy일자");
	    return false;
	}
    if(ds_chk.GetColumn(0,"CNT2") == 1)
	{    ds_list.SetColumn(nRow,"CHK"  , '0');
	     ds_list.SetColumn(nRow,"INPUT" , 'Y');
	     gfn_showAlert("CW00022","Paste일자에 작업일보 내역이 존재합니다. Paste일자");
	     return false;
	}

    
		ds_list.SetColumn(nRow,"INPUT" , 'N');
		ds_list.SetColumn(nRow,"CHK"  , '1');
		ds_list.SetColumn(nRow,"TUIP_CHKA"  , ds_chk.GetColumn(0, "TUIP_CHKA"));
		ds_list.SetColumn(nRow,"TUIP_CHKB"  , ds_chk.GetColumn(0, "TUIP_CHKB"));
  
   }
   
 //  trace(ds_list.SaveXML());
   
}
]]></Script>
</Window>