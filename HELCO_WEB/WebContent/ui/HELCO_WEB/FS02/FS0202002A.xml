<?xml version="1.0" encoding="utf-8"?>
<Window>
	<Form Height="562" Id="FS0202002A" Left="8" OnLoadCompleted="fn_OnLoadCompleted" OnUnloadCompleted="fn_OnUnloadCompleted" PidAttrib="7" Title="견적원가&#32;네고가격&#32;변경" Top="8" Ver="1.0" Width="978" WorkArea="true">
		<Datasets>
			<Dataset DataSetType="Dataset" Id="ds_error">
				<Contents>
					<colinfo id="IDX" size="256" type="STRING"/>
					<colinfo id="ERRMSG" size="256" type="STRING"/>
				</Contents>
			</Dataset>
			<Dataset DataSetType="Dataset" Id="ds_cond">
				<Contents>
					<colinfo id="MANDT" size="3" summ="default" type="STRING"/>
					<colinfo id="ESCS_NUMB" size="20" summ="default" type="STRING"/>
					<colinfo id="ESCS_NTIM" size="5" summ="default" type="INT"/>
					<record>
						<ESCS_NTIM/>
						<ESCS_NUMB></ESCS_NUMB>
						<MANDT></MANDT>
					</record>
				</Contents>
			</Dataset>
			<Dataset DataSetType="Dataset" Editable="True" Id="ds_zfst0201_list">
				<Contents>
					<colinfo id="LIST_INDEX" size="100" summ="default" type="STRING"/>
					<colinfo id="CHK" size="100" summ="default" type="STRING"/>
					<colinfo id="FLAG" size="100" summ="default" type="STRING"/>
					<colinfo id="LEVEL" size="100" summ="default" type="STRING"/>
					<colinfo id="MANDT" size="3" summ="default" type="STRING"/>
					<colinfo id="ESCS_NUMB" size="20" summ="default" type="STRING"/>
					<colinfo id="ESCS_NTIM" size="5" summ="default" type="INT"/>
					<colinfo id="ESCS_ITSQ" size="5" summ="default" type="INT"/>
					<colinfo id="ITEM_DIYN" size="1" summ="default" type="STRING"/>
					<colinfo id="ESCS_GROP" size="10" summ="default" type="STRING"/>
					<colinfo id="ESCS_UPGR" size="10" summ="default" type="STRING"/>
					<colinfo id="ESCS_ITEM" size="9" summ="default" type="STRING"/>
					<colinfo id="EXTN_ESCS" size="21" summ="default" type="STRING"/>
					<colinfo id="ESCE_NAME" size="100" summ="default" type="STRING"/>
					<colinfo id="MTRL_DIVS" size="10" summ="default" type="STRING"/>
					<colinfo id="MTRL_NUMB" size="20" summ="default" type="STRING"/>
					<colinfo id="PART_NAME" size="100" summ="default" type="STRING"/>
					<colinfo id="STAD" size="100" summ="default" type="STRING"/>
					<colinfo id="UNIT" size="3" summ="default" type="STRING"/>
					<colinfo id="QNTY" size="5" summ="default" type="INT"/>
					<colinfo id="COST" size="15" summ="default" type="DECIMAL"/>
					<colinfo id="WAERK" size="5" summ="default" type="STRING"/>
					<colinfo id="UKURS" size="9" summ="default" type="DECIMAL"/>
					<colinfo id="ICDT_EPNS" size="6" summ="default" type="DECIMAL"/>
					<colinfo id="IDRT_COST" size="6" summ="default" type="DECIMAL"/>
					<colinfo id="SALE_COST" size="15" summ="default" type="DECIMAL"/>
					<colinfo id="MRGN_RATE" size="9" summ="default" type="DECIMAL"/>
					<colinfo id="ESMT_COST" size="15" summ="default" type="DECIMAL"/>
					<colinfo id="PRES_COST" size="15" summ="default" type="DECIMAL"/>
					<colinfo id="NGTT_ESCS" size="15" summ="default" type="DECIMAL"/>
					<colinfo id="ESMT_EGRT" size="9" summ="default" type="DECIMAL"/>
					<colinfo id="CRES_COST" size="15" summ="default" type="DECIMAL"/>
					<colinfo id="UNIT_CRES_COST" size="15" summ="default" type="DECIMAL"/>
					<colinfo id="NOTE" size="256" summ="default" type="STRING"/>
					<colinfo id="ESMT_CMPY" size="40" summ="default" type="STRING"/>
					<colinfo id="WORD_REFR" size="256" summ="default" type="STRING"/>
					<colinfo id="OCNT_NUMB" size="20" summ="default" type="STRING"/>
					<colinfo id="EBDG_MGSQ" size="5" summ="default" type="INT"/>
					<colinfo id="EBDG_ITSQ" size="5" summ="default" type="INT"/>
					<colinfo id="MODI_DATE" size="8" summ="default" type="STRING"/>
					<colinfo id="MODI_TIME" size="6" summ="default" type="STRING"/>
					<colinfo id="MODI_USER" size="12" summ="default" type="STRING"/>
					<colinfo id="DEGREE" size="9" summ="default" type="DECIMAL"/>
					<colinfo id="ESIT_SEQN" size="5" summ="default" type="INT"/>
					<colinfo id="CH_FLAG" size="256" summ="default" type="STRING"/>
				</Contents>
			</Dataset>
			<Dataset DataSetType="Dataset" Editable="True" Id="ds_zfst0201_update">
				<Contents>
					<colinfo id="MANDT" size="3" summ="default" type="STRING"/>
					<colinfo id="ESCS_NUMB" size="20" summ="default" type="STRING"/>
					<colinfo id="ESCS_NTIM" size="5" summ="default" type="INT"/>
					<colinfo id="ESCS_ITSQ" size="5" summ="default" type="INT"/>
					<colinfo id="NGTT_ESCS" size="15" summ="default" type="DECIMAL"/>
					<colinfo id="MRGN_RATE" size="9" summ="default" type="DECIMAL"/>
				</Contents>
			</Dataset>
			<Dataset DataSetType="Dataset" Id="ds_zfst0200">
				<Contents>
					<colinfo id="MANDT" size="3" summ="default" type="STRING"/>
					<colinfo id="ESCS_NUMB" size="20" summ="default" type="STRING"/>
					<colinfo id="ESCS_NTIM" size="5" summ="default" type="INT"/>
					<colinfo id="NGTT_TAMT" size="15" summ="default" type="DECIMAL"/>
					<colinfo id="NGTT_APYN" size="1" summ="default" type="STRING"/>
					<record>
						<ESCS_NTIM/>
						<ESCS_NUMB></ESCS_NUMB>
						<MANDT></MANDT>
						<NGTT_APYN></NGTT_APYN>
						<NGTT_TAMT/>
					</record>
				</Contents>
			</Dataset>
			<Dataset DataSetType="Dataset" Id="ds_zfst0200_check">
				<Contents>
					<colinfo id="MANDT" size="3" summ="default" type="STRING"/>
					<colinfo id="ESCS_NUMB" size="20" summ="default" type="STRING"/>
					<colinfo id="ESCS_NTIM" size="5" summ="default" type="INT"/>
					<colinfo id="NGTT_TAMT" size="15" summ="default" type="DECIMAL"/>
					<colinfo id="OCNT_PDYN" size="1" summ="default" type="STRING"/>
					<colinfo id="ESCS_STAT" size="10" summ="default" type="STRING"/>
				</Contents>
			</Dataset>
			<Dataset DataObject="ds_zfst0201_list" DataSetType="Filter" Id="ds_zfst0201_master" OnColumnChanged="ds_zfst0201_master_OnColumnChanged"></Dataset>
			<Dataset DataObject="ds_zfst0201_list" DataSetType="Filter" FilterExpr='ITEM_DIYN==&apos;D&apos;&#32;&amp;&amp;&#32;ESCS_UPGR&#32;==&#32;ds_zfst0201_master.GetColumn(ds_zfst0201_master.GetRowPos(),&#32;&quot;ESCS_GROP&quot;)' Id="ds_zfst0201_detail" OnColumnChanged="ds_zfst0201_detail_OnColumnChanged"></Dataset>
		</Datasets>
		<Button ButtonStyle="TRUE" Cursor="HAND" Height="20" Id="btn_basicCode" ImageID="btn_sub_04" Left="896" LeftMargin="12" OnClick="btn_basic_info_OnClick" Style="sty_btn" TabOrder="1" Text="기준정보" Top="43" Transparent="TRUE" Width="76"></Button>
		<Grid AutoEnter="TRUE" AutoFitEndLine="Hide" BindDataset="ds_zfst0201_master" BkColor2="default" BoldHead="true" Border="Flat" Bottom="304" ColSizing="TRUE" Editable="TRUE" Enable="true" EndLineColor="default" HeadBorder="Flat" HeadHeight="25" Height="235" HScrollCell="TRUE" Id="grd_master" InputPanel="FALSE" Left="8" LineColor="user20" LineType="ExHORZ" OnCellClick="grd_master_OnCellClick" OnCellPosChanged="grd_master_OnCellPosChanged" Right="968" RowHeight="20" Style="sty_grid" TabOrder="3" TabStop="true" Top="69" UseDBuff="true" UsePopupMenu="true" UseSelColor="true" Visible="true" VLineColor="default" WheelScrollRow="1" Width="960">
			<contents>
				<format id="Default">
					<columns>
						<col width="0"/>
						<col width="0"/>
						<col width="56"/>
						<col width="27"/>
						<col width="231"/>
						<col width="139"/>
						<col width="44"/>
						<col width="45"/>
						<col width="98"/>
						<col width="93"/>
						<col width="94"/>
						<col width="98"/>
						<col width="44"/>
						<col width="47"/>
						<col width="179"/>
					</columns>
					<head>
						<cell col="0" display="text"/>
						<cell col="1" display="text"/>
						<cell col="2" display="text"/>
						<cell align="center" col="3" color="user21" display="text" font="굴림,9" wordwrap="word"/>
						<cell align="center" col="4" color="user21" display="text" font="굴림,9" text="항목" wordwrap="word"/>
						<cell align="center" col="5" color="user21" display="text" font="굴림,9" text="규격" wordwrap="word"/>
						<cell align="center" col="6" color="user21" display="text" font="굴림,9" text="단위" wordwrap="word"/>
						<cell col="7" color="user21" display="text" font="굴림,9" text="수량"/>
						<cell col="8" color="user21" display="text" font="굴림,9" text="단가(원)"/>
						<cell col="9" color="user21" display="text" font="굴림,9" text="원가(원)"/>
						<cell align="center" col="10" color="user21" display="text" font="굴림,9" text="견적금액(원)"/>
						<cell col="11" color="user21" display="text" font="굴림,9" text="네고금액(원)"/>
						<cell col="12" color="user21" display="text" font="굴림,9" text="시행율"/>
						<cell col="13" color="user21" display="text" font="굴림,9" text="비율"/>
						<cell col="14" color="user21" display="text" font="굴림,9" text="비고"/>
					</head>
					<body>
						<cell align="center" bkcolor2="user22" col="0" display="text" edit="normal"/>
						<cell col="1" colid="CHK" display="text"/>
						<cell align="left" col="2" colid="LIST_INDEX" display="text"/>
						<cell align="center" bkcolor2="user22" col="3" colid="FLAG" display="null" expandsize="0"/>
						<cell align="left" bkcolor2="user22" col="4" colid="ESCE_NAME" display="normal"/>
						<cell align="left" bkcolor2="user22" checklength="Byte" col="5" colid="STAD" display="text" expandsize="30" limit="150" Valign="Center"/>
						<cell align="center" bkcolor2="user22" col="6" colid="UNIT" display="text" expandsize="30" limit="765" Valign="Center"/>
						<cell align="right" col="7" colid="QNTY" display="text" expr="iif(QNTY==0,&#32;&apos;&apos;,&#32;QNTY)" Valign="Center"/>
						<cell align="right" col="8" colid="COST" display="number" expr="iif(COST==0,&#32;&apos;&apos;,&#32;COST)" Valign="Center"/>
						<cell align="right" bkcolor2="user22" col="9" colid="SALE_COST" display="number" expr="iif(SALE_COST==0,&#32;&apos;&apos;,&#32;SALE_COST)" Valign="Center"/>
						<cell col="10" colid="ESMT_COST" display="number" expr="iif(ESMT_COST==0,&#32;&apos;&apos;,&#32;ESMT_COST)" Valign="Center"/>
						<cell col="11" colid="NGTT_ESCS" display="number" expr="iif(NGTT_ESCS==0,&#32;&apos;&apos;,&#32;NGTT_ESCS)" Valign="Center"/>
						<cell align="center" col="12" colid="MRGN_RATE" display="numberexp" expr="round(100*SALE_COST/NGTT_ESCS,2)" Valign="Center"/>
						<cell align="center" col="13" display="text" expr='round(SALE_COST/CaseSumNF(&quot;ESCS_UPGR=&apos;&apos;&quot;,&#32;&quot;SALE_COST&quot;)*100,2)' Valign="Center"/>
						<cell align="left" col="14" colid="NOTE" display="text" limit="256" Valign="Center"/>
					</body>
					<summary>
						<cell col="0" display="text"/>
						<cell col="1" display="text"/>
						<cell align="center" bkcolor="user25" col="2" color="user26" colspan="6" display="text" text="직접비합계"/>
						<cell align="right" bkcolor="user25" col="8" color="user26" display="number" expr='ds_zfst0201_list.CaseSumNF(&quot;ITEM_DIYN=&apos;M&apos;&#32;&amp;&amp;&#32;indexOf(ESCS_ITEM,&#32;&apos;Z00&apos;)&#32;&lt;&#32;0&quot;,&#32;&quot;COST&quot;)'/>
						<cell align="right" bkcolor="user25" col="9" color="user26" display="number" expr='ds_zfst0201_list.CaseSumNF(&quot;ESCS_UPGR==&apos;&apos;&#32;&amp;&amp;&#32;indexOf(ESCS_ITEM,&apos;Z00&apos;)&#32;&lt;&#32;0&quot;,&quot;SALE_COST&quot;)'/>
						<cell align="right" bkcolor="user25" col="10" color="user26" display="number" expr='ds_zfst0201_list.CaseSumNF(&quot;&#32;ESCS_UPGR=&apos;&apos;&#32;&amp;&amp;&#32;indexOf(ESCS_ITEM,&#32;&apos;Z00&apos;)&#32;&lt;&#32;0&quot;,&#32;&quot;ESMT_COST&quot;)'/>
						<cell align="right" bkcolor="user25" col="11" color="user26" display="number" expr='ds_zfst0201_list.CaseSumNF(&quot;ESCS_UPGR=&apos;&apos;&#32;&amp;&amp;&#32;indexOf(ESCS_ITEM,&#32;&apos;Z00&apos;)&#32;&lt;&#32;0&quot;,&#32;&quot;NGTT_ESCS&quot;)'/>
						<cell align="center" bkcolor="user25" col="12" color="user26" display="text" expr='round(ds_zfst0201_list.CaseSumNF(&quot;ESCS_UPGR=&apos;&apos;&#32;&amp;&amp;&#32;indexOf(ESCS_ITEM,&#32;&apos;Z00&apos;)&#32;&lt;&#32;0&quot;,&#32;&quot;SALE_COST&quot;)/ds_zfst0201_list.CaseSumNF(&quot;ESCS_UPGR=&apos;&apos;&#32;&amp;&amp;&#32;indexOf(ESCS_ITEM,&#32;&apos;Z00&apos;)&#32;&lt;&#32;0&quot;,&#32;&quot;NGTT_ESCS&quot;)*100,2)'/>
						<cell align="right" bkcolor="user25" col="13" color="user26" display="text"/>
						<cell bkcolor="user25" col="14" color="user26" display="text"/>
						<cell col="0" display="text" row="1"/>
						<cell col="1" display="text" row="1"/>
						<cell align="center" bkcolor="user25" col="2" color="user26" colspan="6" display="text" expr='&quot;합계&quot;' row="1"/>
						<cell align="right" bkcolor="user25" col="8" color="user26" display="number" expr='ds_zfst0201_list.CaseSumNF(&quot;ITEM_DIYN=&apos;M&apos;&quot;,&#32;&quot;COST&quot;)' row="1"/>
						<cell align="right" bkcolor="user25" col="9" color="user26" display="number" expr='ds_zfst0201_list.CaseSumNF(&quot;ESCS_UPGR=&apos;&apos;&quot;,&#32;&quot;SALE_COST&quot;)' row="1"/>
						<cell align="right" bkcolor="user25" col="10" color="user26" display="number" expr='ds_zfst0201_list.CaseSumNF(&quot;&#32;ESCS_UPGR=&apos;&apos;&#32;&quot;,&#32;&quot;ESMT_COST&quot;)' row="1"/>
						<cell align="right" bkcolor="user25" col="11" color="user26" display="number" expr='ds_zfst0201_list.CaseSumNF(&quot;ESCS_UPGR=&apos;&apos;&quot;,&#32;&quot;NGTT_ESCS&quot;)' row="1"/>
						<cell align="center" bkcolor="user25" col="12" color="user26" display="text" expr='round(ds_zfst0201_list.CaseSumNF(&quot;ESCS_UPGR=&apos;&apos;&quot;,&#32;&quot;SALE_COST&quot;)/ds_zfst0201_list.CaseSumNF(&quot;ESCS_UPGR=&apos;&apos;&quot;,&#32;&quot;NGTT_ESCS&quot;)*100,2)' row="1"/>
						<cell bkcolor="user25" col="13" color="user26" display="text" row="1"/>
						<cell bkcolor="user25" col="14" color="user26" display="text" row="1"/>
					</summary>
				</format>
			</contents>
		</Grid>
		<Grid AutoEnter="TRUE" AutoFitEndLine="Hide" BindDataset="ds_zfst0201_detail" BkColor2="default" BoldHead="true" Border="Flat" Bottom="551" ColSizing="TRUE" Editable="TRUE" Enable="true" EndLineColor="default" HeadBorder="Flat" HeadHeight="25" Height="223" Id="grd_detail" InputPanel="FALSE" Left="8" LineColor="user20" LineType="ExHORZ" Right="968" RowHeight="20" Style="sty_grid" TabOrder="4" TabStop="true" Top="328" UseDBuff="true" UsePopupMenu="true" UseSelColor="true" Visible="true" VLineColor="default" WheelScrollRow="1" Width="960">
			<contents>
				<format id="Default">
					<columns>
						<col width="0"/>
						<col width="29"/>
						<col width="110"/>
						<col width="157"/>
						<col width="109"/>
						<col width="56"/>
						<col width="33"/>
						<col width="132"/>
						<col width="109"/>
						<col width="64"/>
						<col width="66"/>
						<col width="68"/>
						<col width="68"/>
						<col width="68"/>
						<col width="82"/>
						<col width="113"/>
						<col width="78"/>
						<col width="140"/>
						<col width="175"/>
					</columns>
					<head>
						<cell col="0" display="text"/>
						<cell align="center" col="1" color="user21" display="text" font="굴림,9" text="순번" wordwrap="word"/>
						<cell align="center" col="2" color="user21" display="text" font="굴림,9" text="자재번호/Part&#32;Num" wordwrap="word"/>
						<cell align="center" col="3" color="user21" display="text" font="굴림,9" text="항목" wordwrap="word"/>
						<cell align="center" col="4" color="user21" display="text" font="굴림,9" text="규격" wordwrap="word"/>
						<cell col="5" color="user21" display="text" font="굴림,9" text="단위"/>
						<cell col="6" color="user21" display="text" font="굴림,9" text="수량"/>
						<cell align="center" col="7" color="user21" display="text" font="굴림,9" text="견적금액(원)"/>
						<cell col="8" color="user21" display="text" font="굴림,9" text="네고금액(원)"/>
						<cell align="center" col="9" color="user21" display="text" font="굴림,9" text="통화단위"/>
						<cell col="10" color="user21" display="text" font="굴림,9" text="환율"/>
						<cell col="11" color="user21" display="text" font="굴림,9" text="단가"/>
						<cell col="12" color="user21" display="text" font="굴림,9" text="수입부대"/>
						<cell col="13" color="user21" display="text" font="굴림,9" text="간접비"/>
						<cell col="14" color="user21" display="text" font="굴림,9" text="원가(원)"/>
						<cell col="15" color="user21" display="text" font="굴림,9" text="이전견적금액(원)"/>
						<cell col="16" color="user21" display="text" font="굴림,9" text="시행율"/>
						<cell col="17" color="user21" display="text" font="굴림,9" text="견적업체명"/>
						<cell col="18" color="user21" display="text" font="굴림,9" text="비고"/>
					</head>
					<body>
						<cell align="center" bkcolor2="user22" col="0" display="text" edit="normal"/>
						<cell align="center" bkcolor2="user22" col="1" display="text" expandsize="0" expr="currow+1"/>
						<cell align="center" bkcolor2="user22" col="2" colid="MTRL_NUMB" display="normal"/>
						<cell align="left" bkcolor2="user22" checklength="Byte" col="3" colid="PART_NAME" display="text" expandsize="30" limit="150" Valign="Center"/>
						<cell align="left" bkcolor2="user22" col="4" colid="STAD" display="text" expandsize="30" limit="765" Valign="Center"/>
						<cell align="center" col="5" colid="UNIT" display="text" Valign="Center"/>
						<cell align="right" col="6" colid="QNTY" display="text" expr="iif(QNTY==0,&#32;&apos;&apos;,&#32;QNTY)" Valign="Center"/>
						<cell align="right" col="7" colid="ESMT_COST" display="number" expr="iif(ESMT_COST==0,&#32;&apos;&apos;,&#32;ESMT_COST)" Valign="Center"/>
						<cell align="right" col="8" colid="NGTT_ESCS" display="number" edit="number" expr="iif(NGTT_ESCS==0,&#32;&apos;&apos;,&#32;NGTT_ESCS)" Valign="Center"/>
						<cell align="center" col="9" colid="WAERK" display="text" Valign="Center"/>
						<cell align="right" col="10" colid="UKURS" display="numberexp" expr="iif(UKURS==0,&#32;&apos;&apos;,&#32;UKURS)" Valign="Center"/>
						<cell align="right" bkcolor2="user22" col="11" colid="COST" display="number" expr="iif(COST==0,&#32;&apos;&apos;,&#32;COST)" Valign="Center"/>
						<cell align="right" col="12" colid="ICDT_EPNS" display="numberexp" expr="iif(ICDT_EPNS==0,&#32;&apos;&apos;,&#32;ICDT_EPNS)" Valign="Center"/>
						<cell align="right" col="13" colid="IDRT_COST" display="numberexp" expr="iif(IDRT_COST==0,&#32;&apos;&apos;,&#32;IDRT_COST)" Valign="Center"/>
						<cell align="right" col="14" colid="SALE_COST" display="number" expr="iif(SALE_COST==0,&#32;&apos;&apos;,&#32;SALE_COST)" Valign="Center"/>
						<cell align="right" col="15" colid="PRES_COST" display="number" expr="iif(PRES_COST==0,&#32;&apos;&apos;,&#32;PRES_COST)" Valign="Center"/>
						<cell align="center" col="16" colid="MRGN_RATE" display="numberexp" expr="iif(MRGN_RATE==0,&#32;&apos;&apos;,&#32;MRGN_RATE)" Valign="Center"/>
						<cell col="17" colid="ESMT_CMPY" display="text" Valign="Center"/>
						<cell col="18" colid="NOTE" display="text" limit="256" Valign="Center"/>
					</body>
				</format>
			</contents>
		</Grid>
		<Div Height="20" Id="Div0" Left="5" TabOrder="2" Text="Div0" Top="307" Width="969">
			<Contents>
				<Image Height="20" Id="Image2" ImageID="form_bl_title_sub" Left="-3" TabOrder="6" Top="-1" Width="11"></Image>
				<Static Color="user6" Font="굴림,9,Bold" Height="20" Id="Static0" Left="10" TabOrder="2" Text="품목별&#32;원가" Top="1" VAlign="Middle" Width="102"></Static>
			</Contents>
		</Div>
		<Image Height="20" Id="Image1" ImageID="form_bl_title_sub" Left="2" TabOrder="5" Top="45" Width="11"></Image>
		<Static Color="user6" Font="굴림,9,Bold" Height="20" Id="Static4" Left="15" TabOrder="6" Text="기준항목별&#32;견적&#32;원가" Top="45" VAlign="Middle" Width="158"></Static>
		<Div Height="36" Id="div_btn" TabOrder="7" Text="Div0" Url="WB01::CommBtnForm.xml" Width="978">
			<Contents></Contents>
		</Div>
	</Form>
	<Script><![CDATA[/*
 ******************************************************************************************
 * 기      능   : 견적원가 등록
 * 작  성  자   : 박수근
 * 작성  일자   : 20116.11.01
 * ----------------------------------------------------------------------------------------
 * HISTORY    :
 ******************************************************************************************
 */
#include "LIB::commons.js";           // 공통 스크립트
#include "LIB::fs_common.js";         // 물류서비스 공통 스크립트

//=========================================================================================
// [ PART 1 ]
// Form에서 사용될 전역변수를 선언
// FORM에서 사용되는 전역변수는 대문자로 작성하며, F_XXX 의 형태를 갖도록 한다.
//=========================================================================================
var g_chg = "N";
var g_gType = "1"; // 1: 직접비, 2: 간접비
var g_widthArray = Array();

//=========================================================================================
// [ PART 2 ]
// Form Loading / Unloading 시 작업 정의
//=========================================================================================
function fn_OnLoadCompleted(obj) {
    gfn_initForm(true);             // Form 로드 이벤트 맨 첫줄에 기술
    fn_init_form();             // 폼 초기화
}

/********************************************************************************
* 기      능   : form UnloadCompleted
********************************************************************************/
function fn_OnUnloadCompleted(obj) {
    return gfn_isFormUnload(obj);
}

/********************************************************************************
* 기      능   : 폼 초기화
********************************************************************************/
function fn_init_form() {
    // 견적원가 드롭다운 그리드 선언
    gfn_InitDrillDown(ds_zfst0201_list, grd_master, "ITEM_DIYN=='M'", "FLAG", "LEVEL", "ESCS_GROP", "ESCS_UPGR", "ESCE_NAME", "CHK");

	ds_cond.SetColumn(0, "ESCS_NUMB", escsNumb);
	ds_cond.SetColumn(0, "ESCS_NTIM", escsNtim);
	
	ds_zfst0200.SetColumn(0, "ESCS_NUMB", escsNumb);
	ds_zfst0200.SetColumn(0, "ESCS_NTIM", escsNtim);

    // 품목별 원가 그리드 width
	for(var i=0; i < grd_detail.GetColCount(); i++) {
        g_widthArray[i] = grd_detail.GetColProp(i,"Width");
	}

	fn_query();
}

/********************************************************************************
* 기      능   : 견적원가 조회
********************************************************************************/
function fn_query() {
    // 조회 스크립트
    tit_clearActionInfo();
    tit_addSearchActionInfo("fs02:FS0201002A_S2");
    tit_callService(
                    ""
                   ,""
                   ,"ds_cond=ds_cond"
                   ,"ds_zfst0201_list=ds_zfst0201_list"
                   ,""
                   ,"fn_afterQuery"
                   ,"true"
                   ,"true"
                   ,"false"
                   );
}

/********************************************************************************
* 기      능   : 견적원가 조회 Callback
********************************************************************************/
function fn_afterQuery(errCode, errMsg) {
    if(ds_error.rowcount() > 0) {
        gfn_showMsg("CE00001");
    } else {
        gfn_showMsg("CI00002", ds_zfst0200.rowCount() + "");
    }
}

/********************************************************************************
* 기      능   : 견적원가품목 저장 
********************************************************************************/
function fn_save() {
    // 멀티 입력 스크립트
    if( g_chg == "Y" ) {
        if( gfn_showConfirm("네고 가격을 수정 하시겠습니까.?") ) {
            ds_zfst0201_update.ClearData();
            gfn_initDs( ds_zfst0200_check, true );
            ds_zfst0200_check.SetColumn(0, "ESCS_NUMB", ds_zfst0200.GetColumn(0, "ESCS_NUMB"));
            ds_zfst0200_check.SetColumn(0, "ESCS_NTIM", ds_zfst0200.GetColumn(0, "ESCS_NTIM"));
			
		    for(var i=0; i < ds_zfst0201_list.GetRowCount(); i++) {
		        var chFlag = ds_zfst0201_list.GetColumn(i, "CH_FLAG");
		        if( chFlag == "U" ) {
		            var nRow = ds_zfst0201_update.AppendRow();
		            ds_zfst0201_update.SetColumn(nRow, "MANDT", ds_zfst0201_list.GetColumn(i, "MANDT"));
		            ds_zfst0201_update.SetColumn(nRow, "ESCS_NUMB", ds_zfst0201_list.GetColumn(i, "ESCS_NUMB"));
		            ds_zfst0201_update.SetColumn(nRow, "ESCS_NTIM", ds_zfst0201_list.GetColumn(i, "ESCS_NTIM"));
		            ds_zfst0201_update.SetColumn(nRow, "ESCS_ITSQ", ds_zfst0201_list.GetColumn(i, "ESCS_ITSQ"));
		            ds_zfst0201_update.SetColumn(nRow, "NGTT_ESCS", ds_zfst0201_list.GetColumn(i, "NGTT_ESCS"));
		            ds_zfst0201_update.SetColumn(nRow, "MRGN_RATE", ds_zfst0201_list.GetColumn(i, "MRGN_RATE"));
		        }
		    }

            // 시행율
            ds_zfst0200.SetColumn(0, "MRGN_RATE", round(ds_zfst0201_list.CaseSumNF("ESCS_UPGR=''", "SALE_COST")/ds_zfst0201_list.CaseSumNF("ESCS_UPGR=''", "NGTT_ESCS")*100,2));
            
            // 네고총금액 반영
		    ds_zfst0200.SetColumn(0, "NGTT_TAMT", ds_zfst0201_list.CaseSumNF("ESCS_UPGR=''", "NGTT_ESCS"));
		    ds_zfst0200.SetColumn(0, "NGTT_APYN", "Y");
		    
			tit_clearActionInfo();
			tit_addSearchActionInfo("fs02:FS0202002A_S1");
			tit_callService(
							""
						   ,""
						   ,"ds_zfst0200_check=ds_zfst0200_check"
						   ,"ds_zfst0200_check=ds_zfst0200_check"
						   ,""
						   ,"fn_preSave"
						   ,"true"
						   ,"true"
						   ,"false"
						   );
		    
		    
		    
        }
    }
}
function fn_preSave(errCode, errMsg)
{
	if (errCode != 0)
	{
		gfn_showMsg("CE00001");
	}
	else
	{
		if (ds_zfst0200_check.GetColumn(0, "OCNT_PDYN") == "Y" )
		{
			gfn_openMsgWin("견적원가는 수주 등록되어 네고금액을 변경할 수 없습니다.", "W", "A", "");
			fn_query();
			return;
		}
		tit_clearActionInfo();
		tit_addMultiActionInfo("fs02:FS0202002A_U1");
		tit_addSingleActionInfo("fs02:FS0202002A_U2");
		tit_callService(
						""
					   ,""
					   ,"ds_zfst0201=ds_zfst0201_update ds_zfst0200=ds_zfst0200"
					   ,""
					   ,""
					   ,"fn_afterSave"
					   ,"true"
					   ,"true"
					   ,"false"
					   );
	}
}

/********************************************************************************
* 기      능   : 견적원가품목 저장 Callback
********************************************************************************/
function fn_afterSave(errCode, errMsg) {
    if(ds_error.rowcount() > 0) {
        gfn_showMsg("CE00001");
    } else {
        gfn_showMsg("CI00003");
        gfn_openMsgWin("네고 견적금액이 저장 되었습니다.", "", "A", "");
        var totalNgttEscs = ds_zfst0201_list.CaseSumNF("ESCS_UPGR=''", "NGTT_ESCS");
        close(totalNgttEscs);
    }
}

/********************************************************************************
* 기      능   : 닫기
********************************************************************************/
function fn_close() {
    if( g_chg == "Y" ) {
        if( gfn_showConfirm("저장처리 없이 종료하시겠습니까?") ) {
            close();
        } else {
            return;
        }
    }
	var totalNgttEscs = ds_zfst0201_list.CaseSumNF("ESCS_UPGR=''", "NGTT_ESCS");
	close(totalNgttEscs);
}

/********************************************************************************
* 기      능   : 사업년도별 기준정보 팝업을 호출한다.
********************************************************************************/
function btn_basic_info_OnClick(obj)
{
    var year = substr(gfn_getCurrDate(),0,4);
    var arg="bsnsYear="+quote(year);
    gfn_openPopup("FS0102001B", true, arg);
}

/********************************************************************************
* 기      능   : 접기 와 펼치기
********************************************************************************/
function grd_master_OnCellClick(obj,nRow,nCell,nX,nY,nPivotIndex)
{
	var columnID = obj.GetCellProp("body",nCell,"colid");
	var value = obj.GetCellValue(nRow, nCell);
	switch ( columnID ) {
	case "CHK":
		gfn_DrillDownCheckBox(obj, nRow);
		break;
	case "FLAG":
		ds_zfst0201_master.SetColumn(nRow, columnID, iif( value == '1' , '0', '1' ));
		ds_zfst0201_master.RecalcFilter();
		break;
	}
}

/********************************************************************************
* 기      능   : 상세조회
********************************************************************************/
function grd_master_OnCellPosChanged(obj,nRow,nCell,nOldRow,nOldCell,nPivotIndex,nOldPivotIndex)
{
    // 만약에 선택된 데이터 셑의 pis아래 부모코드로 pid가 정의되어 있으면 버튼을 disable 처리한다.
   	//var nMRowNF = ds_zfst0201_master.GetRowIndexNF(nRow);
   	var escsGrop = ds_zfst0201_master.GetColumn(nRow, "ESCS_GROP");
   	var filterString = "ESCS_UPGR="+quote(escsGrop)+" && ITEM_DIYN='M'";
   	var findRow = ds_zfst0201_master.SearchRow(filterString, nRow+1);
	ds_zfst0201_detail.RecalcFilter();
	fn_grdItemCtl(ds_zfst0201_master.GetColumn(nRow, "ESCS_ITEM"));
}

/********************************************************************************
* 기      능   : 직접비/간접시 기준원 사이즈 조절
********************************************************************************/
function fn_grdItemCtl(escsItem)
{
    if( indexOf(escsItem, "Z00") > -1 ) {
        // 간접비 입력항목만 그리드로 표현한다.
        if( g_gType == "1" ) {
            // 특정 컬럼에 사이즈 제거
            grd_detail.SetColProp(2,"Width", 0);  // 자재번호
            grd_detail.SetColProp(12,"Width", 0); // 수입부대
            grd_detail.SetColProp(15,"Width", 0); // 이전견적금액
            grd_detail.SetColProp(17,"Width", 0); // 견적업체명
            g_gType = "2";
        }
    } else {
        if( g_gType == "2" ) {
            // 그리드 사이즈 원복
            for(var i=0; i < g_widthArray.length; i++) {
                grd_detail.SetColProp(i,"Width", g_widthArray[i]);
            }
            g_gType = "1";
        }
    }
}

/********************************************************************************
* 기      능   : 견적원가 품목 값 변경 이벤트 NGTT_ESCS g_chg
********************************************************************************/
function ds_zfst0201_detail_OnColumnChanged(obj,nRow,strColumnID,varOldValue,varNewValue,nPivotIndex)
{
	switch ( strColumnID ) {
	    // 네고금액 변경
		case "NGTT_ESCS":
            var iRowNF = ds_zfst0201_detail.GetRowIndexNF(nRow);
		    var saleCost = ds_zfst0201_list.GetColumn(iRowNF, "SALE_COST"); 
		    var esmtCost = ds_zfst0201_list.GetColumn(iRowNF, "ESMT_COST");
		    var ngttEscs = ds_zfst0201_list.GetColumn(iRowNF, "NGTT_ESCS");
		    // 시행율 라운2
		    if( saleCost > 0 && esmtCost > 0 && ngttEscs > 0 ) {
				var mrgnRate = fn_mrgnRateCalu(saleCost, ngttEscs);
				ds_zfst0201_list.SetColumn(iRowNF, "MRGN_RATE", mrgnRate);
		    }
		
		    g_chg = "Y";
		    ds_zfst0201_list.SetColumn(iRowNF, "CH_FLAG", "U");
			gfn_DrillDownSum(ds_zfst0201_master, ds_zfst0201_master.currow, "", "NGTT_ESCS");
	        ds_zfst0201_master.RecalcFilter();
			break;
    }
}

/********************************************************************************
* 기      능   : 견적원가 예산항목 값 변경 이벤트
********************************************************************************/
function ds_zfst0201_master_OnColumnChanged(obj,nRow,strColumnID,varOldValue,varNewValue,nPivotIndex)
{
	switch ( strColumnID ) {
	    // 원가 변경시
		case "NGTT_ESCS":
            var iRowNF = ds_zfst0201_master.GetRowIndexNF(nRow);
		    var saleCost = ds_zfst0201_list.GetColumn(iRowNF, "SALE_COST"); 
		    var esmtCost = ds_zfst0201_list.GetColumn(iRowNF, "ESMT_COST");
		    var ngttEscs = ds_zfst0201_list.GetColumn(iRowNF, "NGTT_ESCS");
		    // 시행율 라운2
		    if( saleCost > 0 && esmtCost > 0 && ngttEscs > 0 ) {
				var mrgnRate = fn_mrgnRateCalu(saleCost, ngttEscs);
				ds_zfst0201_list.SetColumn(iRowNF, "MRGN_RATE", mrgnRate);
		    }
		    g_chg = "Y";
		    ds_zfst0201_list.SetColumn(iRowNF, "CH_FLAG", "U");
			break;
    }
}

/********************************************************************************
* 기      능   : 시행율 계산
*                시행율 = 원가/견적원가*100 round 2
********************************************************************************/
function fn_mrgnRateCalu(saleCost, esmtCost) {
    var mrgnRate = round(toNumber(saleCost)/toNumber(esmtCost)*100,2);
    return mrgnRate;
}
]]></Script>
</Window>