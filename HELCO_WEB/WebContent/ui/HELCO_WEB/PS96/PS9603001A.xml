<?xml version="1.0" encoding="utf-8"?>
<Window>
	<Form Height="392" Id="PS1501001B" Left="8" OnLoadCompleted="fn_OnLoadCompleted" OnUnloadCompleted="fn_OnUnloadCompleted" PidAttrib="7" Title="전자결재&#32;신청" Top="8" Ver="1.0" Width="616" WorkArea="true">
		<Datasets>
			<Dataset DataSetType="Dataset" Id="ds_cond">
				<Contents>
					<colinfo id="DOCU_NO" size="256" summ="default" type="STRING"/>
					<record>
						<DOCU_NO></DOCU_NO>
					</record>
				</Contents>
			</Dataset>
			<Dataset DataSetType="Dataset" Id="ds_head">
				<Contents>
					<colinfo id="DOCU_NO" size="255" summ="default" type="STRING"/>
					<colinfo id="APP_STATE" size="256" summ="default" type="STRING"/>
					<colinfo id="APP_REQ_ID" size="256" summ="default" type="STRING"/>
					<colinfo id="APP_REQ_NM" size="256" summ="default" type="STRING"/>
					<colinfo id="APP_CNFM_ID" size="256" summ="default" type="STRING"/>
					<colinfo id="APP_CNFM_NM" size="256" summ="default" type="STRING"/>
					<colinfo id="APP_CNFM_DT" size="256" summ="default" type="STRING"/>
					<colinfo id="REJT_DT" size="256" summ="default" type="STRING"/>
					<colinfo id="REJT_MEMO" size="256" summ="default" type="STRING"/>
					<colinfo id="PRE_DOCU_NO" size="256" summ="default" type="STRING"/>
					<record>
						<APP_CNFM_DT></APP_CNFM_DT>
						<APP_CNFM_ID></APP_CNFM_ID>
						<APP_CNFM_NM></APP_CNFM_NM>
						<APP_REQ_ID></APP_REQ_ID>
						<APP_REQ_NM></APP_REQ_NM>
						<APP_STATE></APP_STATE>
						<DOCU_NO></DOCU_NO>
						<PRE_DOCU_NO></PRE_DOCU_NO>
						<REJT_DT></REJT_DT>
						<REJT_MEMO></REJT_MEMO>
					</record>
				</Contents>
			</Dataset>
			<Dataset DataSetType="Dataset" Id="ds_detail">
				<Contents>
					<colinfo id="DOCU_NO" size="255" summ="default" type="STRING"/>
					<colinfo id="APP_STATE" size="256" summ="default" type="STRING"/>
					<colinfo id="APP_CNFM_ID" size="256" summ="default" type="STRING"/>
					<colinfo id="APP_CNFM_NM" size="256" summ="default" type="STRING"/>
					<colinfo id="APP_CNFM_DT" size="256" summ="default" type="STRING"/>
					<colinfo id="REJT_DT" size="256" summ="default" type="STRING"/>
					<colinfo id="REJT_MEMO" size="256" summ="default" type="STRING"/>
					<colinfo id="APP_MEMO" size="256" summ="default" type="STRING"/>
					<record>
						<APP_CNFM_DT></APP_CNFM_DT>
						<APP_CNFM_ID></APP_CNFM_ID>
						<APP_CNFM_NM></APP_CNFM_NM>
						<APP_MEMO></APP_MEMO>
						<APP_STATE></APP_STATE>
						<DOCU_NO></DOCU_NO>
						<REJT_DT></REJT_DT>
						<REJT_MEMO></REJT_MEMO>
					</record>
				</Contents>
			</Dataset>
			<Dataset DataSetType="Dataset" Id="ds_upgbn">
				<Contents>
					<colinfo id="CODE" size="255" type="STRING"/>
					<colinfo id="CODE_NAME" size="256" type="STRING"/>
				</Contents>
			</Dataset>
			<Dataset DataSetType="Dataset" Id="ds_zzactss">
				<Contents>
					<colinfo id="CODE" size="255" type="STRING"/>
					<colinfo id="CODE_NAME" size="256" type="STRING"/>
				</Contents>
			</Dataset>
			<Dataset DataSetType="Dataset" Id="ds_gyul">
				<Contents>
					<colinfo id="SEQ" size="256" summ="default" type="STRING"/>
					<colinfo id="CNFM_ID" size="255" summ="default" type="STRING"/>
					<colinfo id="CNFM_NM" size="256" summ="default" type="STRING"/>
					<colinfo id="RANK" size="256" summ="default" type="STRING"/>
					<colinfo id="DPTNM" size="256" summ="default" type="STRING"/>
					<colinfo id="PERNO" size="256" summ="default" type="STRING"/>
					<colinfo id="LIFNR" size="256" summ="default" type="STRING"/>
					<colinfo id="SIGN_YN" size="256" summ="default" type="STRING"/>
					<colinfo id="GUBUN" size="256" summ="default" type="STRING"/>
				</Contents>
			</Dataset>
			<Dataset DataSetType="Dataset" Id="ds_apply1">
				<Contents>
					<colinfo id="GID" size="0" summ="default" type="STRING"/>
					<colinfo id="GNM" size="0" summ="default" type="STRING"/>
					<colinfo id="RANK" size="0" summ="default" type="STRING"/>
					<colinfo id="DPTNM" size="0" summ="default" type="STRING"/>
					<colinfo id="USERMBPN" size="256" summ="default" type="STRING"/>
					<colinfo id="AREA_N" size="256" summ="default" type="STRING"/>
					<colinfo id="LIFNR" size="256" summ="default" type="STRING"/>
					<colinfo id="PERNO" size="256" summ="default" type="STRING"/>
				</Contents>
			</Dataset>
			<Dataset DataSetType="Dataset" Id="ds_apply">
				<Contents>
					<colinfo id="GID" size="0" summ="default" type="STRING"/>
					<colinfo id="GNM" size="0" summ="default" type="STRING"/>
					<colinfo id="RANK" size="0" summ="default" type="STRING"/>
					<colinfo id="DPTNM" size="0" summ="default" type="STRING"/>
					<colinfo id="USERMBPN" size="256" summ="default" type="STRING"/>
					<colinfo id="AREA_N" size="256" summ="default" type="STRING"/>
					<colinfo id="LIFNR" size="256" summ="default" type="STRING"/>
					<colinfo id="PERNO" size="256" summ="default" type="STRING"/>
				</Contents>
			</Dataset>
			<Dataset DataSetType="Dataset" Id="ds_tmp">
				<Contents>
					<colinfo id="DOCU_NO" size="255" summ="default" type="STRING"/>
					<colinfo id="APP_CNFM_ID" size="256" summ="default" type="STRING"/>
					<colinfo id="PSPID" size="256" summ="default" type="STRING"/>
					<colinfo id="POSID" size="256" summ="default" type="STRING"/>
					<colinfo id="GBN" size="256" summ="default" type="STRING"/>
					<record>
						<APP_CNFM_ID></APP_CNFM_ID>
						<DOCU_NO></DOCU_NO>
						<GBN></GBN>
						<POSID></POSID>
						<PSPID></PSPID>
					</record>
				</Contents>
			</Dataset>
			<Dataset DataSetType="Dataset" Id="ds_mail">
				<Contents>
					<colinfo id="SEQ" size="256" summ="default" type="STRING"/>
					<colinfo id="CNFM_ID" size="255" summ="default" type="STRING"/>
					<colinfo id="CNFM_NM" size="256" summ="default" type="STRING"/>
					<colinfo id="RANK" size="256" summ="default" type="STRING"/>
					<colinfo id="DPTNM" size="256" summ="default" type="STRING"/>
					<colinfo id="PERNO" size="256" summ="default" type="STRING"/>
					<colinfo id="LIFNR" size="256" summ="default" type="STRING"/>
					<colinfo id="SIGN_YN" size="256" summ="default" type="STRING"/>
					<colinfo id="GUBUN" size="256" summ="default" type="STRING"/>
				</Contents>
			</Dataset>
			<Dataset DataSetType="Dataset" Id="ds_gyul2">
				<Contents>
					<colinfo id="SEQ" size="256" summ="default" type="STRING"/>
					<colinfo id="USER_ID" size="255" summ="default" type="STRING"/>
					<colinfo id="CNFM_ID1" size="256" summ="default" type="STRING"/>
					<colinfo id="CNFM_ID2" size="256" summ="default" type="STRING"/>
					<colinfo id="CNFM_ID3" size="256" summ="default" type="STRING"/>
					<colinfo id="CDATE" size="256" summ="default" type="STRING"/>
				</Contents>
			</Dataset>
		</Datasets>
		<Div Height="35" Id="div_btn" Left="-1" TabOrder="1" Text="Div0" Url="WB01::CommBtnForm.xml" Width="616">
			<Contents></Contents>
		</Div>
		<Shape BKColor="user12" Bottom="236" Height="132" Id="Shape20" Left="10" LineColor="user13" Right="160" TabOrder="2" Top="104" Type="Rectangle" Width="150"></Shape>
		<Grid AutoEnter="TRUE" AutoFit="TRUE" AutoFitEndLine="Hide" BindDataset="ds_gyul" BkColor2="default" BoldHead="true" Border="Flat" Bottom="236" ColSizing="TRUE" Editable="TRUE" Enable="true" EndLineColor="default" FixedColSizing="TRUE" HeadBorder="Flat" HeadHeight="20" Height="108" Id="grd_gyul" InputPanel="FALSE" Left="162" LineColor="user20" LineType="ExHORZ" MinWidth="100" Right="610" RowHeight="20" Style="sty_grid" TabOrder="-1" TabStop="true" Top="128" UseDBuff="true" UsePopupMenu="true" UseSelColor="true" Visible="true" VLineColor="default" WheelScrollRow="1" Width="448">
			<contents>
				<format id="Default">
					<columns>
						<col width="40"/>
						<col width="63"/>
						<col width="80"/>
						<col width="80"/>
						<col width="244"/>
						<col width="1"/>
					</columns>
					<head>
						<cell align="center" col="0" display="text" font="Default,9" text="차수" TrimType="Both"/>
						<cell align="center" col="1" display="text" font="Default,9" text="구분" TrimType="Both"/>
						<cell align="center" col="2" display="text" font="Default,9" text="직위" TrimType="Both"/>
						<cell align="center" col="3" display="text" font="Default,9" text="이름" TrimType="Both"/>
						<cell align="center" col="4" display="text" font="Default,9" text="팀" TrimType="Both"/>
						<cell align="center" col="5" display="text" font="Default,9" text="결재" TrimType="Both"/>
					</head>
					<body>
						<cell align="center" bkcolor2="user22" col="0" colid="GID" display="normal" expr="CURROW+1"/>
						<cell align="left" bkcolor2="user22" col="1" display="text" expr="iif(CURROW+1==1,&apos;담당PM&apos;,iif(CURROW+1==&apos;2&apos;,&apos;지사장&apos;,iif(CURROW+1==&apos;3&apos;,&apos;팀장&apos;,iif(CURROW+1&#32;==&#32;&apos;4&apos;,&apos;QC팀장&apos;))))"/>
						<cell align="left" bkcolor2="user22" col="2" colid="RANK" display="text"/>
						<cell align="left" bkcolor2="user22" col="3" colid="CNFM_NM" display="text"/>
						<cell align="left" bkcolor2="user22" col="4" colid="DPTNM" display="text"/>
						<cell align="center" bkcolor2="user22" col="5" colid="SIGN_YN" display="text"/>
					</body>
				</format>
			</contents>
		</Grid>
		<Button Font="굴림,9" Height="20" Id="btn_up" Left="120" OnClick="btn_up_OnClick" TabOrder="3" Text="▲" Top="159" Width="18"></Button>
		<Button Font="굴림,9" Height="20" Id="btn_down" Left="120" OnClick="btn_down_OnClick" TabOrder="3" Text="▼" Top="179" Width="18"></Button>
		<Button Font="굴림,9" Height="20" Id="btn_left" Left="120" OnClick="btn_left_OnClick" TabOrder="3" Text="◀" Top="207" Width="18"></Button>
		<Button ButtonStyle="TRUE" Cursor="HAND" Height="18" Id="btn_addr" ImageID="btn_icon_user" Left="121" OnClick="btn_addr_OnClick" Style="sty_btn" TabOrder="4" Top="127" Transparent="TRUE" Width="18"></Button>
		<Button ButtonStyle="TRUE" Cursor="HAND" Height="21" Id="Button0" ImageID="btn_comm_save_u" Left="18" OnClick="btn_favoritesAdd" Style="sty_btn" TabOrder="5" Top="139" Transparent="TRUE" Width="23"></Button>
		<Button ButtonStyle="TRUE" Cursor="HAND" Height="21" Id="Button1" ImageID="btn_comm_query_u" Left="17" OnClick="Button1_OnClick" Style="sty_btn" TabOrder="6" Top="199" Transparent="TRUE" Width="23"></Button>
		<Static Height="13" Id="Static0" Left="17" TabOrder="7" Text="즐겨찾기추가" Top="121" Width="75"></Static>
		<Static Height="13" Id="Static8" Left="16" TabOrder="7" Text="즐겨찾기관리" Top="182" Width="75"></Static>
		<Static Height="15" Id="Static10" Left="169" TabOrder="12" Text="결재순서&#32;:&#32;1차(담당&#32;PM)&#32;→&#32;2차(지사장)&#32;→&#32;최종(팀장)" Top="110" Width="364"></Static>
		<Shape BKColor="user12" Bottom="350" Height="26" Id="Shape0" Left="10" LineColor="user13" Right="179" TabOrder="15" Top="324" Type="Rectangle" Width="169"></Shape>
		<Edit Align="CENTER" Border="Flat" Height="20" Id="ed_rejtNm" ImeMode="native" Left="93" LeftMargin="4" Readonly="TRUE" RightMargin="4" Style="sty_ipt_form" TabOrder="13" Top="327" Width="83"></Edit>
		<Static Align="Right" Height="24" Id="st_rejtmemo" Left="11" Style="sty_lb_form_basic" TabOrder="14" Text="반려자&#32;" Top="325" VAlign="Middle" Width="80"></Static>
		<Shape BKColor="user12" Bottom="300" Height="26" Id="Shape1" Left="10" LineColor="user13" Right="609" TabOrder="18" Top="274" Type="Rectangle" Width="599"></Shape>
		<Edit Border="Flat" Height="20" Id="ed_rejtMemo" ImeMode="native" Left="93" LeftMargin="4" Readonly="TRUE" RightMargin="4" Style="sty_ipt_form" TabOrder="16" Top="277" Width="513"></Edit>
		<Static Align="Right" Height="24" Id="Static1" Left="11" Style="sty_lb_form_basic" TabOrder="17" Text="반려사유&#32;" Top="275" VAlign="Middle" Width="80"></Static>
		<Shape BKColor="user12" Bottom="325" Height="26" Id="Shape2" Left="10" LineColor="user13" Right="179" TabOrder="21" Top="299" Type="Rectangle" Width="169"></Shape>
		<Edit Align="CENTER" Border="Flat" Height="20" Id="ed_rejtDt" ImeMode="native" Left="93" LeftMargin="4" Readonly="TRUE" RightMargin="4" Style="sty_ipt_form" TabOrder="19" Top="302" Width="83"></Edit>
		<Static Align="Right" Height="24" Id="Static2" Left="11" Style="sty_lb_form_basic" TabOrder="20" Text="반려일&#32;" Top="300" VAlign="Middle" Width="80"></Static>
		<Shape BKColor="user12" Bottom="276" Height="26" Id="Shape3" Left="10" LineColor="user13" Right="609" TabOrder="24" Top="250" Type="Rectangle" Width="599"></Shape>
		<Edit BKColor="honeydew" Border="Flat" Height="20" Id="ed_memo" ImeMode="native" Left="93" LeftMargin="4" RightMargin="4" Style="sty_ipt_form" TabOrder="22" Top="253" Width="513"></Edit>
		<Static Align="Right" Height="24" Id="Static3" Left="11" Style="sty_lb_form_basic" TabOrder="23" Text="메모&#32;" Top="251" VAlign="Middle" Width="80"></Static>
		<Image Enable="FALSE" Height="20" Id="img_ci" ImageID="img::top_ci.gif" Left="20" OnClick="img_ci_OnClick" Static="FALSE" TabOrder="25" Top="61" Width="172"></Image>
	</Form>
	<Script><![CDATA[/*
 ******************************************************************************************
 * 기      능   : 전자결재 신청
 * 작  성  자   : 
 * 작성  일자   : 2019-08-20
 * ----------------------------------------------------------------------------------------
 * HISTORY    :
 ******************************************************************************************
 */
#include "LIB::commons.js";	// 공통 스크립트 
//=========================================================================================
// [ PART 1 ]
// Form에서 사용될 전역변수를 선언
// FORM에서 사용되는 전역변수는 대문자로 작성하며, F_XXX 의 형태를 갖도록 한다. 
//=========================================================================================
var F_DOCU_NO = "";
var _NewDocuNo = "";
var enter = "";
var stats = "";
var name1 = "";
var namee = "";
var retif = "";
var lifnr_c = "";
var perno_c = "";
var jumin = "";
var lifnr = "";
var perno = "";
var perkey = "";
var pspid  = "";
var birth  = "";
var F_SIZE = 1024 * 4096;
var F_LINE_CHANGE = "";
//=========================================================================================
// [ PART 2 ]
// Form Loading / Unloading 시 작업 정의
//=========================================================================================
function fn_OnLoadCompleted(obj) {
	// Form 로드 이벤트 맨 첫줄에 기술 
	gfn_initForm();
	

	//결재라인 변경 버튼 클릭 시
	if(F_LINE_CHANGE == 'Y')
	{
		div_btn.btn_draft.Enable = false;
	}

	//반려일 경우
	if(isExistVar("F_DOCU_NO", true) && F_DOCU_NO != '')
	{
		ds_cond.SetColumn(0, "DOCU_NO", F_DOCU_NO);
		ufn_selectRejtDocu();
	}
	
	ufn_initApplyInfo();
}

/********************************************************************************
* 기      능   : 공통코드가 조회된 후의 Callback 함수 
********************************************************************************/
function fn_completeInit(sCode, sDsObj, sCodeType) {
//ALERT("2");
	//fn_query2();
}

/********************************************************************************
* 기      능   : 반려상태 일 경우, 반려정보 가져오기
********************************************************************************/
function ufn_selectRejtDocu()
{
	tit_clearActionInfo();	
	tit_addSearchActionInfo("ps96:PS9603001A_S2");
	tit_callService(
        ""
        , ""
        , "ds_cond=ds_cond"
        , "ds_gyul=ds_gyul"
        , ""
        , "ufn_afterSelR"
        , true);
    
}

function ufn_afterSelR()
{
    var nFindRow = ds_gyul.SearchRow("REJT_DT != ''");
    ed_rejtMemo.Text = ds_gyul.GetColumn(nFindRow, "REJT_MEMO");
    ed_rejtDt.Text = ds_gyul.GetColumn(nFindRow, "REJT_DT");
    ed_rejtNm.Text = ds_gyul.GetColumn(nFindRow, "REJT_NM");
    
    fn_chkQCteam();
}

/********************************************************************************
* 기      능   : 신청자 정보 Grid Automapping
********************************************************************************/
function ufn_initApplyInfo() 
{
	tit_clearActionInfo();	
	tit_addSearchActionInfo("ps96:PS9603001A_S1");
	tit_callService(
        ""
        , ""
        , ""
        , "ds_apply=ds_apply"
        , ""
        , ""
        , true);
        
    fn_chkQCteam();
}


/********************************************************************************
* 기      능   : 주소록 검색
********************************************************************************/
function btn_addr_OnClick(obj)
{
	var arg = "";
	var aRow = 0;
	
	var nSchRow = ds_gyul.SearchRow("CNFM_ID == '2013983'");
			
	if(nSchRow >= 0)
	{
		ds_gyul.DeleteRow(nSchRow);
	}
			
	var arr = gfn_openPopupUrl("PS96::PS9603001D.xml", true, arg);
	
	//ES-CRT 작업의 경우에는 QC팀장 결재라인 추가
	fn_chkQCteam();
	
	
}

/********************************************************************************
* 기      능   : 삭제버튼 클릭
********************************************************************************/
function btn_del_OnClick(obj)
{
	ds_subject.deleteRow(ds_subject.row);
}


/********************************************************************************
* 기      능   : 조회(결재자)
********************************************************************************/
function fn_query() {

}

/********************************************************************************
* 기      능   : 조회 Callback  
********************************************************************************/
function fn_afterQuery(errCode, errMsg) {
	gfn_showMsg("CI00002",ds_swn.RowCount()+"");
}

/********************************************************************************
* 기      능   : 기안
********************************************************************************/
function fn_draft() {
	// ## 생성테이블
	// ZPSTEA01M (전자결재 MASTER)
	// ZPSTEA01D (전자결재 DETAIL)
	// A0 : 1차결재, A1 : 2차결재, A2 : 최종결재
	
	////1.결재자 지정 확인 [ES-CRT일 경우에는 QC검사 결재라인까지 4단계]
	
	if(G_GBN == 'X')	// ES CRT일 경우에는 4단계
	{
		if (ds_gyul.rowcount() != 4)
		{
			gfn_openMsgWin("결재자(PM, 지사장, 팀장, QC팀장)를 선택하십시오.", "W", "", "");
			return false;
		}
	}
	else
	{
		if (ds_gyul.rowcount() != 3)
		{
			gfn_openMsgWin("결재자(PM, 지사장, 팀장)를 선택하십시오.", "W", "", "");
			return false;
		}
	}
	
	
	//담당 PM이 본인과 다른 경우 경고
	if(G_USER_ID != ds_gyul.GetColumn(0, "CNFM_ID"))
	{
		if(!gfn_openMsgWin("현재 로그인한 사용자가\n지정한 담당 PM과 다릅니다.\n그래도 진행하시겠습니까?", "W", "C", "")) return;
	}
	else
	{
		if(!gfn_openMsgWin("결재요청 하시겠습니까?", "I", "C", "")) return;
	}

	var sNewDocuNo = GBN_CODE + GetDate();
	_NewDocuNo = sNewDocuNo;
	
	
	var nAddRow = 0;
	
	ds_head.clearData();
	ds_detail.clearData();
	ds_tmp.ClearData();
	
	nAddRow = ds_head.addRow();
	// ZPSTEA01M (MASTER)
	ds_head.SetColumn(nAddRow, "DOCU_NO"			, sNewDocuNo);
	ds_head.SetColumn(nAddRow, "APP_STATE"		, "Z0"); 
	ds_head.SetColumn(nAddRow, "APP_REQ_ID"		, G_USER_ID);
	ds_head.SetColumn(nAddRow, "APP_REQ_NM"		, G_USER_NAME);
	ds_head.SetColumn(nAddRow, "APP_CNFM_ID"		, "");
	ds_head.SetColumn(nAddRow, "APP_CNFM_NM"		, "");
	ds_head.SetColumn(nAddRow, "APP_CNFM_DT"		, "");
	ds_head.SetColumn(nAddRow, "REJT_DT"			, "");
	ds_head.SetColumn(nAddRow, "REJT_MEMO"		, "");
	ds_head.SetColumn(nAddRow, "PRE_DOCU_NO"		, F_DOCU_NO);
	
	
	// ZPSTEA01D (DETAIL)
	for(var i=0;i<ds_gyul.rowcount;i++)
	{
		nAddRow = ds_detail.addRow();
		ds_detail.SetColumn(nAddRow, "DOCU_NO"		, sNewDocuNo);
		ds_detail.SetColumn(nAddRow, "APP_STATE"	, "A"+i);
		ds_detail.SetColumn(nAddRow, "APP_CNFM_ID"	, ds_gyul.GetColumn(i, "CNFM_ID"));
		ds_detail.SetColumn(nAddRow, "APP_CNFM_NM"	, ds_gyul.GetColumn(i, "CNFM_NM"));
		ds_detail.SetColumn(nAddRow, "APP_CNFM_DT"	, "");
		ds_detail.SetColumn(nAddRow, "REJT_DT"		, ""); 
		ds_detail.SetColumn(nAddRow, "REJT_MEMO"	, "");
		
		if(i == 0)	// 기안자 메모 등록
		{
			ds_detail.SetColumn(nAddRow, "APP_MEMO"		, ed_memo.Text);
		}
		else
		{
			ds_detail.SetColumn(nAddRow, "APP_MEMO"		, "");
		}
	}

	// PM 자동결재 처리
	ds_head.SetColumn(0, "APP_STATE"	, "A0"); 
	ds_head.SetColumn(0, "APP_CNFM_ID"	, ds_gyul.GetColumn(0, "CNFM_ID"));
	ds_head.SetColumn(0, "APP_CNFM_NM"	, ds_gyul.GetColumn(0, "CNFM_NM"));
	ds_head.SetColumn(0, "APP_CNFM_DT"	, gfn_getCurrDate());

	ds_detail.SetColumn(0, "APP_CNFM_ID", ds_gyul.GetColumn(0, "CNFM_ID"));
	ds_detail.SetColumn(0, "APP_CNFM_NM", ds_gyul.GetColumn(0, "CNFM_NM"));
	ds_detail.SetColumn(0, "APP_CNFM_DT", gfn_getCurrDate());

	// ZPSTW1401 UPDATE를 위한 처리
	ds_tmp.AddRow();
	ds_tmp.SetColumn(0, "PSPID", G_PSPID);
	ds_tmp.SetColumn(0, "POSID", G_POSID);
	ds_tmp.SetColumn(0, "GBN", G_GBN);
	ds_tmp.SetColumn(0, "APP_CNFM_ID", ds_gyul.GetColumn(0, "CNFM_ID"));
	ds_tmp.SetColumn(0, "DOCU_NO", sNewDocuNo);
	
	//Trace(ds_head.saveXML());
	//Trace(ds_detail.saveXML());
	
	tit_clearActionInfo();
	tit_addMultiActionInfo("ps96:PS9603001A_I1");
	tit_addMultiActionInfo("ps96:PS9603001A_I2");
	tit_addMultiActionInfo("ps96:PS9603001A_U1");
	tit_callService(
			""
			, ""
			, "ds_head=ds_head ds_detail=ds_detail ds_tmp=ds_tmp"
			, ""
			, ""
			, "fn_afterSave"
			, ""
			, ""
			, true);	

}

/********************************************************************************
* 기      능   : 저장 Callback  
********************************************************************************/
function fn_afterSave(errCode, errMsg) {
	if ( errCode != 0 ) {
		gfn_showMsg("CE00001");
	} else {
		//gfn_showAlert("CI00003");
		
		gfn_openMsgWin("기안되었습니다.");
		
		fn_afterSave2();	// 2차 결재자 메일 발송
	}
}
/********************************************************************************
* 기      능   : 신청 후 2차 결재자에게 메일 발송
********************************************************************************/
function fn_afterSave2()
{
	ds_cond.SetColumn(0, "DOCU_NO", _NewDocuNo);
	
	tit_clearActionInfo();
	tit_addSearchActionInfo("ps96:PS9603002A_S2");
	tit_callService(
        ""
        , ""
        , "ds_cond=ds_cond"
        , "ds_mail=ds_detail"
        , ""
        , "fn_afterSave3"
        , true);
}

/********************************************************************************
* 기      능   : 메일 발송
********************************************************************************/
function fn_afterSave3()
{
	//보내는 사람(1차)과 받는 사람(2차)을 Detail정보에서 둘다 가지고 있음.
	
	var nSendRow = ds_mail.SearchRow("APP_STATE=='A0'");		//보내는 사람의 정보 Row
	var nRecvRow = ds_mail.SearchRow("APP_STATE=='A1'");		// 받는사람의 정보 Row
	
	
	var send_user = "helco" + ds_mail.GetColumn(nSendRow, "APP_CNFM_ID") + "@hdel.co.kr";//보내는사람
	var rece_user = "helco" + ds_mail.GetColumn(nRecvRow, "APP_CNFM_ID") + "@hdel.co.kr"; //받는사람
	var send_user_nm = ds_mail.GetColumn(nSendRow, "APP_CNFM_NM"); //발신자 이름
	var rece_user_nm = ds_mail.GetColumn(nRecvRow, "APP_CNFM_NM"); //수신자 이름
		
	var mesgtitl  = ""; //제목
	var mesgbody  = ""; //내용
	
	var pop_meg = "";
	
	mesgtitl += '기타외주작업 결재요청 (' + G_POSID +' - ' + substr(G_ZSITE_NM,0,7) + ")";
	
	mesgbody = ds_mail.GetColumn(nSendRow, "DPTNM") + ' ' + ds_mail.GetColumn(nSendRow, "APP_CNFM_NM") +' 님이 SRM을 통해 발송한 메일입니다. ' + '\n\n'; 
	
    mesgbody =  mesgbody +'프로젝트번호: ' + G_POSID + '\n';
    mesgbody = mesgbody + '프로젝트명: ' + G_ZSITE_NM + '\n\n';
    
    mesgbody = mesgbody + '외주작업구분: '  + G_JOB_NAME + '를(을) 신청하오니 결재 바랍니다.\n';
    mesgbody = mesgbody + '(결재 화면: SRM-발주기성-기타외주작업 작업지시서(관리자) 결재화면)\n\n';
    mesgbody = mesgbody + '감사합니다.\n';
    //------------------------------------------------------------------------------
    var cc_user = "";
    var cc_user_nm = "";
    
    //send_user = "helco2029847@hdel.co.kr";
	//send_user_nm = "송광용";
	
    //rece_user = "helco2029847@hdel.co.kr";
	//rece_user_nm = "송광용";

	//Trace(send_user);
	//Trace(rece_user);
	//Trace(send_user_nm);
	//Trace(rece_user_nm);

 

    if(rece_user != "")
    {

		tit_callService(
			"COMM_ACT"
			, "sendmailNew"
			, ""
			, ""
			," SEND_USER=" + quote( send_user )
				+ " RECV_USER=" + quote( rece_user )
				+ " CC_USER=" + quote(cc_user)
				+ " SEND_USER_NM=" + quote( send_user_nm )
				+ " RECV_USER_NM=" + quote( rece_user_nm )
				+ " CC_USER_NM=" + quote(cc_user_nm)
				+ " MESGTITL="  + quote( mesgtitl )
				+ " MESGBODY="  + quote( mesgbody )
			, ""
			, false
			, true);

		/*tit_callService(
			"COMM_ACT"
			, "sendmail"
			, ""
			, ""
			," SEND_USER=" + quote( send_user )
				+ " RECE_USER=" + quote( rece_user )
				+ " MESGTITL="  + quote( mesgtitl )
				+ " MESGBODY="  + quote( mesgbody )
			, ""
			, false
			, true);*/
     
		pop_meg = '메일이 발송 되었습니다.';	
    }
    		
	close(_NewDocuNo);
}


/********************************************************************************
* 기      능   : form UnloadCompleted 
********************************************************************************/
function fn_OnUnloadCompleted(obj) {
	return gfn_isFormUnload(obj);
}
//=========================================================================================
// [ PART 3 ]
// Main Process Event 정의(조회,입력,삭제,저장,인쇄,form닫기)
//=========================================================================================

/********************************************************************************
* 기      능   : 닫기  
********************************************************************************/
function fn_close() {
	if(F_LINE_CHANGE != 'Y')
	{
		//parent.fn_Query();
	}
	
	close("C");
}


/********************************************************************************
* 기      능   : 결재자 삭제
********************************************************************************/
function btn_left_OnClick(obj)
{
	if(ds_gyul.currow == 3) return;
	ds_gyul.DeleteRow(ds_gyul.row);
}

/********************************************************************************
* 기      능   : 결재자순서 위로이동
********************************************************************************/
function btn_up_OnClick(obj)
{
	if(ds_gyul.currow == 3)
	{
		return;
	}
	var prow = ds_gyul.GetPrevRow();
	ds_gyul.MoveRow(ds_gyul.row,prow);
	ds_gyul.row = prow;
}
/********************************************************************************
* 기      능   : 결재자순서 아래로이동
********************************************************************************/
function btn_down_OnClick(obj)
{
	if(ds_gyul.currow == 2)
	{
		return;
	}
	var prow = ds_gyul.GetNextRow();
	ds_gyul.MoveRow(ds_gyul.row,prow);
	ds_gyul.row = prow;
}





/********************************************************************************
* 기      능   : 결재자 즐겨찾기 등록
********************************************************************************/
function btn_favoritesAdd(obj)
{
	
	if(!gfn_isChangeDs(ds_gyul, false))
	{
	    // CW00005=변경된 정보가 없습니다.
		gfn_showAlert("CW00005"); 
		return;
	}
	
	gfn_initDs(ds_gyul2, true);
	for(var i=0; i<ds_gyul.RowCount(); i++)
	{
		if( i == 0 )
		{
			ds_gyul2.setColumn(0, "CNFM_ID1", ds_gyul.getcolumn(i,"CNFM_ID") );
		}
		else if( i == 1)
		{
			ds_gyul2.setColumn(0, "CNFM_ID2", ds_gyul.getcolumn(i,"CNFM_ID") );
		}
		else if(i == 2)
		{
			ds_gyul2.setColumn(0, "CNFM_ID3", ds_gyul.getcolumn(i,"CNFM_ID") );
		}
	}
	

	
	tit_clearActionInfo();
	tit_addMultiActionInfo("ps96:PS9603001B_I1");
	tit_callService(
		""
		, ""
		, "ds_gyul2=ds_gyul2"
		, ""
		, ""
		, "ufn_favoritesAdd"
		, ""
		, ""
		, true);		
	
}


function ufn_favoritesAdd(errCode, errMsg) 
{
	if ( errCode != 0 ) 
	{
		gfn_showAlert("CE00001");
	} 
	else 
	{
		gfn_showAlert("CI00003");
	}
}	


/********************************************************************************
* 기      능   : 즐겨찾기 검색 
********************************************************************************/
function Button1_OnClick(obj)
{
	var nSchRow = ds_gyul.SearchRow("CNFM_ID == '2013983'");
			
	if(nSchRow >= 0)
	{
		ds_gyul.DeleteRow(nSchRow);
	}
	
	var arg = "";
	var arr = gfn_openPopupUrl("PS96::PS9603001B.xml", true, arg);
	//ufn_setUserId(arr);	
	fn_chkQCteam();
}

/********************************************************************************
* 기      능   : ES-CRT 작업의 경우 QC팀장 추가
********************************************************************************/
function fn_chkQCteam()
{
	if(G_GBN = 'X') // ES-CRT의 경우에는 마지막 결재라인에 QC팀장 추가
	{
		if(ds_gyul.GetRowCount() == 3)
		{
			// 중복 선택 방지.
			gfn_openMsgWin("CRT(ES) 작업의 경우, 설치품질검사팀(팀장) 결재가 추가됩니다.");
			
			aRow = ds_gyul.AddRow();

			ds_gyul.SetColumn(aRow, "CNFM_ID"   , "3013545" );
			ds_gyul.SetColumn(aRow, "CNFM_NM"   , "김상훈"  );
			ds_gyul.SetColumn(aRow, "RANK" 		, "기원"  );
			ds_gyul.SetColumn(aRow, "DPTNM"		, "설치품질검사팀" );
		}
	}
}]]></Script>
</Window>