<?xml version="1.0" encoding="euc-kr"?>
<query>
	<type>select</type>
	<description><![CDATA[현장별 거래명세서 내역 조회 - detail (발주번호있는경우)]]></description>
	<reload>true</reload>
	<monitoring>true</monitoring>
	<result-count>0</result-count>
	<statement>
<![CDATA[
SELECT
    '0' AS CHECK 
  , MAX(MM017.CHAR1) AS CHAR1
  , MM017.INVNR AS INVNR
  , MIN(MM017.INVITEM) AS INVITEM
  , SUM(MM017.INS_Q) AS INS_Q
  , MM017.MATNR AS MATNR
  , MM017.MATNR AS MANDT
  , MAX(MM017.MAKTX) AS MAKTX
  , SUM(MM017.MENGE) AS MENGE
  , SUM(MM017.B_MENGE) AS B_MENGE
  , MAX(MM017.MEINS) AS MEINS
  , MAX(MM017.EKGRP) AS EKGRP
  , MAX(MM017.EKGRP1) AS EKGRP1
  , MIN(MM017.EBELN) AS EBELN
  , MAX(MM017.WERKS) AS WERKS
  , MAX(MM017.NAME1) AS NAME1
  , MAX(MM017.MBLNR) AS MBLNR
  , SAPHEE.GET_CURRDATA(MAX(MM017.WAERS),MM017.NETPR) AS NETPR
  , MAX(MM017.STO_MBLNR) AS STO_MBLNR
  , MAX(MM017.PRO_F) AS PRO_F
  , MM017.POSID AS POSID
  , MAX(MM017.POST1) AS POST1
  , SAPHEE.GET_ZERODATE(MAX(MM017.RDATE_P)) AS RDATE_P
  , SAPHEE.GET_ZERODATE(MAX(MM017.RECE_DATE)) AS RECE_DATE
  , SAPHEE.GET_ZERODATE(MAX(MM017.RECE_TIME)) AS RECE_TIME
  , SAPHEE.GET_ZERODATE(MAX(MM017.DEL_DATE)) AS DEL_DATE
  , SAPHEE.GET_ZERODATE(MAX(MM017.DEL_TIME)) AS DEL_TIME
  , SAPHEE.GET_ZERODATE(MAX(MM017.BUDAT)) AS BUDAT
  , SAPHEE.GET_ZERODATE(MAX(MM017.IN_DT)) AS IN_DT
  , SAPHEE.GET_ZERODATE(MAX(MM017.IN_TM)) AS IN_TM
  , SAPHEE.GET_ZERODATE(MAX(MM017.CA_DT)) AS CA_DT
  , SAPHEE.GET_ZERODATE(MAX(MM017.CA_TM)) AS CA_TM
  , SAPHEE.GET_ZERODATE(MM017.UDATE) AS UDATE
  , SAPHEE.GET_ZERODATE(MAX(MM017.DDATE)) AS DDATE
  , MAX(MM017.POTYPE) AS POTYPE
  , MAX(MM017.BISMT) AS BISMT
  , MIN(MM017.QM_CHK) AS QM_CHK
  , SAPHEE.TO_DATETIME(CURRENT TIMESTAMP, 'EE', '.',':') AS UDT
  , SAPHEE.GET_MM_HOGI(MM017.MANDT,MM017.INVNR,MM017.POSID,MM017.MATNR,MM017.UDATE,MM017.NETPR) AS BIGO
--  ,CASE WHEN MAX(MM011.EXTWG) IS NOT NULL AND MAX(MM011.EXTWG) > '' THEN (
--	        CASE MAX(SUBSTR(MM026.BLOCK,1,1)) WHEN '1'  THEN MAX(MM025.SHIPDAT1)  
--	        WHEN '2'  THEN MAX(MM025.SHIPDAT2) 
--	        WHEN '3' THEN MAX(MM025.SHIPDAT3)  
--	        WHEN '4'  THEN MAX(MM025.SHIPDAT4)  
--	        WHEN '5'  THEN MAX(MM025.SHIPDAT5) 
--	        ELSE (
--	           CASE WHEN MAX(MM025.SHIPDAT1) IS NULL    THEN '00000000'
--	               WHEN MAX(MM011.BLOCK_NO) = ''       THEN MAX(MM025.SHIPDAT2)
--	               WHEN MAX(MM011.BLOCK_NO) LIKE 'A%'  THEN MAX(MM025.SHIPDAT1)  
--	               WHEN MAX(MM011.BLOCK_NO) LIKE 'B%'  THEN MAX(MM025.SHIPDAT2) 
--	               WHEN MAX(MM011.BLOCK_NO) LIKE 'C%'  THEN MAX(MM025.SHIPDAT3)  
--	               WHEN MAX(MM011.BLOCK_NO) LIKE 'D%'  THEN MAX(MM025.SHIPDAT4)  
--	               WHEN MAX(MM011.BLOCK_NO) LIKE 'E%'  THEN MAX(MM025.SHIPDAT5) ELSE '00000000' END) END)
--    ELSE ( CASE WHEN MAX(MM017.POSGBN) = 'L' THEN (
--	        CASE MAX(SUBSTR(MM026.BLOCK,1,1)) WHEN '1'  THEN MAX(MM025.SHIPDAT1)  
--	        WHEN '2'  THEN MAX(MM025.SHIPDAT2) 
--	        WHEN '3' THEN MAX(MM025.SHIPDAT3)  
--	        WHEN '4'  THEN MAX(MM025.SHIPDAT4)  
--	        WHEN '5'  THEN MAX(MM025.SHIPDAT5) 
--	        ELSE (
--	           CASE WHEN MAX(MM025.SHIPDAT1) IS NULL    THEN '00000000'
--	               WHEN MAX(MM011.BLOCK_NO) = ''       THEN MAX(MM025.SHIPDAT2)
--	               WHEN MAX(MM011.BLOCK_NO) LIKE 'A%'  THEN MAX(MM025.SHIPDAT1)  
--	               WHEN MAX(MM011.BLOCK_NO) LIKE 'B%'  THEN MAX(MM025.SHIPDAT2) 
--	               WHEN MAX(MM011.BLOCK_NO) LIKE 'C%'  THEN MAX(MM025.SHIPDAT3)  
--	               WHEN MAX(MM011.BLOCK_NO) LIKE 'D%'  THEN MAX(MM025.SHIPDAT4)  
--	               WHEN MAX(MM011.BLOCK_NO) LIKE 'E%'  THEN MAX(MM025.SHIPDAT5) ELSE '00000000' END) END)
--           ELSE MAX(MM025.SHIPDAT1)END ) END     AS SHIPDAT
-- 신구박스 변경으로 출하예정이 조회 변경 2012.02.10 HSS
-- NC현장 ZPPT027 테이블 참조로 변경 2015.11.04 조영욱
-- 보수 안성창고 자재 ZMMT001 테이블 참조로 변경 2016.06.30 조영욱
 	, CASE WHEN MAX(MM017.LGORT) = '9500' THEN ( SAPHEE.GET_BOSU_SHIPDAT(MM017.MANDT, MIN(MM017.EBELN), MIN(MM017.EBELP) ) 
                  )  ELSE (
                      CASE WHEN MAX(MM017.EXTWG) IS NULL OR MAX(MM017.EXTWG) = '' OR (MAX(MM017.BOX_CK) = '' AND MAX(MM017.EXTWG) = 'BOX33') OR (MAX(MM017.BOX_CK) = '24' AND MAX(MM017.EXTWG)='BOX24') THEN 
		  (CASE WHEN MAX(MM025.SHIPDAT1) IS NULL    THEN '00000000'
 	                WHEN MAX(MM011.BLOCK_NO) = ''       THEN (CASE WHEN MAX(SUBSTR(MM017.MPOSID,7,2)) = 'NC' THEN MAX(PP027.ILDAT) ELSE MAX(MM025.SHIPDAT2) END)
  	              WHEN MAX(MM011.BLOCK_NO) LIKE 'A%'  THEN (CASE WHEN MAX(SUBSTR(MM017.MPOSID,7,2)) = 'NC' THEN MAX(PP027.ILDAT) ELSE MAX(MM025.SHIPDAT1) END)
  	              WHEN MAX(MM011.BLOCK_NO) LIKE 'B%'  THEN (CASE WHEN MAX(SUBSTR(MM017.MPOSID,7,2)) = 'NC' THEN MAX(PP027.ILDAT) ELSE MAX(MM025.SHIPDAT2) END) 
 	                WHEN MAX(MM011.BLOCK_NO) LIKE 'C%'  THEN (CASE WHEN MAX(SUBSTR(MM017.MPOSID,7,2)) = 'NC' THEN MAX(PP027.ILDAT) ELSE MAX(MM025.SHIPDAT3) END)  
 	                WHEN MAX(MM011.BLOCK_NO) LIKE 'D%'  THEN (CASE WHEN MAX(SUBSTR(MM017.MPOSID,7,2)) = 'NC' THEN MAX(PP027.ILDAT) ELSE MAX(MM025.SHIPDAT4) END)  
 	                WHEN MAX(MM011.BLOCK_NO) LIKE 'E%'  THEN (CASE WHEN MAX(SUBSTR(MM017.MPOSID,7,2)) = 'NC' THEN MAX(PP027.ILDAT) ELSE MAX(MM025.SHIPDAT5) END) ELSE '00000000' END) 
		   ELSE		   
		   (CASE ( CASE WHEN MAX(MM017.BOX_CK) = '24' THEN  (SELECT VALUE(SUBSTR(BLOCK,1,1),'') FROM SAPHEE.ZMMT026_1 WHERE MANDT= MM017.MANDT AND BOXNO = MAX(MM017.EXTWG))
	                           ELSE  (SELECT VALUE(SUBSTR(BLOCK,1,1),'') FROM SAPHEE.ZMMT026 WHERE MANDT= MM017.MANDT AND BOXNO = MAX(MM017.EXTWG)) END )
			    WHEN '1' THEN (CASE WHEN MAX(SUBSTR(MM017.MPOSID,7,2)) = 'NC' THEN MAX(PP027.ILDAT) ELSE MAX(MM025.SHIPDAT1) END)
			    WHEN '2' THEN (CASE WHEN MAX(SUBSTR(MM017.MPOSID,7,2)) = 'NC' THEN MAX(PP027.ILDAT) ELSE MAX(MM025.SHIPDAT2) END)
			    WHEN '3' THEN (CASE WHEN MAX(SUBSTR(MM017.MPOSID,7,2)) = 'NC' THEN MAX(PP027.ILDAT) ELSE MAX(MM025.SHIPDAT3) END)
			    WHEN '4' THEN (CASE WHEN MAX(SUBSTR(MM017.MPOSID,7,2)) = 'NC' THEN MAX(PP027.ILDAT) ELSE MAX(MM025.SHIPDAT4) END)
			    WHEN '5' THEN (CASE WHEN MAX(SUBSTR(MM017.MPOSID,7,2)) = 'NC' THEN MAX(PP027.ILDAT) ELSE MAX(MM025.SHIPDAT5) END) ELSE '00000000' END)  END ) END   AS SHIPDAT  
  , MAX(MM017.BIGO) AS BIGO1
  , VALUE(SAPHEE.GET_PROJ_END(MM017.MANDT,MAX(MM017.MPOSID) ),'') AS P_END
  , CASE WHEN SUBSTR(MM017.POSID,7,2) IN  ('NB','NS','NC') THEN 'N' ELSE 'Y' END  AS MISU_GUBN
  , CASE WHEN (MAX(MM017.WERKS) = '2000' AND MAX(MM017.LGORT) = '9500') THEN SAPHEE.GET_BOSU_LGORT(MM017.MANDT,MIN(MM017.EBELN),MIN(MM017.EBELP))
         ELSE '' END AS BOSU_LGORT
FROM (
	SELECT 
                  MM017B.MANDT AS MANDT
	  , MM017B.CHAR1 AS CHAR1
	  , MM017B.INVNR AS INVNR
	  , MM017B.INVITEM AS INVITEM
	  , MM017B.INS_Q AS INS_Q
	  , MM017B.MATNR AS MATNR
	  , (MM011.MATNR_NM ||','|| MM011.ZSIZE ||','|| MM011.SPEC) AS MAKTX
	  , MM017B.MENGE AS MENGE
	  , MM017B.B_MENGE AS B_MENGE
	  , MM017B.MEINS AS MEINS
	  , MM017B.EKGRP AS EKGRP
	  , (SELECT CTEXT2 FROM SAPHEE.ZLCODE WHERE MANDT = #G_MANDT# AND LANG = #G_LANG#  
	                  AND CODE1 = '10' AND CODE2 = MM017B.EKGRP ) AS EKGRP1
	  , MM017B.EBELN AS EBELN
                , MM017B.EBELP AS EBELP
	  , MM017B.WERKS AS WERKS
                , MM017B.LGORT AS LGORT
	  , MM017B.NAME1 AS NAME1
	  , MM017B.MBLNR AS MBLNR
	  , MM017B.NETPR AS NETPR
	  , MM017B.WAERS AS WAERS
	  , MM017B.STO_MBLNR AS STO_MBLNR
	  , CASE WHEN MM017B.STO_MBLNR > '' THEN '5' ELSE MM017B.PRO_F END AS PRO_F
	  , CASE WHEN SUBSTR(MM017B.POSID,1,2) = 'QM' THEN SUBSTR(MM017B.POSID,1,8)
	             WHEN SUBSTR(MM017B.POSID,1,1) = 'Q' THEN SUBSTR(MM017B.POSID,1,7)
                        ELSE SUBSTR(MM017B.POSID,1,6) END AS POSID
	  , CASE WHEN SUBSTR(MM017B.POSID,1,2) = 'QM' THEN SUBSTR(MM017B.POSID,9,1)
	             WHEN SUBSTR(MM017B.POSID,1,1) = 'Q' THEN SUBSTR(MM017B.POSID,8,1)
                        ELSE SUBSTR(MM017B.POSID,7,1) END AS POSGBN
	  , MM017B.POSID AS MPOSID
	  , MM017B.POST1 AS POST1
	  , MM017B.RDATE_P AS RDATE_P
	  , MM017B.RECE_DATE AS RECE_DATE
	  , MM017B.RECE_TIME AS RECE_TIME
	  , MM017B.DEL_DATE AS DEL_DATE
	  , MM017B.DEL_TIME AS DEL_TIME
	  , MM017B.BUDAT AS BUDAT
	  , MM017B.IN_DT AS IN_DT
	  , MM017B.IN_TM AS IN_TM
	  , MM017B.CA_DT AS CA_DT
	  , MM017B.CA_TM AS CA_TM
	  , MM017B.UDATE AS UDATE
	  , MM017B.DDATE AS DDATE
	  , MM017B.POTYPE AS POTYPE
	  , (SELECT DISTINCT MM011.BISMT FROM SAPHEE.ZMMT011 AS MM011 
                          WHERE MM011.MANDT= #G_MANDT# 
                             AND MM011.MATNR = MM017B.MATNR )AS BISMT
	  , CASE WHEN MM017B.QM_CHK ='X' THEN '1' ELSE '0' END AS QM_CHK
	  , MM011.BLOCK_NO AS BLOCK_NO
	  , CASE WHEN MM017B.WERKS <> '2000' AND SAPHEE.GET_JAJEA_BALJU(MM017B.MANDT, MM017B.POSID,MM017B.MATNR) < 0 THEN '1' ELSE '0' END   AS BIGO
-- ,'0' AS BIGO

	  , MM017B.EXTWG AS EXTWG
	  , MM017B.BOX_CK AS BOX_CK

	 FROM SAPHEE.ZMMT017_M AS MM017B
	 LEFT OUTER JOIN SAPHEE.ZMMT011 AS MM011 ON MM017B.MANDT = MM011.MANDT 
	            AND MM017B.MATNR = MM011.MATNR 
	 WHERE MM017B.MANDT = #G_MANDT#
	    AND MM017B.LIFNR = #LIFNR#
	    AND MM017B.DDATE = '00000000'
	    AND MM017B.EBELN = #EBELN#
	    AND MM017B.POTYPE = ''
) AS MM017 

 LEFT OUTER JOIN SAPHEE.ZMMT011 AS MM011 ON MM017.MANDT = MM011.MANDT 
                     AND MM017.MATNR = MM011.MATNR 

 LEFT OUTER JOIN SAPHEE.ZMMT026 AS MM026 ON  MM011.MANDT = MM026.MANDT
                     AND MM011.EXTWG = MM026.BOXNO
 LEFT OUTER JOIN SAPHEE.ZMMT025 AS MM025 ON  MM017.MANDT = MM025.MANDT
                                         AND SUBSTR(MM017.MPOSID,1,9) = MM025.POSID
                                         AND MM025.PSTYPE = '02'
LEFT OUTER JOIN SAPHEE.ZPPT027 AS PP027 ON MM017.MANDT = PP027.MANDT
                                                                   AND MM017.MPOSID = PP027.POSID
                                                                   AND PP027.ACTIV = '05'
                                                                   AND PP027.BLOCK = 'A'
                                                                   AND PP027.GUBUN = '01'
                                                                   
-- LEFT OUTER JOIN SAPHEE.PRPS AS PR ON MM017.MANDT = PR.MANDT
--                                        AND MM017.MPOSID = PR.POSID
WHERE 1=1
  GROUP BY MM017.MANDT,MM017.INVNR,MM017.POSID,MM017.UDATE,MM017.MATNR,MM017.NETPR
  ORDER BY INVNR,POSID
  FOR FETCH ONLY
  WITH UR	]]></statement>
	<input default-name="ds_cond">
		<col name="G_MANDT" size="255" type="VARCHAR" description="" /> 
		<col name="LIFNR" size="255" type="VARCHAR" description="" /> 
		<col name="EBELN" size="255" type="VARCHAR" description="" /> 
	</input>
	<output default-name="ds_list">
	</output>
</query>
