<?xml version="1.0" encoding="euc-kr"?>
<query dynamic="true">
	<type>select</type>
	<description><![CDATA[호기별 청구이력 - HOST 조회]]></description>
	<reload>true</reload>
	<monitoring>true</monitoring>
	<result-count>0</result-count>
	<statement>
WITH CS AS (
SELECT 
     CEBWAUPN AS UPN
   , CEBWACST AS CST
   , CEBSASPT AS NAM
   , CEBWAPJT|| CEBWAHGB|| CEBWAHNO AS PJT
   , CEBWAHGB|| CEBWAHNO AS HNO
   , CEBSBHNA AS HNA
   , CEBWAPJT
  FROM EVLADM.TBEBWAF1
     LEFT OUTER JOIN EVLADM.TBEBSAF1 ON CEBSAPJT = CEBWAUPN
	 LEFT OUTER JOIN EVLADM.TBEBSBF1 ON CEBSBPJT = CEBWAPJT
	    AND CEBSBHGB = CEBWAHGB
		AND CEBSBHNO = CEBWAHNO
  WHERE CEBWAUPN = #UPN#
<isNotNull col="CST">
     AND CEBWACST = #CST#
</isNotNull>	          

)	


SELECT  
   UPN   
 , MAX(CST) AS CST   
 , MAX(NAM) AS NAM   
 , PJT 
 , HNO
 , HNA   
 , MAX(CASE WHEN YEAR = CAST(#YEAR# AS CHARACTER(4)) THEN DATE ELSE '' END)  AS Y01
 , MAX(CASE WHEN YEAR = CAST((CAST(#YEAR# AS INTEGER) -1) AS CHARACTER(4))  THEN DATE ELSE '' END) Y02
 , MAX(CASE WHEN YEAR = CAST((CAST(#YEAR# AS INTEGER) -2) AS CHARACTER(4))  THEN DATE ELSE '' END) Y03
 , MAX(CASE WHEN YEAR = CAST((CAST(#YEAR# AS INTEGER) -3) AS CHARACTER(4))  THEN DATE ELSE '' END) Y04
 , MAX(CASE WHEN YEAR = CAST((CAST(#YEAR# AS INTEGER) -4) AS CHARACTER(4))  THEN DATE ELSE '' END) Y05
 , MAX(CASE WHEN YEAR = CAST((CAST(#YEAR# AS INTEGER) -5) AS CHARACTER(4))  THEN DATE ELSE '' END) Y06
 , MAX(CASE WHEN YEAR = CAST((CAST(#YEAR# AS INTEGER) -6) AS CHARACTER(4))  THEN DATE ELSE '' END) Y07
 , MAX(CASE WHEN YEAR = CAST((CAST(#YEAR# AS INTEGER) -7) AS CHARACTER(4))  THEN DATE ELSE '' END) Y08
 , MAX(CASE WHEN YEAR = CAST((CAST(#YEAR# AS INTEGER) -8) AS CHARACTER(4))  THEN DATE ELSE '' END) Y09
 , MAX(CASE WHEN YEAR = CAST((CAST(#YEAR# AS INTEGER) -9) AS CHARACTER(4))  THEN DATE ELSE '' END) Y10
 , '2' AS G01
 , '2' AS G02
 , '2' AS G03
 , '2' AS G04
 , '2' AS G05
 , '2' AS G06
 , '2' AS G07
 , '2' AS G08
 , '2' AS G09
 , '2' AS G10
 FROM (
   SELECT
      CS.UPN AS UPN
	, CS.CST AS CST
	, CS.NAM AS NAM
	, CS.HNO AS HNO
	, CS.HNA AS HNA
    , CS.PJT  AS PJT
    , M31.YEAR AS YEAR
    , M31.DATE AS DATE
  FROM CS 
    LEFT OUTER JOIN (
	   SELECT 
           CEBSTPJT || CEBSTHGB || CEBSTHNO AS PJT
         , SUBSTR(CEBSSRQD,1,4) AS YEAR
         , MAX(SUBSTR(CEBSSRQD,5)) AS DATE
        FROM EVLADM.TBEBSTF1
		   LEFT OUTER JOIN EVLADM.TBEBSSF1 ON CEBSTCOD = CEBSSCOD
              AND CEBSTDNO = CEBSSDNO
	    WHERE   CEBSTPJT || CEBSTHGB || CEBSTHNO IN ( SELECT PJT FROM CS)
              AND CEBSSRQD BETWEEN CAST((CAST(#YEAR# AS INTEGER) -9) AS CHARACTER(4)) ||'0101' AND CAST(#YEAR# AS CHARACTER(4)) ||'1231'
	          AND CEBSTITN LIKE #ITN# || '%'
<isNotNull col="ATYPE">
	          AND CEBSTHGB = #ATYPE#
</isNotNull>	   
	          GROUP BY CEBSTPJT||CEBSTHGB||CEBSTHNO, SUBSTR(CEBSSRQD,1,4)
   ) AS M31 ON  M31.PJT = CS.PJT
) AS T WHERE 1=1
GROUP BY   UPN,PJT,HNO,HNA
ORDER BY UPN,CST,PJT
FOR FETCH ONLY
WITH UR	</statement>
	<input default-name="ds_cond1">
	</input>
	<output default-name="ds_list1">
	</output>
</query>
