<?xml version="1.0" encoding="euc-kr"?>
<query dynamic="true">
	<type>select</type>
	<description><![CDATA[]]></description>
	<reload>true</reload>
	<monitoring>true</monitoring>
	<result-count>1</result-count>
	<statement>
SELECT  DISTINCT
        T.MANDT
       ,T.POSID
       ,T.ZSITE_NM
       ,T.VDATU
       ,T.CONTR_DA
       ,T.ZQNTY
       ,T.KUNNR_NM
       ,T2.NAME1 AS JKUNNR
       --,T.ADDR
       ,CASE WHEN SUBSTR(T.POSID,1,1) = 'E' OR SUBSTR(T.POSID,1,1) = 'T' OR SUBSTR(T.POSID,1,1) = 'C'
	             THEN (SELECT (SELECT Y.LANDX
                                                       FROM SAPHEE.T005T AS Y
			           WHERE Y.MANDT = Z.MANDT AND Y.SPRAS = '3' AND Y.LAND1 = Z.LAND1)
                                         FROM SAPHEE.VBPA AS Z
		           WHERE Z.MANDT = T.MANDT
		           
			 AND Z.VBELN = T.POSID
                                           AND Z.POSNR = '000000'
			 AND Z.PARVW = 'WE' )
	    ELSE T.ADDR
         END AS ADDR
        ,T.G_ADDR
        ,T.G_LAT
        ,T.G_LNG
        ,T.G_MEMO
       ,T.ADDR2
       ,T.TEXT30
       ,T.VALUE
       ,T.ZSITE_TEL
       ,T.ZTEL
       ,T.ZMAN
       , (SELECT Z.USERMAIL  FROM SAPHEE.ZUSERF AS Z WHERE Z.MANDT = T.MANDT AND  Z.USERNUMB = SUBSTR(T.ZMAN,2,8)) AS ZMAIL
       ,T.ZMAN_NM
       , T3.NAME1    AS ZMMAN
       , T3.USERMBPN AS ZMTEL
       , T3.USERMAIL
       ,T.CDATE
	     ,CASE WHEN T.LIFNRCHK = '1' THEN '직발주' WHEN T.LIFNRCHK ='2' THEN '공동수급' WHEN T.LIFNRCHK ='3' THEN '공동수급(표준)' WHEN T.LIFNRCHK ='4' THEN '공동수급(비표준)' ELSE '' END AS LIFNRCHK
	     ,CASE T.LIFNRCHK WHEN '1' THEN CASE GUBUN WHEN '0' THEN '미입력' WHEN '1' THEN '완료' WHEN '2' THEN '미완료' WHEN '3' THEN '거부' ELSE '' END
	                      WHEN '2' THEN CASE GUBUN WHEN '0' THEN '미입력' WHEN '1' THEN '동일업체투입' WHEN '2' THEN '미완료'  WHEN '3' THEN '승인불가'  WHEN '4' THEN '추가약정완료'  WHEN '5' THEN '변경합의서승인' ELSE '' END
						  ELSE '' END AS GUBUN
      ,VALUE(T1.NAME1,'') AS NAME1
      ,VALUE(T1.STRAS,'') AS STRAS
      ,VALUE(T1.STRAS2,'') AS STRAS2
      ,VALUE(T1.USERMAIL,'') AS STMAIL
      ,CASE WHEN T1.TURNKEY = '1' THEN '일반공사' WHEN T1.TURNKEY = '2' THEN '주공, SH, 관납공사' ELSE '' END AS TURNKEY
      ,VALUE((SELECT ENFOR 
          FROM SAPHEE.VBAK 
         WHERE MANDT=T.MANDT 
           AND ZZPJT_ID = T.POSID
         FETCH FIRST 1 ROWS ONLY
         WITH UR),'') AS ENFOR
      ,VALUE((SELECT S.STEXT FROM SAPHEE.VBAK V, SAPHEE.ZV_SDT0008 S WHERE V.MANDT=T.MANDT AND V.ZZPJT_ID = T.POSID AND V.MANDT = S.MANDT AND V.WWBLD = S.WWBLD FETCH FIRST 1 ROWS ONLY),'') AS STEXT
      ,VALUE((SELECT C.LIFNR FROM SAPHEE.VBAK AS A INNER JOIN SAPHEE.VBPA AS C ON A.MANDT = C.MANDT AND A.VBELN = C.VBELN AND C.PARVW = 'Z1' WHERE A.MANDT = T.MANDT AND A.ZZPJT_ID = T.POSID FETCH FIRST 1 ROWS ONLY),'') AS ZLIFNR
      --,T.P_END      -- 마감현장 조회
 	  ,'' AS PRDUSERNAME --T.PRDUSERNAME : 생산관리자
	  , VALUE((SELECT Z.USERTELE  FROM SAPHEE.ZUSERF AS Z WHERE Z.MANDT = T.MANDT AND  Z.USERNUMB = T.PRDUSERID FETCH FIRST 1 ROWS ONLY),'') AS USERTELE -- 생산관리자 TEL
	  , VALUE(ZPM07.ZTEL,'') AS ZSITE_TEL_NEW
	  , VALUE(ZCS01.CS_TEL,'') AS CS_TEL
	  , CASE WHEN T1.NETWR > 12000000000
	         THEN '120억 이상'
	         WHEN T1.NETWR > 2000000000
	         THEN '20억 이상 120억 미만'
	         WHEN T1.NETWR > 300000000
	         THEN '3억원이상 20억미만'
	         WHEN T1.NETWR > 200000000
	         THEN '2억 이상 3억 미만'
	         WHEN T1.NETWR > 100000000
	         THEN '1억 이상 2억 미만'
	         ELSE '1억미만'
	         END AS CONTR_PR
	   , T1.NETWR
	   , VALUE((SELECT DECODE(VIPTP,'X','Yes','No') 
			     FROM SAPHEE.VBAK 
			    WHERE MANDT=T.MANDT AND ZZPJT_ID = T.POSID),'No') AS VIPTP
	   , (SELECT X.CS301_ZMAN
		   FROM SAPHEE.ZCST301 AS X
		  WHERE X.MANDT = '183'
		    AND X.CS301_PJT = T.POSID
		    AND X.CS301_PST = 'A6'
		  ORDER BY X.CS301_RDT DESC, X.CS301_SEQ DESC
		   FETCH FIRST 1 ROW ONLY
		   WITH UR) AS CS301_ZMAN
	   , ZCS02.HB_FROM
	   , ZCS02.HB_TO
	   , (
	   		SELECT X.NAMET
	   		  FROM SAPHEE.ZMASTER02 AS X
	   		 WHERE X.MANDT = #G_MANDT#
	   		   AND X.POSID = T.POSID
	   		 ORDER BY X.POSID_1
	   		 FETCH FIRST 1 ROW ONLY
	     ) AS NAMET
	   , (
	   		SELECT X2.CELLP
	   		  FROM SAPHEE.ZMASTER02 AS X
	   		  LEFT OUTER JOIN SAPHEE.ZPST0011 AS X2
	   		               ON X2.MANDT = X.MANDT
	   		              AND X2.TEMNO = X.TEMNO
	   		 WHERE X.MANDT = #G_MANDT#
	   		   AND X.POSID = T.POSID
	   		 ORDER BY X.POSID_1
	   		 FETCH FIRST 1 ROW ONLY
	     ) AS PM_TEL
	   , VALUE(T1.YK_MG_NM, '') AS YK_MG_NM
       , VALUE(T1.YK_MG_MAIL, '') AS YK_MG_MAIL
       , VALUE(T1.YK_MG_MBPN, '') AS YK_MG_MBPN
FROM (
        SELECT  DISTINCT
                MASTER01A.MANDT
               ,MASTER01A.POSID
               ,MASTER01A.ZSITE_NM
               ,MASTER01A.VDATU
               ,MASTER01A.CONTR_DA
               ,MASTER01A.ZQNTY
               ,MASTER01A.KUNNR_NM
               ,MASTER01A.ADDR1 || ' ' || MASTER01A.ADDR2 AS ADDR
               ,VALUE((SELECT E.CS121_P1C || ' ' || E.CS121_P2C FROM SAPHEE.ZCST121 AS E WHERE MASTER01A.MANDT = E.MANDT AND MASTER01A.POSID = E.CS121_UPN AND E.CS121_CST= '' FETCH FIRST 1 ROWS ONLY),'') AS ADDR2
               ,VALUE((SELECT P.PRDUSERNAME FROM SAPHEE.ZPPT150  AS P WHERE MASTER01A.MANDT = P.MANDT AND MASTER01A.ZZACTSS = P.J_1AACT FETCH FIRST 1 ROWS ONLY),'') AS PRDUSERNAME
               ,VALUE((SELECT P.PRDUSERID FROM SAPHEE.ZPPT150  AS P WHERE MASTER01A.MANDT = P.MANDT AND MASTER01A.ZZACTSS = P.J_1AACT FETCH FIRST 1 ROWS ONLY),'') AS PRDUSERID
               ,VALUE((
               		SELECT X.TEXT30
               		  FROM SAPHEE.J_1AACTT AS X
               		 WHERE X.MANDT   = MASTER01A.MANDT
               		   AND X.J_1AACT = MASTER01A.ZZACTSS
               		   AND X.SPRAS   = '3'
               		 FETCH FIRST 1 ROWS ONLY
                ),'') AS TEXT30
               ,MASTER02B.VALUE
               ,MASTER01A.ZSITE_TEL
               ,MASTER01A.ZTEL
               ,MASTER01A.ZMAN
               ,MASTER01A.ZMAN_NM
               ,MASTER01A.CDATE
               ,VALUE((SELECT LIFNRCHK FROM SAPHEE.VBAK AS A WHERE A.MANDT = MASTER01A.MANDT AND ZZPJT_ID = MASTER01A.POSID FETCH FIRST 1 ROWS ONLY),'') AS LIFNRCHK
               ,CASE VALUE((SELECT LIFNRCHK FROM SAPHEE.VBAK AS A WHERE A.MANDT = MASTER01A.MANDT AND ZZPJT_ID = MASTER01A.POSID FETCH FIRST 1 ROWS ONLY),'')
                   WHEN '1' THEN VALUE((SELECT GUBUN1 FROM SAPHEE.ZPST0033 AS A WHERE A.MANDT  = MASTER01A.MANDT AND A.PSPID = MASTER01A.POSID FETCH FIRST 1 ROWS ONLY),'')
                   WHEN '2' THEN VALUE((SELECT GUBUN1 FROM SAPHEE.ZPST0030 AS A WHERE A.MANDT  = MASTER01A.MANDT AND A.PSPID = MASTER01A.POSID FETCH FIRST 1 ROWS ONLY),'')
                   ELSE '' END AS GUBUN
               -- , (CASE  WHEN MASTER02C.TXT04 > '' AND SUBSTR(MASTER02C.TXT04,1,1) &lt;&gt; 'I' AND RTRIM(MASTER02C.TXT04) NOT IN ('P','R4','R5','R6')
               --         THEN 'CODE : '||MASTER02C.TXT04 ||'  사유: ' || MASTER02C.TXT30 ELSE '' END) AS P_END  -- 마감현장 조회
                , MASTER01A.G_ADDR
                , MASTER01A.G_LAT
                , MASTER01A.G_LNG
                , MASTER01A.G_MEMO
        FROM  SAPHEE.ZMASTER01 AS MASTER01A
        	  LEFT OUTER JOIN
        	  ( SELECT  SD.MANDT
        	           ,SD.POSID
        	           ,SUM(SD.VALUE) AS VALUE
                FROM  (
                       SELECT  MASTER02A.MANDT
            	                ,MASTER02A.POSID
            	   		          ,ROWNUMBER() OVER(PARTITION BY SD0005.HOGI  ORDER BY SD0005.HOGI , SD0005.SEQ DESC ) AS RN
                              ,(CASE WHEN VALUE(SD0005.VALUE,'0') = '' THEN 0 ELSE  INT(VALUE(SD0005.VALUE,'0')) END) AS VALUE
                       FROM  SAPHEE.ZSDT0005 AS SD0005
            	   	          ,SAPHEE.ZMASTER02 MASTER02A
                       WHERE SD0005.MANDT = MASTER02A.MANDT
        		           AND MASTER02A.MANDT = #G_MANDT#
        		           AND MASTER02A.POSID = #POSID#
                       AND MASTER02A.ZZGUBUN IN ('10','13')        -- 제품구분(10:EL,13:EL선박)
                       AND MASTER02A.PRART IN ('01','11')          -- 프로젝트유형(01:승강기(국내),11:교체공사)
                       AND SD0005.HOGI = MASTER02A.POSID_1
                       AND SD0005.CHARACTERISTIC = 'EL_ASTQ'    -- 정지층수
                      ) AS SD
                WHERE SD.RN = 1
                GROUP BY SD.MANDT,SD.POSID
             ) AS MASTER02B
        	 ON MASTER01A.MANDT = MASTER02B.MANDT
             AND MASTER01A.POSID = MASTER02B.POSID
         WHERE MASTER01A.MANDT = #G_MANDT#
           AND MASTER01A.POSID = #POSID#
           
      --  	 ,SAPHEE.ZMASTER02 AS MASTER02C
      --  WHERE MASTER01A.MANDT = #G_MANDT#
      --  AND MASTER01A.POSID = #POSID#
      --  	 AND MASTER01A.MANDT = MASTER02C.MANDT
      --       AND MASTER01A.POSID = MASTER02C.POSID
    ) AS T
      LEFT OUTER JOIN	(
       SELECT A.MANDT
             , A.POSID
             , D.NAME1
             , D.STRAS
             , D.NAME1||'('|| D.STRAS||')' AS STRAS2
             , B.TURNKEY
             , CASE WHEN B.WAERK = 'KRW' OR B.WAERK = 'JPY'
                    THEN CAST(B.NETWR AS DECIMAL(13, 2)) * 100 * 1.1
                    ELSE CAST(B.NETWR AS DECIMAL(13, 2)) * 1.1
                    END AS NETWR
             , E.USERMAIL
             , G.USERNAME AS YK_MG_NM
             , G.USERMAIL AS YK_MG_MAIL
             , G.USERMBPN AS YK_MG_MBPN
         FROM SAPHEE.ZMASTER01 AS A
              INNER JOIN SAPHEE.VBAK AS B ON A.MANDT = B.MANDT AND A.POSID = B.ZZPJT_ID
              INNER JOIN SAPHEE.VBPA AS C ON B.MANDT = C.MANDT AND B.VBELN = C.VBELN AND C.PARVW = 'Z3'
              INNER JOIN SAPHEE.KNA1 AS D ON C.MANDT= D.MANDT AND C.KUNNR = D.KUNNR
              LEFT OUTER JOIN SAPHEE.ZUSERF AS E ON E.MANDT = D.MANDT AND E.USERNUMB = SUBSTR(D.KUNNR,2,7)
              LEFT OUTER JOIN SAPHEE.ZSDT1167 AS F ON F.MANDT = C.MANDT AND F.KUNZ3 = C.KUNNR AND C.VBELN = A.POSID AND C.PARVW = 'Z3'
              LEFT OUTER JOIN SAPHEE.ZUSERF AS G ON G.MANDT = F.MANDT AND G.USERNUMB = SUBSTR(F.PSNO,2,8)
         WHERE A.MANDT = #G_MANDT#
           AND A.POSID = #POSID#
	  FETCH FIRST 1 ROWS ONLY WITH UR
	) AS T1 ON T.MANDT = T1.MANDT AND T.POSID = T1.POSID

 LEFT OUTER JOIN	(   SELECT A.MANDT,A.POSID,D.NAME1
					      FROM   SAPHEE.ZMASTER01 AS A
					      INNER JOIN SAPHEE.VBAK AS B ON A.MANDT = B.MANDT AND A.POSID = B.ZZPJT_ID
					      INNER JOIN SAPHEE.VBPA AS C ON B.MANDT = C.MANDT AND B.VBELN = C.VBELN AND C.PARVW = 'RG' AND C.POSNR = '000000'
					      INNER JOIN SAPHEE.KNA1 AS D ON C.MANDT= D.MANDT AND C.KUNNR = D.KUNNR
					      WHERE A.MANDT = #G_MANDT#
					      AND   A.POSID =  #POSID#
						  FETCH FIRST 1 ROWS ONLY
					) AS T2 ON T.MANDT = T2.MANDT AND T.POSID = T2.POSID
 LEFT OUTER JOIN
 (
 	  SELECT VBAK.MANDT, VBAK.ZZPJT_ID, KNA1.NAME1, ZUSERF.USERMAIL, ZUSERF.USERMBPN
		FROM SAPHEE.VBAK AS VBAK
		  INNER JOIN SAPHEE.VBPA AS VBPA
		      ON VBAK.MANDT=VBPA.MANDT
		       AND VBAK.VBELN=VBPA.VBELN
		       AND VBPA.POSNR='000000'
		       AND VBPA.PARVW='Z2'
		LEFT JOIN SAPHEE.ZSDT0149 AS Z149
		       ON VBPA.MANDT=Z149.MANDT
		        AND VBPA.KUNNR=Z149.DEALER
		     AND Z149.SDFIELD = (CASE VBAK.SPART WHEN '20' THEN 'PRK' ELSE (CASE SUBSTR(VBAK.AUART,1,2) WHEN 'ZN' THEN 'REM' ELSE 'NI' END)   END)
		LEFT JOIN SAPHEE.KNA1 AS KNA1
		      ON Z149.MANDT=KNA1.MANDT
		    AND Z149.MANAGER=KNA1.KUNNR
		LEFT JOIN SAPHEE.ZUSERF AS ZUSERF
		       ON KNA1.MANDT=ZUSERF.MANDT
		        AND KNA1.KUNNR='H'||ZUSERF.USERNUMB

		WHERE VBAK.MANDT    = #G_MANDT#
		  AND VBAK.ZZPJT_ID = #POSID#
		FETCH FIRST 1 ROWS ONLY
 ) AS T3 ON T.MANDT = T3.MANDT AND T.POSID = T3.ZZPJT_ID
 LEFT OUTER JOIN SAPHEE.ZPSTPM07 AS ZPM07
              ON T.MANDT = ZPM07.MANDT
             AND T.POSID = ZPM07.POSID
 LEFT OUTER JOIN SAPHEE.ZPSTCS01 AS ZCS01
              ON T.MANDT = ZCS01.MANDT
             AND T.POSID = ZCS01.POSID
 LEFT OUTER JOIN SAPHEE.ZPSTCS02 AS ZCS02
              ON T.MANDT = ZCS02.MANDT
             AND T.POSID = ZCS02.POSID

FOR FETCH ONLY
WITH UR	</statement>
	<input default-name="ds_cond">

	</input>
	<output default-name="ds_head">

	</output>
</query>
