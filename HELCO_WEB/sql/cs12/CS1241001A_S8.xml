<?xml version="1.0" encoding="euc-kr"?>
<query dynamic="true">
	<type>select</type>
	<description><![CDATA[]]></description>
	<reload>true</reload>
	<monitoring>true</monitoring>
	<result-count>1</result-count>
	<statement>


SELECT
	A.ISD
	,A.AGEK
	,A.PJT
	,A.HNO
	,A.VKGRP
	,A.ZSPEC2
	,A.ZSPEC12
	,A.ZSPEC3
	,A.ZSPEC7
	,A.ABG
	,A.BLD
	,A.GBU
	,A.CNT
	,A.USD
	,A.AMT
	,A.HMT
	,A.DMT
	,A.HEP
	,A.KND
	,A.DND
	,A.HWR
	,A.HFR
	,A.ACD_N
	,A.UMS
	,A.GYN
	,A.CNT_A
	,LPAD(A.CNT_A,2,'0') AS CS507_GUBUN
	,A.CND
	,CASE WHEN A.CND = 'A' THEN '1'
	WHEN A.CND = 'B' THEN '2'
	WHEN A.CND = 'C' THEN '4'
	END AS GKD
	,A.FAT
	,A.PAT
	,A.GKD_B
	,A.KND_B
	,A.TOT_B
	,A.AMG
	,A.AMG_TO2
	,A.ACMT -- 공기청정기 추가 20200515 Han.JH
	,A.ACND -- 공기청정기 종류 20200618 Han.JH
	,A.PRE_AMT -- 이전 계약단가
	,A.AMT_TOT -- 현재 계약단가
	,'' AS SRG
	,'' AS SRG_CD
	,'' AS SEG
	,'' AS SEG_CD
	,'' AS STO
	,'' AS F1
	,'' AS F2
	,'' AS F3
	,'' AS F4
	,'' AS F5
	,'' AS F6
	,'' AS F7
	,'' AS F8
	,'' AS F9
	,'' AS F10
	,'' AS P1
	,'' AS P2
	,'' AS P3
	,'' AS P4
	,'' AS P5
	,'' AS P6
	,'' AS P7
	,'' AS P8
	,'' AS P9
	,'' AS P10
	,'' AS STD1
	,'' AS STD2
	,'' AS STD3
	,'' AS STD4
	,'' AS STD5
	,'' AS STD6
	,'' AS STD7
	,'' AS ITEM1
	,'' AS ITEM2
	,'' AS ITEM3
	,'' AS ITEM4
	,'' AS ITEM5
	,'' AS ITEM6
	,'' AS ITEM7
	,'' AS ITEM8
	,'' AS ITEM9
	,'' AS CS512_RAT
	FROM(
	SELECT
	C.CS101_ISD AS ISD
	,SAPHEE.get_days(DECODE(C.CS101_ISD,'','19991231',C.CS101_ISD),A.CS302_USD)/365
	AS AGEK
	,B.PJT AS PJT
	,B.HNO AS HNO
	,E.VKGRP AS VKGRP
	,D.ZSPEC2 AS ZSPEC2
	,D.ZSPEC12 AS ZSPEC12
	,D.ZSPEC3 AS ZSPEC3
	,D.ZSPEC7 AS ZSPEC7
	,B.ABG AS ABG
	,B.BLD AS BLD
	,B.GBU AS GBU
	,(SELECT COUNT(*) FROM SAPHEE.ZMASTER02 WHERE MANDT = A.MANDT AND POSID =
	A.CS302_PJT AND SUBSTR(POSID_1,7,1) IN ('L','S','W'))AS CNT

	,A.CS301_CND AS CND
	,A.CS302_USD AS USD
	,A.CS302_AMT AS AMT
	,A.CS302_HMT AS HMT
	,A.CS302_DMT AS DMT
	,A.CS302_FAT AS FAT
	,A.CS302_PAT AS PAT
	,A.CS302_HEP AS HEP
	,A.CS302_KND AS KND
	,A.CS302_DND AS DND
	,A.CS302_HWR AS HWR -- 유무선
	,A.CS302_HFR AS HFR -- HRTS 무상
	,A.CS311_AMG AS AMG
	,A.CS311_TO2 AS AMG_TO2
	,(
	SELECT
	VALUE(MAX(VALUE),'')
	FROM
	SAPHEE.ZSDT0005
	WHERE
	MANDT = A.MANDT
	AND HOGI = A.CS302_PJT || A.CS302_HNO
	AND CHARACTERISTIC = 'EL_ACD2'
	) AS ACD_N

	-- ,SAPHEE.MONTH_BETWEEN(A.CS302_RGS,A.CS302_RMR,2) AS UMS
	,CS301_CDY AS UMS
	,VALUE((SELECT CASE WHEN F.POSID IS NOT NULL THEN 'Y' ELSE 'N' END GYN
	FROM SAPHEE.ZMASTER02 AS F
	WHERE MANDT = #G_MANDT#
	AND SUBSTR(POSID_1,7,1) = 'T'
	AND POSID = A.CS302_PJT
	GROUP BY MANDT, POSID),'N') AS GYN
	,COUNT(A.MANDT) OVER() AS CNT_A
	--종전계약정보
	,VALUE(F.GKD,'') AS GKD_B
	,VALUE(F.KND,'') AS KND_B
	,VALUE(F.TOT, 0) AS TOT_B
	,A.CS302_ACMT AS ACMT -- 공기청정기 추가 20200515 Han.JH
	,A.CS302_ACND AS ACND -- 공기청정기 종류
	,(SELECT
	CS126_AMT + CS126_AMBT + CS126_HMT + CS126_DMT + CS126_ACMT
	FROM SAPHEE.ZCST126
	WHERE MANDT = #G_MANDT#
	AND CS126_DDT = ''
	AND CS126_PST = 'A6'
	AND CS126_GND = 'D'
	AND CS126_PJT = A.CS302_PJT
	AND CS126_HNO = A.CS302_HNO
	AND CS126_USD &lt; A.CS301_STD
	ORDER BY CS126_USD DESC
	FETCH FIRST 1 ROW ONLY ) AS PRE_AMT -- 이전 계약단가
	,VALUE(AMT_TOT,0) AS AMT_TOT -- 현재 계약단가
	FROM ( SELECT
	B.CS302_PJT
	,B.CS302_HNO
	,A.CS301_CDT AS CS302_USD
	,A.CS301_CDY
	,CASE WHEN A.CS301_CPD = 'A' THEN A.CS301_CPD ELSE '' END AS CS302_KND
	,CASE WHEN A.CS301_CPD = 'A' THEN B.CS302_FMT + VALUE(B.CS302_FMBT,0) ELSE
	B.CS302_PMT + VALUE(B.CS302_PMBT,0) END AS CS302_AMT
	,B.CS302_HMT
	,B.CS302_DMT
	,CASE WHEN A.CS301_PRD = 'A' THEN '01'
	WHEN A.CS301_PRD = 'B' THEN '02'
	WHEN A.CS301_PRD = 'C' THEN '03'
	ELSE '' END AS CS302_HEP
	,B.CS302_HWR
	,B.CS302_HFR
	,B.CS302_DND
	,A.MANDT
	,B.CS302_FAT
	,B.CS302_PAT
	,A.CS301_CND
	,VALUE(C.CS311_AMG,'N') AS CS311_AMG
	,VALUE(C.CS311_TO2,0) AS CS311_TO2 -- 자재 원가
	,B.CS302_ACMT -- 공기청정기 추가 20200515 Han.JH
	,B.CS302_ACND -- 공기청정기 종류
	,A.CS301_STD -- 견적 개시일
	,VALUE(B.CS302_FMT,0) + VALUE(B.CS302_FMBT,0) + VALUE(B.CS302_PMT,0) + VALUE(B.CS302_PMBT,0)
	+ VALUE(CS302_HMT,0) + VALUE(CS302_DMT,0) + VALUE(CS302_ACMT,0) AS
	AMT_TOT -- 현재 계약단가

	FROM SAPHEE.ZCST301 AS A INNER JOIN SAPHEE.ZCST302 AS B
	ON A.MANDT = B.MANDT
	AND A.CS301_TEM = B.CS302_TEM
	AND A.CS301_RDT = B.CS302_RDT
	AND A.CS301_SEQ = B.CS302_SEQ
	AND A.CS301_SIR = B.CS302_SIR

	LEFT OUTER JOIN SAPHEE.ZCST311 AS C
	ON A.MANDT = C.MANDT
	AND A.CS301_TEM = C.CS311_TEM
	AND A.CS301_RDT = C.CS311_RDT
	AND A.CS301_SEQ = C.CS311_SEQ
	AND A.CS301_SIR = C.CS311_SIR
	WHERE A.MANDT = #G_MANDT#
	AND A.CS301_TEM = #TEM#
	AND A.CS301_RDT = #RDT#
	AND A.CS301_SEQ = #SEQ#
	AND A.CS301_SIR = #SIR#

	) AS A INNER JOIN SAPHEE.ZCST111 AS B
	ON B.MANDT = A.MANDT
	AND B.PJT = A.CS302_PJT
	AND B.HNO = A.CS302_HNO

	LEFT OUTER JOIN SAPHEE.ZCST101 AS C
	ON C.MANDT = A.MANDT
	AND C.CS101_PJT = A.CS302_PJT
	AND C.CS101_HNO = A.CS302_HNO

	LEFT OUTER JOIN SAPHEE.ZMASTER02 AS D
	ON D.MANDT = A.MANDT
	AND D.POSID = A.CS302_PJT
	AND D.POSID_1 = A.CS302_PJT||A.CS302_HNO

	LEFT OUTER JOIN SAPHEE.ZWBT010 AS E
	ON E.MANDT = A.MANDT
	AND E.LGORT = B.BSU

	LEFT OUTER JOIN (
	SELECT A.*
	FROM (
	SELECT ROW_NUMBER() OVER(PARTITION BY A.MANDT, A.CS126_PJT, A.CS126_HNO ORDER
	BY A.CS126_SEQ DESC, A.CS126_ADT DESC) NO
	, A.MANDT
	, A.CS126_GRP
	, A.CS126_PJT AS PJT
	, A.CS126_HNO AS HNO
	, A.CS126_GKD AS GKD
	, A.CS126_TOT AS TOT
	, A.CS126_KND AS KND
	FROM SAPHEE.ZCST126 A
	WHERE A.MANDT = #G_MANDT#
	AND A.CS126_DDT = ''
	AND A.CS126_PST = 'A6'
	AND A.CS126_GND = 'D'
	AND A.CS126_PJT||A.CS126_HNO IN (
	SELECT CS302_PJT||CS302_HNO
	FROM SAPHEE.ZCST302 AS A
	WHERE A.MANDT = #G_MANDT#
	AND A.CS302_TEM = #TEM#
	AND A.CS302_RDT = #RDT#
	AND A.CS302_SEQ = #SEQ#
	AND A.CS302_SIR = #SIR#
	)
	AND A.CS126_USD &lt;= #CDT#
	AND SUBSTR(A.CS126_HNO,1,1) NOT IN ('J','G')
	AND A.CS126_ADT &lt;= #CDT#) A
	WHERE A.NO = 1
	) F
	ON F.MANDT = #G_MANDT#
	AND A.CS302_PJT = F.PJT
	AND A.CS302_HNO = F.HNO


	WHERE 1=1

	) AS A
	WITH UR                   		
 
  	</statement>
	<input default-name="ds_list">
	</input>
	<output default-name="none">
	</output>
</query>
