<?xml version="1.0" encoding="euc-kr"?>
<query>
	<type>select</type>
	<description><![CDATA[]]></description>
	<reload>true</reload>
	<monitoring>true</monitoring>
	<result-count>1</result-count>
	<statement>
<![CDATA[
WITH LT (DATE1,DATE2) AS (
    SELECT REPLACE((DATES),'-','') AS DATE1,DATES DATE2
    FROM (
            SELECT DATES,NUM
            FROM (
                    SELECT                                                                                                                                                                                                                                                           
                            CASE NUM WHEN 1  THEN CASE WHEN DAYOFWEEK(CURRENT DATE - 1  DAY) IN (1,7) OR (SELECT COUNT(*) FROM SAPHEE.ZHRT002 WHERE HUILDATE = replace(char(CURRENT DATE - 1  DAY),'-','')) > 0 THEN 'Y' ELSE CHAR(CURRENT DATE - 1  DAY) END      
                                     WHEN 2  THEN CASE WHEN DAYOFWEEK(CURRENT DATE - 2  DAY) IN (1,7) OR (SELECT COUNT(*) FROM SAPHEE.ZHRT002 WHERE HUILDATE = replace(char(CURRENT DATE - 2  DAY),'-','')) > 0 THEN 'Y' ELSE CHAR(CURRENT DATE - 2  DAY) END      
                                     WHEN 3  THEN CASE WHEN DAYOFWEEK(CURRENT DATE - 3  DAY) IN (1,7) OR (SELECT COUNT(*) FROM SAPHEE.ZHRT002 WHERE HUILDATE = replace(char(CURRENT DATE - 3  DAY),'-','')) > 0 THEN 'Y' ELSE CHAR(CURRENT DATE - 3  DAY) END      
                                     WHEN 4  THEN CASE WHEN DAYOFWEEK(CURRENT DATE - 4  DAY) IN (1,7) OR (SELECT COUNT(*) FROM SAPHEE.ZHRT002 WHERE HUILDATE = replace(char(CURRENT DATE - 4  DAY),'-','')) > 0 THEN 'Y' ELSE CHAR(CURRENT DATE - 4  DAY) END      
                                     WHEN 5  THEN CASE WHEN DAYOFWEEK(CURRENT DATE - 5  DAY) IN (1,7) OR (SELECT COUNT(*) FROM SAPHEE.ZHRT002 WHERE HUILDATE = replace(char(CURRENT DATE - 5  DAY),'-','')) > 0 THEN 'Y' ELSE CHAR(CURRENT DATE - 5  DAY) END 	 
                                     WHEN 6  THEN CASE WHEN DAYOFWEEK(CURRENT DATE - 6  DAY) IN (1,7) OR (SELECT COUNT(*) FROM SAPHEE.ZHRT002 WHERE HUILDATE = replace(char(CURRENT DATE - 6  DAY),'-','')) > 0 THEN 'Y' ELSE CHAR(CURRENT DATE - 6  DAY) END      
                                     WHEN 7  THEN CASE WHEN DAYOFWEEK(CURRENT DATE - 7  DAY) IN (1,7) OR (SELECT COUNT(*) FROM SAPHEE.ZHRT002 WHERE HUILDATE = replace(char(CURRENT DATE - 7  DAY),'-','')) > 0 THEN 'Y' ELSE CHAR(CURRENT DATE - 7  DAY) END      
                                     WHEN 8  THEN CASE WHEN DAYOFWEEK(CURRENT DATE - 8  DAY) IN (1,7) OR (SELECT COUNT(*) FROM SAPHEE.ZHRT002 WHERE HUILDATE = replace(char(CURRENT DATE - 8  DAY),'-','')) > 0 THEN 'Y' ELSE CHAR(CURRENT DATE - 8  DAY) END      
                                     WHEN 9  THEN CASE WHEN DAYOFWEEK(CURRENT DATE - 9  DAY) IN (1,7) OR (SELECT COUNT(*) FROM SAPHEE.ZHRT002 WHERE HUILDATE = replace(char(CURRENT DATE - 9  DAY),'-','')) > 0 THEN 'Y' ELSE CHAR(CURRENT DATE - 9  DAY) END      
                                     WHEN 10 THEN CASE WHEN DAYOFWEEK(CURRENT DATE - 10 DAY) IN (1,7) OR (SELECT COUNT(*) FROM SAPHEE.ZHRT002 WHERE HUILDATE = replace(char(CURRENT DATE - 10 DAY),'-','')) > 0 THEN 'Y' ELSE CHAR(CURRENT DATE - 10 DAY) END      
                             END AS DATES                                                                                                                                                                                                                                            
                    		 ,NUM                                                                                                                                                                                                                                                    
                    FROM SYSIBM.SYSDUMMY1,SAPHEE.ZCOPY_T AS T                                                                                                                                                                                                                        
                    WHERE T.MANDT = #G_MANDT#                                                                                                                                                                                                                                         
                    AND T.NUM < 11
            ) AS T
            WHERE DATES <> 'Y'
            ORDER BY DATES DESC
            FETCH FIRST 2 ROWS ONLY
    ) AS T
    ORDER BY NUM DESC
    FETCH FIRST 1 ROWS ONLY
)

-- 협력사 설치팀장
SELECT '현대엘리베이터입니다. '||M1.ZSITE_NM||' 착공 20일전입니다.' AS TRAN_MSG,
       replace(P.CELLP,'-','')  AS TRAN_PHONE,
       VALUE((SELECT CASE WHEN LIFNR = '2168114582' OR LIFNR = '1078165792' OR LIFNR = '1108176067' OR LIFNR = '1288621802' OR LIFNR = '1268171669' OR LIFNR = '2108157564' OR LIFNR = '1388141265' THEN DTEXT2 ELSE DTEXT1 END FROM SAPHEE.ZLCODE AS M28 WHERE M28.MANDT = M.MANDT AND M28.CODE1 = 'PS003' AND M28.LANG = 'ko' AND M28.CODE2 = M1.ZZACTSS), '1577-0603') AS TRAN_CALLBACK,
       'PS_WEB' AS TRAN_ETC1,
       M1.POSID AS TRAN_ETC2
FROM  (
        SELECT MANDT,POSID,TEMNO2 AS TEMNO, MAX(LIFNR) AS LIFNR
        FROM SAPHEE.ZMASTER02 AS M
        WHERE M.MANDT = #G_MANDT#
        AND M.TXT30 <> '취소'
        AND M.ZZSHIP1 = HEX(CURRENT DATE + 20 DAY)
        AND M.TEMNO2 > ''
        AND (M.POSID_1 LIKE '______L__' OR M.POSID_1 LIKE '______S__' OR M.POSID_1 LIKE '______W__' OR M.POSID_1  LIKE '______J__')
        GROUP BY MANDT,POSID,TEMNO2
       ) M,
       (
       SELECT MANDT,TEMNO,CELLP
        FROM SAPHEE.ZPST0001
        WHERE MANDT = #G_MANDT#
         AND POSIT = 'X'
         AND CELLP > ''
         AND GBN = 'A'
        GROUP BY MANDT,TEMNO,CELLP
        ORDER BY TEMNO
       ) AS P,
	   SAPHEE.ZMASTER01 M1
WHERE  M.MANDT = P.MANDT
AND M.TEMNO = P.TEMNO
AND M.MANDT = M1.MANDT
AND M.POSID = M1.POSID

UNION

-- 양중 협력사 설치팀장
SELECT '현대엘리베이터입니다. '||M1.ZSITE_NM||' 착공 20일전입니다.' AS TRAN_MSG,
       replace(P.CELLP,'-','')  AS TRAN_PHONE,
       VALUE((SELECT CASE WHEN LIFNR = '2168114582' OR LIFNR = '1078165792' OR LIFNR = '1108176067' OR LIFNR = '1288621802' OR LIFNR = '1268171669' OR LIFNR = '2108157564' OR LIFNR = '1388141265' THEN DTEXT2 ELSE DTEXT1 END FROM SAPHEE.ZLCODE AS M28 WHERE M28.MANDT = M.MANDT AND M28.CODE1 = 'PS003' AND M28.LANG = 'ko' AND M28.CODE2 = M1.ZZACTSS), '1577-0603') AS TRAN_CALLBACK,
       'PS_WEB' AS TRAN_ETC1,
       M1.POSID AS TRAN_ETC2
FROM  (
         SELECT M.MANDT,M.POSID,P.TEMNO AS TEMNO, MAX(P.LIFNR) AS LIFNR
        FROM SAPHEE.ZMASTER02 AS M
		 INNER JOIN SAPHEE.ZPST0102P AS P
		 ON M.MANDT = P.MANDT
		 AND M.POSID = P.PSPID
		 AND M.POSID_1 = P.POSID
        WHERE M.MANDT = #G_MANDT#
        AND M.TXT30 <> '취소'
        AND M.ZZSHIP1 = HEX(CURRENT DATE + 20 DAY)
        AND P.LIFNR > ''
		AND P.TEMNO > ''
        AND (M.POSID_1 LIKE '______L__' OR M.POSID_1 LIKE '______S__' OR M.POSID_1 LIKE '______W__' OR M.POSID_1  LIKE '______J__')
        GROUP BY M.MANDT,M.POSID,P.TEMNO
       ) M,
       (
       SELECT MANDT,TEMNO,CELLP
        FROM SAPHEE.ZPST0001
        WHERE MANDT = #G_MANDT#
         AND POSIT = 'X'
         AND CELLP > ''
         AND GBN = 'A'
        GROUP BY MANDT,TEMNO,CELLP
        ORDER BY TEMNO
       ) AS P,
	   SAPHEE.ZMASTER01 M1
WHERE  M.MANDT = P.MANDT
AND M.TEMNO = P.TEMNO
AND M.MANDT = M1.MANDT
AND M.POSID = M1.POSID



UNION

-- 설치담당PM
SELECT '현대엘리베이터입니다. '||M1.ZSITE_NM||' 착공 20일전입니다.' AS TRAN_MSG,
       replace(P.CELLP,'-','')  AS TRAN_PHONE,
      VALUE( (SELECT CASE WHEN LIFNR = '2168114582' OR LIFNR = '1078165792' OR LIFNR = '1108176067' OR LIFNR = '1288621802' OR LIFNR = '1268171669' OR LIFNR = '2108157564' OR LIFNR = '1388141265' THEN DTEXT2 ELSE DTEXT1 END FROM SAPHEE.ZLCODE AS M28 WHERE M28.MANDT = M.MANDT AND M28.CODE1 = 'PS003' AND M28.LANG = 'ko' AND M28.CODE2 = M1.ZZACTSS), '1577-0603') AS TRAN_CALLBACK,
       'PS_WEB' AS TRAN_ETC1,
       M1.POSID AS TRAN_ETC2
FROM  (
        SELECT MANDT,POSID,TEMNO, MAX(LIFNR) AS LIFNR
        FROM SAPHEE.ZMASTER02 AS M
        WHERE M.MANDT = #G_MANDT#
        AND M.TXT30 <> '취소'
        AND M.ZZSHIP1 = HEX(CURRENT DATE + 20 DAY)
        AND M.TEMNO > ''
        AND (M.POSID_1 LIKE '______L__' OR M.POSID_1 LIKE '______S__' OR M.POSID_1 LIKE '______W__'  OR M.POSID_1  LIKE '______J__' )
        GROUP BY MANDT,POSID,TEMNO
       ) M,
	   SAPHEE.ZPST0011 AS P,
	   SAPHEE.ZMASTER01 M1
WHERE  M.MANDT = P.MANDT
AND M.TEMNO = P.TEMNO
AND P.CELLP > ''
AND M.MANDT = M1.MANDT
AND M.POSID = M1.POSID
AND P.RETIF = ''

UNION

-- 협력사 설치팀장
SELECT '현대엘리베이터입니다. '||M1.ZSITE_NM||' 준공 10일전입니다.'  AS TRAN_MSG,
       replace(P.CELLP,'-','')  AS TRAN_PHONE,
       VALUE((SELECT CASE WHEN LIFNR = '2168114582' OR LIFNR = '1078165792' OR LIFNR = '1108176067' OR LIFNR = '1288621802' OR LIFNR = '1268171669' OR LIFNR = '2108157564' OR LIFNR = '1388141265' THEN DTEXT2 ELSE DTEXT1 END FROM SAPHEE.ZLCODE AS M28 WHERE M28.MANDT = M.MANDT AND M28.CODE1 = 'PS003' AND M28.LANG = 'ko' AND M28.CODE2 = M1.ZZACTSS), '1577-0603') AS TRAN_CALLBACK,
       'PS_WEB' AS TRAN_ETC1,
       M1.POSID AS TRAN_ETC2
FROM  (
        SELECT MANDT,POSID,TEMNO2 AS TEMNO, MAX(LIFNR) AS LIFNR
        FROM SAPHEE.ZMASTER02 AS M
        WHERE M.MANDT = #G_MANDT#
        AND M.TXT30 <> '취소'
        AND M.ZZCOMP2 = HEX(CURRENT DATE + 10 DAY)
        AND M.TEMNO2 > ''
        AND (M.POSID_1 LIKE '______L__' OR M.POSID_1 LIKE '______S__' OR M.POSID_1 LIKE '______W__' OR M.POSID_1  LIKE '______J__' )
        GROUP BY MANDT,POSID,TEMNO2
       ) M,
       (
       SELECT MANDT,TEMNO,CELLP
        FROM SAPHEE.ZPST0001
        WHERE MANDT = #G_MANDT#
         AND POSIT = 'X'
         AND CELLP > ''
         AND GBN = 'A'
        GROUP BY MANDT,TEMNO,CELLP
        ORDER BY TEMNO
       ) AS P,
	   SAPHEE.ZMASTER01 M1
WHERE  M.MANDT = P.MANDT
AND M.TEMNO = P.TEMNO
AND M.MANDT = M1.MANDT
AND M.POSID = M1.POSID

UNION

-- 설치담당PM
SELECT '현대엘리베이터입니다. '||M1.ZSITE_NM||' 준공 10일전입니다.' AS TRAN_MSG,
       replace(P.CELLP,'-','')  AS TRAN_PHONE,
       VALUE((SELECT CASE WHEN LIFNR = '2168114582' OR LIFNR = '1078165792' OR LIFNR = '1108176067' OR LIFNR = '1288621802' OR LIFNR = '1268171669' OR LIFNR = '2108157564' OR LIFNR = '1388141265' THEN DTEXT2 ELSE DTEXT1 END FROM SAPHEE.ZLCODE AS M28 WHERE M28.MANDT = M.MANDT AND M28.CODE1 = 'PS003' AND M28.LANG = 'ko' AND M28.CODE2 = M1.ZZACTSS), '1577-0603') AS TRAN_CALLBACK,
       'PS_WEB' AS TRAN_ETC1,
       M1.POSID AS TRAN_ETC2
FROM  (
        SELECT MANDT,POSID,TEMNO, MAX(LIFNR) AS LIFNR
        FROM SAPHEE.ZMASTER02 AS M
        WHERE M.MANDT = #G_MANDT#
        AND M.TXT30 <> '취소'
        AND M.ZZCOMP2 = HEX(CURRENT DATE + 10 DAY)
        AND M.TEMNO > ''
        AND (M.POSID_1 LIKE '______L__' OR M.POSID_1 LIKE '______S__' OR M.POSID_1 LIKE '______W__'  OR M.POSID_1  LIKE '______J__' )
        GROUP BY MANDT,POSID,TEMNO
       ) M,
	   SAPHEE.ZPST0011 AS P,
	   SAPHEE.ZMASTER01 M1
WHERE  M.MANDT = P.MANDT
AND M.TEMNO = P.TEMNO
AND P.CELLP > ''
AND M.MANDT = M1.MANDT
AND M.POSID = M1.POSID
AND P.RETIF = ''

UNION 

-- 협력사 설치팀장
SELECT '현대엘리베이터입니다. '||M1.ZSITE_NM||' 착공 3일전입니다.' AS TRAN_MSG,
       replace(P.CELLP,'-','')  AS TRAN_PHONE,
       VALUE((SELECT CASE WHEN LIFNR = '2168114582' OR LIFNR = '1078165792' OR LIFNR = '1108176067' OR LIFNR = '1288621802' OR LIFNR = '1268171669' OR LIFNR = '2108157564' OR LIFNR = '1388141265' THEN DTEXT2 ELSE DTEXT1 END FROM SAPHEE.ZLCODE AS M28 WHERE M28.MANDT = M.MANDT AND M28.CODE1 = 'PS003' AND M28.LANG = 'ko' AND M28.CODE2 = M1.ZZACTSS), '1577-0603') AS TRAN_CALLBACK,
       'PS_WEB' AS TRAN_ETC1,
       M1.POSID AS TRAN_ETC2
FROM  (
        SELECT MANDT,POSID,TEMNO2 AS TEMNO, MAX(LIFNR) AS LIFNR
        FROM SAPHEE.ZMASTER02 AS M
        WHERE M.MANDT = #G_MANDT#
        AND M.TXT30 <> '취소'
        AND M.ZZSHIP1 = HEX(CURRENT DATE + 3 DAY)
        AND M.TEMNO2 > ''
        AND (M.POSID_1 LIKE '______L__' OR M.POSID_1 LIKE '______S__' OR M.POSID_1 LIKE '______W__'  OR M.POSID_1  LIKE '______J__' )
        GROUP BY MANDT,POSID,TEMNO2
       ) M,
       (
       SELECT MANDT,TEMNO,CELLP
        FROM SAPHEE.ZPST0001
        WHERE MANDT = #G_MANDT#
         AND POSIT = 'X'
         AND CELLP > ''
         AND GBN = 'A'
        GROUP BY MANDT,TEMNO,CELLP
        ORDER BY TEMNO
       ) AS P,
	   SAPHEE.ZMASTER01 M1
WHERE  M.MANDT = P.MANDT
AND M.TEMNO = P.TEMNO
AND M.MANDT = M1.MANDT
AND M.POSID = M1.POSID

UNION 

-- 양중 협력사 설치팀장
SELECT '현대엘리베이터입니다. '||M1.ZSITE_NM||' 착공 3일전입니다.' AS TRAN_MSG,
       replace(P.CELLP,'-','')  AS TRAN_PHONE,
       VALUE((SELECT CASE WHEN LIFNR = '2168114582' OR LIFNR = '1078165792' OR LIFNR = '1108176067' OR LIFNR = '1288621802' OR LIFNR = '1268171669' OR LIFNR = '2108157564' OR LIFNR = '1388141265' THEN DTEXT2 ELSE DTEXT1 END FROM SAPHEE.ZLCODE AS M28 WHERE M28.MANDT = M.MANDT AND M28.CODE1 = 'PS003' AND M28.LANG = 'ko' AND M28.CODE2 = M1.ZZACTSS), '1577-0603') AS TRAN_CALLBACK,
       'PS_WEB' AS TRAN_ETC1,
       M1.POSID AS TRAN_ETC2
FROM  (
        SELECT M.MANDT,M.POSID,P.TEMNO AS TEMNO, MAX(P.LIFNR) AS LIFNR
          FROM SAPHEE.ZMASTER02 AS M
		  inner join SAPHEE.ZPST0102P AS P
		    ON M.MANDT = P.MANDT
		   AND M.POSID = P.PSPID
		   AND M.POSID_1 = P.POSID
        WHERE M.MANDT = #G_MANDT#
        AND M.TXT30 <> '취소'
        AND M.ZZSHIP1 = HEX(CURRENT DATE + 3 DAY)
        AND P.LIFNR > ''
		AND P.TEMNO > ''
        AND (M.POSID_1 LIKE '______L__' OR M.POSID_1 LIKE '______S__' OR M.POSID_1 LIKE '______W__' OR M.POSID_1  LIKE '______J__')
        GROUP BY M.MANDT,M.POSID,P.TEMNO
       ) M,
       (
       SELECT MANDT,TEMNO,CELLP
        FROM SAPHEE.ZPST0001
        WHERE MANDT = #G_MANDT#
         AND POSIT = 'X'
         AND CELLP > ''
         AND GBN = 'A'
        GROUP BY MANDT,TEMNO,CELLP
        ORDER BY TEMNO
       ) AS P,
	   SAPHEE.ZMASTER01 M1
WHERE  M.MANDT = P.MANDT
AND M.TEMNO = P.TEMNO
AND M.MANDT = M1.MANDT
AND M.POSID = M1.POSID 

UNION

-- 설치담당PM
SELECT '현대엘리베이터입니다. '||M1.ZSITE_NM||' 착공 3일전입니다.' AS TRAN_MSG,
       replace(P.CELLP,'-','')  AS TRAN_PHONE,
       VALUE((SELECT CASE WHEN LIFNR = '2168114582' OR LIFNR = '1078165792' OR LIFNR = '1108176067' OR LIFNR = '1288621802' OR LIFNR = '1268171669' OR LIFNR = '2108157564' OR LIFNR = '1388141265' THEN DTEXT2 ELSE DTEXT1 END FROM SAPHEE.ZLCODE AS M28 WHERE M28.MANDT = M.MANDT AND M28.CODE1 = 'PS003' AND M28.LANG = 'ko' AND M28.CODE2 = M1.ZZACTSS), '1577-0603') AS TRAN_CALLBACK,
       'PS_WEB' AS TRAN_ETC1,
       M1.POSID AS TRAN_ETC2
FROM  (
        SELECT MANDT,POSID,TEMNO, MAX(LIFNR) AS LIFNR
        FROM SAPHEE.ZMASTER02 AS M
        WHERE M.MANDT = #G_MANDT#
        AND M.TXT30 <> '취소'
        AND M.ZZSHIP1 = HEX(CURRENT DATE + 3 DAY)
        AND M.TEMNO > ''
        AND (M.POSID_1 LIKE '______L__' OR M.POSID_1 LIKE '______S__' OR M.POSID_1 LIKE '______W__'  OR M.POSID_1  LIKE '______J__' )
        GROUP BY MANDT,POSID,TEMNO
       ) M,
	   SAPHEE.ZPST0011 AS P,
	   SAPHEE.ZMASTER01 M1
WHERE  M.MANDT = P.MANDT
AND M.TEMNO = P.TEMNO
AND P.CELLP > ''
AND M.MANDT = M1.MANDT
AND M.POSID = M1.POSID
AND P.RETIF = ''

UNION 

-- 협력사 설치팀장
--SELECT '현대E/L 입니다.'||M1.ZSITE_NM||' 미입력 상태로!즉시입력바랍니다.' AS TRAN_MSG,
--       replace(P.CELLP,'-','')  AS TRAN_PHONE,
--       VALUE((SELECT CASE WHEN LIFNR = '2168114582' OR LIFNR = '1078165792' OR LIFNR = '1108176067' OR LIFNR = '1288621802' OR LIFNR = '1268171669' OR LIFNR = '2108157564' OR LIFNR = '1388141265' THEN DTEXT2 ELSE DTEXT1 END FROM SAPHEE.ZLCODE AS M28 WHERE M28.MANDT = M.MANDT AND M28.CODE1 = 'PS003' AND M28.LANG = 'ko' AND M28.CODE2 = M1.ZZACTSS), '1577-0603') AS TRAN_CALLBACK,
--       'PS_WEB' AS TRAN_ETC1,
--       M1.POSID AS TRAN_ETC2
-- FROM  (
--        SELECT MANDT,POSID,TEMNO2 AS TEMNO, MAX(LIFNR) AS LIFNR
--        FROM SAPHEE.ZMASTER02 AS M
--        WHERE M.MANDT = #G_MANDT#
--        AND M.TEMNO2 > ''
--        AND M.ZZINTER = ''
--        AND M.TXT30 <> '취소'
--        AND (M.POSID_1 LIKE '______L__' OR M.POSID_1 LIKE '______S__' OR M.POSID_1 LIKE '______W__' )
--        GROUP BY MANDT,POSID,TEMNO2
--       ) M,
--       (
--       SELECT MANDT,TEMNO,CELLP
--        FROM SAPHEE.ZPST0001
--        WHERE MANDT = #G_MANDT#
--         AND POSIT = 'X'
--         AND CELLP > ''
--         AND GBN = 'A'
--        GROUP BY MANDT,TEMNO,CELLP
--        ORDER BY TEMNO
--       ) AS P,
--	   (
--	   SELECT  M1.MANDT,M1.POSID,M1.CDATE,M1.ZSITE_NM,M1.ZZACTSS
--        FROM SAPHEE.ZMASTER01 AS M1,LT
--        WHERE M1.MANDT = #G_MANDT#
--		AND M1.CDATE > REPLACE(CHAR(CURRENT DATE - 10 DAY),'-','')
--		AND M1.CDATE = LT.DATE1
--	   ) AS M1
-- WHERE  M.MANDT = P.MANDT
-- AND M.TEMNO = P.TEMNO
-- AND M.MANDT = M1.MANDT
-- AND M.POSID = M1.POSID
-- AND CASE WHEN DAYOFWEEK(CURRENT DATE) IN (1,7) OR (SELECT COUNT(*) FROM SAPHEE.ZHRT002 WHERE HUILDATE = replace(char(CURRENT DATE),'-','')) > 0 THEN 'Y' ELSE 'N' END = 'N'

-- UNION

-- 설치담당PM
-- SELECT '현대E/L 입니다.'||M1.ZSITE_NM||' 미입력 상태로!즉시입력바랍니다.' AS TRAN_MSG,
--       replace(P.CELLP,'-','')  AS TRAN_PHONE,
--       VALUE((SELECT CASE WHEN LIFNR = '2168114582' OR LIFNR = '1078165792' OR LIFNR = '1108176067' OR LIFNR = '1288621802' OR LIFNR = '1268171669' OR LIFNR = '2108157564' OR LIFNR = '1388141265' THEN DTEXT2 ELSE DTEXT1 END FROM SAPHEE.ZLCODE AS M28 WHERE M28.MANDT = M.MANDT AND M28.CODE1 = 'PS003' AND M28.LANG = 'ko' AND M28.CODE2 = M1.ZZACTSS),'1577-0603') AS TRAN_CALLBACK,
--       'PS_WEB' AS TRAN_ETC1,
--       M1.POSID AS TRAN_ETC2
-- FROM  (
--        SELECT MANDT,POSID,TEMNO, MAX(LIFNR) AS LIFNR
--        FROM SAPHEE.ZMASTER02 AS M
--        WHERE M.MANDT = #G_MANDT#
--        AND M.TEMNO > ''
--        AND M.ZZINTER = ''
--        AND M.TXT30 <> '취소'
--        AND (M.POSID_1 LIKE '______L__' OR M.POSID_1 LIKE '______S__' OR M.POSID_1 LIKE '______W__'  OR M.POSID_1  LIKE '______J__' )
--        GROUP BY MANDT,POSID,TEMNO
--       ) M,
--	   SAPHEE.ZPST0011 AS P,
--	   SAPHEE.ZMASTER01 M1,
--	   LT
-- WHERE  M.MANDT = P.MANDT
-- AND M.TEMNO = P.TEMNO
-- AND P.CELLP > ''
-- AND M.MANDT = M1.MANDT
-- AND M.POSID = M1.POSID
-- AND P.RETIF = ''
-- AND M1.CDATE > REPLACE(CHAR(CURRENT DATE - 10 DAY),'-','')
-- AND M1.CDATE = LT.DATE1
-- AND CASE WHEN DAYOFWEEK(CURRENT DATE) IN (1,7) OR (SELECT COUNT(*) FROM SAPHEE.ZHRT002 WHERE HUILDATE = replace(char(CURRENT DATE),'-','')) > 0 THEN 'Y' ELSE 'N' END = 'N'

-- UNION

-- 협력사 설치팀장
-- SELECT '현대E/L 입니다.'||M1.ZSITE_NM||' 수통접수후 3일경과!즉시입력바랍니다.' AS TRAN_MSG,
--       replace(P.CELLP,'-','')  AS TRAN_PHONE,
--       VALUE((SELECT CASE WHEN LIFNR = '2168114582' OR LIFNR = '1078165792' OR LIFNR = '1108176067' OR LIFNR = '1288621802' OR LIFNR = '1268171669' OR LIFNR = '2108157564' OR LIFNR = '1388141265' THEN DTEXT2 ELSE DTEXT1 END FROM SAPHEE.ZLCODE AS M28 WHERE M28.MANDT = M.MANDT AND M28.CODE1 = 'PS003' AND M28.LANG = 'ko' AND M28.CODE2 = M1.ZZACTSS), '1577-0603') AS TRAN_CALLBACK,
--       'PS_WEB' AS TRAN_ETC1,
--       M1.POSID AS TRAN_ETC2
-- FROM  (
--        SELECT MANDT,POSID,TEMNO2 AS TEMNO, MAX(LIFNR) AS LIFNR
--        FROM SAPHEE.ZMASTER02 AS M
--        WHERE M.MANDT = #G_MANDT#
--        AND M.TEMNO2 > ''
--        AND M.ZZINTER = ''
--        AND M.TXT30 <> '취소'
--        AND (M.POSID_1 LIKE '______L__' OR M.POSID_1 LIKE '______S__' OR M.POSID_1 LIKE '______W__')
--        GROUP BY MANDT,POSID,TEMNO2
--       ) M,
--       (
--       SELECT MANDT,TEMNO,CELLP
--        FROM SAPHEE.ZPST0001
--        WHERE MANDT = #G_MANDT#
--         AND POSIT = 'X'
--         AND CELLP > ''
--         AND GBN = 'A'
--        GROUP BY MANDT,TEMNO,CELLP
--        ORDER BY TEMNO
--       ) AS P,
--	   (
--	   SELECT  M1.MANDT,M1.POSID,M1.CDATE,M1.ZSITE_NM,M1.ZZACTSS
--       FROM SAPHEE.ZMASTER01 AS M1,LT
--        WHERE M1.MANDT = #G_MANDT#
--		AND M1.CDATE > REPLACE(CHAR(CURRENT DATE - 10 DAY),'-','')
--		AND M1.CDATE <= REPLACE(CHAR(DATE(LT.DATE2) - 1 DAY),'-','')
--	   ) AS M1
-- WHERE  M.MANDT = P.MANDT
-- AND M.TEMNO = P.TEMNO
-- AND M.MANDT = M1.MANDT
-- AND M.POSID = M1.POSID
-- AND CASE WHEN DAYOFWEEK(CURRENT DATE) IN (1,7) OR (SELECT COUNT(*) FROM SAPHEE.ZHRT002 WHERE HUILDATE = replace(char(CURRENT DATE),'-','')) > 0 THEN 'Y' ELSE 'N' END = 'N'

-- UNION

-- 설치담당PM
-- SELECT '현대E/L 입니다.'||M1.ZSITE_NM||' 수통접수후 3일경과!즉시입력바랍니다.' AS TRAN_MSG,
--       replace(P.CELLP,'-','')  AS TRAN_PHONE,
--       VALUE((SELECT CASE WHEN LIFNR = '2168114582' OR LIFNR = '1078165792' OR LIFNR = '1108176067' OR LIFNR = '1288621802' OR LIFNR = '1268171669' OR LIFNR = '2108157564' OR LIFNR = '1388141265' THEN DTEXT2 ELSE DTEXT1 END FROM SAPHEE.ZLCODE AS M28 WHERE M28.MANDT = M.MANDT AND M28.CODE1 = 'PS003' AND M28.LANG = 'ko' AND M28.CODE2 = M1.ZZACTSS), '1577-0603') AS TRAN_CALLBACK,
--       'PS_WEB' AS TRAN_ETC1,
--       M1.POSID AS TRAN_ETC2
-- FROM  (
--        SELECT MANDT,POSID,TEMNO, MAX(LIFNR) AS LIFNR
--        FROM SAPHEE.ZMASTER02 AS M
--        WHERE M.MANDT = #G_MANDT#
--        AND M.TEMNO > ''
--        AND M.ZZINTER = ''
--        AND M.TXT30 <> '취소'
--        AND (M.POSID_1 LIKE '______L__' OR M.POSID_1 LIKE '______S__' OR M.POSID_1 LIKE '______W__'  OR M.POSID_1  LIKE '______J__' )
--        GROUP BY MANDT,POSID,TEMNO
--       ) M,
--	   SAPHEE.ZPST0011 AS P,
--	   SAPHEE.ZMASTER01 M1,
--	   LT
-- WHERE  M.MANDT = P.MANDT
-- AND M.TEMNO = P.TEMNO
-- AND P.CELLP > ''
-- AND M.MANDT = M1.MANDT
-- AND M.POSID = M1.POSID
-- AND P.RETIF = ''
-- AND M1.CDATE > REPLACE(CHAR(CURRENT DATE - 10 DAY),'-','')
-- AND M1.CDATE <= REPLACE(CHAR(DATE(LT.DATE2) - 1 DAY),'-','')
-- AND CASE WHEN DAYOFWEEK(CURRENT DATE) IN (1,7) OR (SELECT COUNT(*) FROM SAPHEE.ZHRT002 WHERE HUILDATE = replace(char(CURRENT DATE),'-','')) > 0 THEN 'Y' ELSE 'N' END = 'N'

-- UNION

-- 영업담당자
SELECT '현대엘리베이터입니다. '||M1.ZSITE_NM||' 착공 20일전입니다.' AS TRAN_MSG,
       REPLACE(M1.ZTEL,'-','') AS TRAN_PHONE,
       VALUE((SELECT CASE WHEN LIFNR = '2168114582' OR LIFNR = '1078165792' OR LIFNR = '1108176067' OR LIFNR = '1288621802' OR LIFNR = '1268171669' OR LIFNR = '2108157564' OR LIFNR = '1388141265' THEN DTEXT2 ELSE DTEXT1 END FROM SAPHEE.ZLCODE AS M28 WHERE M28.MANDT = M.MANDT AND M28.CODE1 = 'PS003' AND M28.LANG = 'ko' AND M28.CODE2 = M1.ZZACTSS), '1577-0603') AS TRAN_CALLBACK,
       'PS_WEB' AS TRAN_ETC1,
       M1.POSID AS TRAN_ETC2
FROM  (
        SELECT MANDT,POSID, MAX(LIFNR) AS LIFNR
        FROM SAPHEE.ZMASTER02 AS M
        WHERE M.MANDT = #G_MANDT#
        AND M.TXT30 <> '취소'
        AND M.ZZSHIP1 = HEX(CURRENT DATE + 20 DAY)
        AND (M.POSID_1 LIKE '______L__' OR M.POSID_1 LIKE '______S__' OR M.POSID_1 LIKE '______W__')
        GROUP BY MANDT,POSID
       ) M,
	   SAPHEE.ZMASTER01 M1
WHERE M1.ZTEL > ''
AND M1.ZTEL IS NOT NULL
AND M.MANDT = M1.MANDT
AND M.POSID = M1.POSID

UNION

-- 영업담당자
SELECT '현대엘리베이터입니다. '||M1.ZSITE_NM||' 준공 10일전입니다.'  AS TRAN_MSG,
        REPLACE(M1.ZTEL,'-','') AS TRAN_PHONE,
       VALUE((SELECT CASE WHEN LIFNR = '2168114582' OR LIFNR = '1078165792' OR LIFNR = '1108176067' OR LIFNR = '1288621802' OR LIFNR = '1268171669' OR LIFNR = '2108157564' OR LIFNR = '1388141265' THEN DTEXT2 ELSE DTEXT1 END FROM SAPHEE.ZLCODE AS M28 WHERE M28.MANDT = M.MANDT AND M28.CODE1 = 'PS003' AND M28.LANG = 'ko' AND M28.CODE2 = M1.ZZACTSS), '1577-0603') AS TRAN_CALLBACK,
       'PS_WEB' AS TRAN_ETC1,
       M1.POSID AS TRAN_ETC2
FROM  (
        SELECT MANDT,POSID, MAX(LIFNR) AS LIFNR
        FROM SAPHEE.ZMASTER02 AS M
        WHERE M.MANDT = #G_MANDT#
        AND M.TXT30 <> '취소'
        AND M.ZZCOMP2 = HEX(CURRENT DATE + 10 DAY)
        AND (M.POSID_1 LIKE '______L__' OR M.POSID_1 LIKE '______S__' OR M.POSID_1 LIKE '______W__')
        GROUP BY MANDT,POSID
       ) M,
	   SAPHEE.ZMASTER01 M1
WHERE M1.ZTEL > ''
AND M1.ZTEL IS NOT NULL
AND M.MANDT = M1.MANDT
AND M.POSID = M1.POSID	

UNION

-- 영업담당자
SELECT '현대엘리베이터입니다. '||M1.ZSITE_NM||' 착공 3일전입니다.' AS TRAN_MSG,
       REPLACE(M1.ZTEL,'-','') AS TRAN_PHONE,
       VALUE((SELECT CASE WHEN LIFNR = '2168114582' OR LIFNR = '1078165792' OR LIFNR = '1108176067' OR LIFNR = '1288621802' OR LIFNR = '1268171669' OR LIFNR = '2108157564' OR LIFNR = '1388141265' THEN DTEXT2 ELSE DTEXT1 END FROM SAPHEE.ZLCODE AS M28 WHERE M28.MANDT = M.MANDT AND M28.CODE1 = 'PS003' AND M28.LANG = 'ko' AND M28.CODE2 = M1.ZZACTSS), '1577-0603') AS TRAN_CALLBACK,
       'PS_WEB' AS TRAN_ETC1,
       M1.POSID AS TRAN_ETC2
FROM  (
        SELECT MANDT,POSID, MAX(LIFNR) AS LIFNR
          FROM SAPHEE.ZMASTER02 AS M
         WHERE M.MANDT = #G_MANDT#
            AND M.TXT30 <> '취소'
            AND M.ZZSHIP1 = HEX(CURRENT DATE + 3 DAY)
            AND (M.POSID_1 LIKE '______L__' OR M.POSID_1 LIKE '______S__' OR M.POSID_1 LIKE '______W__')
          GROUP BY MANDT,POSID
         ) M,
         SAPHEE.ZMASTER01 M1
WHERE M1.ZTEL > ''
AND M1.ZTEL IS NOT NULL
AND M.MANDT = M1.MANDT
AND M.POSID = M1.POSID

-- 완성검사일 d-day sms 배치 추가 
UNION

-- 설치담당PM
SELECT '현대엘리베이터입니다. '||M1.POSID||M1.ZSITE_NM||'완성검사일 15일전입니다. 설치담당자께서는 수금학인 후 검사 연기 바랍니다.' AS TRAN_MSG,
              replace(P.CELLP,'-','')  AS TRAN_PHONE,
              VALUE((SELECT CASE WHEN LIFNR = '2168114582' OR LIFNR = '1078165792' OR LIFNR = '1108176067' OR LIFNR = '1288621802' OR LIFNR = '1268171669' OR LIFNR = '2108157564' OR LIFNR = '1388141265' THEN DTEXT2 ELSE DTEXT1 END FROM SAPHEE.ZLCODE AS M28 WHERE M28.MANDT = M.MANDT AND M28.CODE1 = 'PS003' AND M28.LANG = 'ko' AND M28.CODE2 = M1.ZZACTSS), '1577-0603') AS TRAN_CALLBACK,
       'PS_WEB' AS TRAN_ETC1,
       M1.POSID AS TRAN_ETC2
FROM  (
           SELECT M.MANDT,M.POSID,M.TEMNO, MAX(M.LIFNR) AS LIFNR
              FROM SAPHEE.ZMASTER02 AS M
  	    LEFT OUTER JOIN SAPHEE.ZPST0201 AS P
   	      ON M.MANDT = P.MANDT 
	     AND M.POSID = P.PSPID
	     AND M.POSID_1 = P.POSID
	     AND P.CHK_KIND = 'A'
	     AND P.CHASU = '001'
	   LEFT OUTER JOIN SAPHEE.ZPST0023 T1 
	     ON P.MANDT = T1.MANDT 
	   AND P.PSPID = T1.PSPID 
	   AND P.POSID = T1.POSID 
	   AND T1.ZTYPE = '2'
              WHERE M.MANDT = #G_MANDT#
                  AND P.REQ_DATE = HEX(CURRENT DATE + 15 DAY)
                  AND M.TEMNO > ''
	    AND T1.APPYN <> 'Y'
                  AND M.TXT30 <> '취소'
                  AND (M.POSID_1 LIKE '______L__' OR M.POSID_1 LIKE '______S__' OR M.POSID_1 LIKE '______W__'  OR M.POSID_1  LIKE '______J__' )
             GROUP BY M.MANDT,M.POSID,M.TEMNO
       ) M,
	   SAPHEE.ZPST0011 AS P,
	   SAPHEE.ZMASTER01 M1
WHERE  M.MANDT = P.MANDT
AND M.TEMNO = P.TEMNO
AND P.CELLP > ''
AND M.MANDT = M1.MANDT
AND M.POSID = M1.POSID
AND P.RETIF = ''

UNION

-- 설치담당PM
SELECT '현대엘리베이터입니다. '||M1.POSID||M1.ZSITE_NM||'완성검사일 7일전입니다. 설치담당자께서는 수금학인 후 검사 연기 바랍니다.' AS TRAN_MSG,
       replace(P.CELLP,'-','')  AS TRAN_PHONE,
       VALUE((SELECT CASE WHEN LIFNR = '2168114582' OR LIFNR = '1078165792' OR LIFNR = '1108176067' OR LIFNR = '1288621802' OR LIFNR = '1268171669' OR LIFNR = '2108157564' OR LIFNR = '1388141265' THEN DTEXT2 ELSE DTEXT1 END FROM SAPHEE.ZLCODE AS M28 WHERE M28.MANDT = M.MANDT AND M28.CODE1 = 'PS003' AND M28.LANG = 'ko' AND M28.CODE2 = M1.ZZACTSS), '1577-0603') AS TRAN_CALLBACK,
       'PS_WEB' AS TRAN_ETC1,
       M1.POSID AS TRAN_ETC2
FROM  (
           SELECT M.MANDT,M.POSID,M.TEMNO, MAX(M.LIFNR) AS LIFNR
              FROM SAPHEE.ZMASTER02 AS M
	         	LEFT OUTER JOIN SAPHEE.ZPST0201 AS P
   		           ON M.MANDT = P.MANDT 
		         AND M.POSID = P.PSPID
		         AND M.POSID_1 = P.POSID
		         AND P.CHK_KIND = 'A'
	     		 AND P.CHASU = '001'
		       LEFT OUTER JOIN SAPHEE.ZPST0023 T1 
		         ON P.MANDT = T1.MANDT 
			   AND P.PSPID = T1.PSPID 
			   AND P.POSID = T1.POSID 
			   AND T1.ZTYPE = '2'
        WHERE M.MANDT = #G_MANDT#
        AND P.REQ_DATE = HEX(CURRENT DATE + 7 DAY)
        AND M.TEMNO > ''
        AND T1.APPYN <> 'Y'
        AND M.TXT30 <> '취소'
        AND (M.POSID_1 LIKE '______L__' OR M.POSID_1 LIKE '______S__' OR M.POSID_1 LIKE '______W__'  OR M.POSID_1  LIKE '______J__' )
        GROUP BY M.MANDT,M.POSID,M.TEMNO
       ) M,
	   SAPHEE.ZPST0011 AS P,
	   SAPHEE.ZMASTER01 M1
WHERE  M.MANDT = P.MANDT
AND M.TEMNO = P.TEMNO
AND P.CELLP > ''
AND M.MANDT = M1.MANDT
AND M.POSID = M1.POSID
AND P.RETIF = ''

UNION

-- 영업담당자
SELECT '현대엘리베이터입니다. '||M1.POSID||M1.ZSITE_NM||'완성검사일 15일전입니다. 영업담당자께서는 완성검사 7일전까지 수금 바랍니다.' AS TRAN_MSG,
       REPLACE(M1.ZTEL,'-','') AS TRAN_PHONE,
       VALUE((SELECT CASE WHEN LIFNR = '2168114582' OR LIFNR = '1078165792' OR LIFNR = '1108176067' OR LIFNR = '1288621802' OR LIFNR = '1268171669' OR LIFNR = '2108157564' OR LIFNR = '1388141265' THEN DTEXT2 ELSE DTEXT1 END FROM SAPHEE.ZLCODE AS M28 WHERE M28.MANDT = M.MANDT AND M28.CODE1 = 'PS003' AND M28.LANG = 'ko' AND M28.CODE2 = M1.ZZACTSS), '1577-0603') AS TRAN_CALLBACK,
       'PS_WEB' AS TRAN_ETC1,
       M1.POSID AS TRAN_ETC2
FROM  (
        SELECT M.MANDT,M.POSID, MAX(M.LIFNR) AS LIFNR
        FROM SAPHEE.ZMASTER02 AS M
		 	LEFT OUTER JOIN SAPHEE.ZPST0201 AS P
		      ON M.MANDT = P.MANDT 
		    AND M.POSID = P.PSPID
		    AND M.POSID_1 = P.POSID
		    AND P.CHK_KIND = 'A'
	     	AND P.CHASU = '001'
		   LEFT OUTER JOIN SAPHEE.ZPST0023 T1 
		      ON P.MANDT = T1.MANDT 
			 AND P.PSPID = T1.PSPID 
			 AND P.POSID = T1.POSID 
			 AND T1.ZTYPE = '2'
		
        WHERE M.MANDT = #G_MANDT#
       AND P.REQ_DATE = HEX(CURRENT DATE + 15 DAY)
        AND M.TEMNO > ''
        AND T1.APPYN <> 'Y'
        AND M.TXT30 <> '취소'        
        AND (M.POSID_1 LIKE '______L__' OR M.POSID_1 LIKE '______S__' OR M.POSID_1 LIKE '______W__')
        GROUP BY M.MANDT,M.POSID
       ) M,
	   SAPHEE.ZMASTER01 M1
WHERE M1.ZTEL > ''
AND M1.ZTEL IS NOT NULL
AND M.MANDT = M1.MANDT
AND M.POSID = M1.POSID
-- 
UNION
-- 영업담당자

SELECT '현대엘리베이터입니다. '||M1.POSID||M1.ZSITE_NM||'완성검사일 7일전입니다. 영업담당자께서는 완성검사 7일전까지 수금 바랍니다.' AS TRAN_MSG,
       REPLACE(M1.ZTEL,'-','') AS TRAN_PHONE,
       VALUE((SELECT CASE WHEN LIFNR = '2168114582' OR LIFNR = '1078165792' OR LIFNR = '1108176067' OR LIFNR = '1288621802' OR LIFNR = '1268171669' OR LIFNR = '2108157564' OR LIFNR = '1388141265' THEN DTEXT2 ELSE DTEXT1 END FROM SAPHEE.ZLCODE AS M28 WHERE M28.MANDT = M.MANDT AND M28.CODE1 = 'PS003' AND M28.LANG = 'ko' AND M28.CODE2 = M1.ZZACTSS), '1577-0603') AS TRAN_CALLBACK,
       'PS_WEB' AS TRAN_ETC1,
       M1.POSID AS TRAN_ETC2
FROM  (
        SELECT M.MANDT,M.POSID, MAX(M.LIFNR) AS LIFNR
        FROM SAPHEE.ZMASTER02 AS M
		 	LEFT OUTER JOIN SAPHEE.ZPST0201 AS P
		      ON M.MANDT = P.MANDT 
		    AND M.POSID = P.PSPID
		    AND M.POSID_1 = P.POSID
		    AND P.CHK_KIND = 'A'
	     	AND P.CHASU = '001'
		   LEFT OUTER JOIN SAPHEE.ZPST0023 T1 
		      ON P.MANDT = T1.MANDT 
			 AND P.PSPID = T1.PSPID 
			 AND P.POSID = T1.POSID 
			 AND T1.ZTYPE = '2'
		
        WHERE M.MANDT = #G_MANDT#
       AND P.REQ_DATE = HEX(CURRENT DATE + 7 DAY)
        AND M.TEMNO > ''
        AND T1.APPYN <> 'Y'
        AND M.TXT30 <> '취소'
        AND (M.POSID_1 LIKE '______L__' OR M.POSID_1 LIKE '______S__' OR M.POSID_1 LIKE '______W__')
        GROUP BY M.MANDT,M.POSID
       ) M,
	   SAPHEE.ZMASTER01 M1
WHERE M1.ZTEL > ''
AND M1.ZTEL IS NOT NULL
AND M.MANDT = M1.MANDT
AND M.POSID = M1.POSID

UNION

-- G1 통과, G2 미통과 현장 PM 문자발송 (3일이 지난 경우)
SELECT A.PSPID||' '||E.ZSITE_NM||CHR(13)||A.POSID||'호기'||CHR(13)||'G1(수금,사양) 완료되었습니다.'||CHR(13)||'착준공입력 바랍니다.' AS TRAN_MSG,
       REPLACE(D.CELLP,'-','') AS TRAN_PHONE,
       '1577-0603' AS TRAN_CALLBACK,
       'PS_WEB' AS TRAN_ETC1,
       A.POSID AS TRAN_ETC2
       
  FROM SAPHEE.ZPPT027G AS A
 LEFT OUTER JOIN SAPHEE.PRPS AS B
              ON A.MANDT = B.MANDT
             AND A.POSID = B.POSID
 LEFT OUTER JOIN SAPHEE.ZMASTER02 AS C
              ON C.MANDT = A.MANDT
             AND C.POSID = A.PSPID
             AND C.POSID_1 = A.POSID
 LEFT OUTER JOIN SAPHEE.ZPST0011 AS D
              ON D.MANDT = C.MANDT
             AND D.TEMNO = C.TEMNO
 LEFT OUTER JOIN SAPHEE.ZMASTER01 AS E
              ON E.MANDT = C.MANDT
             AND E.POSID = C.POSID
 WHERE A.MANDT = #G_MANDT#
   AND A.ACTIV = 'G10'
   AND A.GUBUN = '02'
   AND A.BLOCK = 'A'
   AND B.ZZINTER <> 'X'
   AND B.STUFE = '2'
   AND B.PRART IN ('01', '02', '11')
   AND B.ZZGUBUN IN ('10','13')
   AND (D.CELLP <> '' AND D.CELLP IS NOT NULL)
   AND SAPHEE.GET_WORKINGDAY(DECODE(A.ILDAT,'00000000','19990101',A.ILDAT),3) = HEX(CURRENT DATE) -- G1 통과시점의 WORKING DAY 기준 3일 후가 오늘인 경우
   AND SAPHEE.GET_WORKINGDAY(SUBSTR(REPLACE(CHAR(DATE(SUBSTR(HEX(CURRENT DATE),1,4) ||'-'|| SUBSTR(HEX(CURRENT DATE),5,2) ||'-'|| SUBSTR(HEX(CURRENT DATE),7,2)) - 1 DAYS ),'-',''),1,8),1) = HEX(CURRENT DATE) -- 오늘이 WORKING DAY 인 경우만 발송.
   AND A.POSID NOT IN (
   							SELECT X.POSID
   							  FROM SAPHEE.ZPPT027G AS X
   							 WHERE X.MANDT = A.MANDT
   							   AND X.PSPID = A.PSPID
   							   AND X.POSID = A.POSID
   							   AND X.ACTIV = 'G20'
   							   AND X.GUBUN = '02'
                      )
   
UNION

-- G1 통과, G2 미통과 현장 PM 문자발송 (4일이 지난 경우)
SELECT A.PSPID||' '||E.ZSITE_NM||CHR(13)||A.POSID||'호기'||CHR(13)||'G1(수금,사양) 완료되었습니다.'||CHR(13)||'착준공입력 바랍니다.' AS TRAN_MSG,
       REPLACE(D.CELLP,'-','') AS TRAN_PHONE,
       '1577-0603' AS TRAN_CALLBACK,
       'PS_WEB' AS TRAN_ETC1,
       A.POSID AS TRAN_ETC2
       
  FROM SAPHEE.ZPPT027G AS A
 LEFT OUTER JOIN SAPHEE.PRPS AS B
              ON A.MANDT = B.MANDT
             AND A.POSID = B.POSID
 LEFT OUTER JOIN SAPHEE.ZMASTER02 AS C
              ON C.MANDT = A.MANDT
             AND C.POSID = A.PSPID
             AND C.POSID_1 = A.POSID
 LEFT OUTER JOIN SAPHEE.ZPST0011 AS D
              ON D.MANDT = C.MANDT
             AND D.TEMNO = C.TEMNO
 LEFT OUTER JOIN SAPHEE.ZMASTER01 AS E
              ON E.MANDT = C.MANDT
             AND E.POSID = C.POSID
 
 WHERE A.MANDT = #G_MANDT#
   AND A.ACTIV = 'G10'
   AND A.GUBUN = '02'
   AND A.BLOCK = 'A'
   AND B.ZZINTER <> 'X'
   AND B.STUFE = '2'
   AND B.PRART IN ('01', '02', '11')
   AND B.ZZGUBUN IN ('10','13')
   AND (D.CELLP <> '' AND D.CELLP IS NOT NULL)
   AND SAPHEE.GET_WORKINGDAY(DECODE(A.ILDAT,'00000000','19990101',A.ILDAT),4) = HEX(CURRENT DATE) -- G1 통과시점의 WORKING DAY 기준 3일 후가 오늘인 경우
   AND SAPHEE.GET_WORKINGDAY(SUBSTR(REPLACE(CHAR(DATE(SUBSTR(HEX(CURRENT DATE),1,4) ||'-'|| SUBSTR(HEX(CURRENT DATE),5,2) ||'-'|| SUBSTR(HEX(CURRENT DATE),7,2)) - 1 DAYS ),'-',''),1,8),1) = HEX(CURRENT DATE) -- 오늘이 WORKING DAY 인 경우만 발송.
   AND A.POSID NOT IN (
   							SELECT X.POSID
   							  FROM SAPHEE.ZPPT027G AS X
   							 WHERE X.MANDT = A.MANDT
   							   AND X.PSPID = A.PSPID
   							   AND X.POSID = A.POSID
   							   AND X.ACTIV = 'G20'
   							   AND X.GUBUN = '02'
                      )


--UNION
--
---- 발주처 건축담당자
--SELECT '현대엘리베이터입니다. '||M1.ZSITE_NM||' 착공 20일전입니다.' AS TRAN_MSG,
--       replace(P.CELLP,'-','')  AS TRAN_PHONE,
--       (SELECT CASE WHEN LIFNR = '2168114582' OR LIFNR = '1078165792' OR LIFNR = '1108176067' OR LIFNR = '1288621802' OR LIFNR = '1268171669' OR LIFNR = '2108157564' OR LIFNR = '1388141265' THEN DTEXT2 ELSE DTEXT1 END FROM SAPHEE.ZLCODE AS M28 WHERE M28.MANDT = M.MANDT AND M28.CODE1 = 'PS003' AND M28.LANG = 'ko' AND M28.CODE2 = M1.ZZACTSS) AS TRAN_CALLBACK,
--       'PS_WEB' AS TRAN_ETC1,
--       M1.POSID AS TRAN_ETC2
--FROM  (
--        SELECT MANDT,POSID, MAX(LIFNR) AS LIFNR
--        FROM SAPHEE.ZMASTER02 AS M
--        WHERE M.MANDT = #G_MANDT#
--        AND M.ZZSHIP1 = HEX(CURRENT DATE + 20 DAY)
--        AND (M.POSID_1 LIKE '______L__' OR M.POSID_1 LIKE '______S__' OR M.POSID_1 LIKE '______W__')
--        GROUP BY MANDT,POSID
--       ) M,
--	   (
--	    SELECT T.MANDT, T.PSPID, T.CELLP
--        FROM SAPHEE.ZPST0019 AS T,
--            (SELECT MANDT,PSPID,MAX(SEQNO) AS SEQNO
--             FROM SAPHEE.ZPST0019
--             WHERE MANDT = #G_MANDT#
--             AND CELLP > ''
--             AND CELLP LIKE '0%'
--             AND CELLP NOT LIKE '00%'
--             GROUP BY MANDT,PSPID
--            ) AS T2
--        WHERE T.MANDT = T2.MANDT
--        AND T.PSPID = T2.PSPID
--        AND T.SEQNO = T2.SEQNO
--	   ) AS P,
--	   SAPHEE.ZMASTER01 M1
--WHERE  M.MANDT = P.MANDT
--AND M.POSID = P.PSPID
--AND M.MANDT = M1.MANDT
--AND M.POSID = M1.POSID
--
--UNION
--
---- 발주처 건축담당자
--SELECT '현대엘리베이터입니다. '||M1.ZSITE_NM||' 준공 10일전입니다.'  AS TRAN_MSG,
--       replace(P.CELLP,'-','')  AS TRAN_PHONE,
--       (SELECT CASE WHEN LIFNR = '2168114582' OR LIFNR = '1078165792' OR LIFNR = '1108176067' OR LIFNR = '1288621802' OR LIFNR = '1268171669' OR LIFNR = '2108157564' OR LIFNR = '1388141265' THEN DTEXT2 ELSE DTEXT1 END FROM SAPHEE.ZLCODE AS M28 WHERE M28.MANDT = M.MANDT AND M28.CODE1 = 'PS003' AND M28.LANG = 'ko' AND M28.CODE2 = M1.ZZACTSS) AS TRAN_CALLBACK,
--       'PS_WEB' AS TRAN_ETC1,
--       M1.POSID AS TRAN_ETC2
--FROM  (
--        SELECT MANDT,POSID, MAX(LIFNR) AS LIFNR
--        FROM SAPHEE.ZMASTER02 AS M
--        WHERE M.MANDT = #G_MANDT#
--        AND M.ZZCOMP2 = HEX(CURRENT DATE + 10 DAY)
--        AND (M.POSID_1 LIKE '______L__' OR M.POSID_1 LIKE '______S__' OR M.POSID_1 LIKE '______W__')
--        GROUP BY MANDT,POSID
--       ) M,
--	   (
--	    SELECT T.MANDT, T.PSPID, T.CELLP
--        FROM SAPHEE.ZPST0019 AS T,
--            (SELECT MANDT,PSPID,MAX(SEQNO) AS SEQNO
--             FROM SAPHEE.ZPST0019
--             WHERE MANDT = #G_MANDT#
--             AND CELLP > ''
--             AND CELLP LIKE '0%'
--             AND CELLP NOT LIKE '00%'
--             GROUP BY MANDT,PSPID
--            ) AS T2
--        WHERE T.MANDT = T2.MANDT
--        AND T.PSPID = T2.PSPID
--        AND T.SEQNO = T2.SEQNO
--	   ) AS P,
--	   SAPHEE.ZMASTER01 M1
--WHERE  M.MANDT = P.MANDT
--AND M.POSID = P.PSPID
--AND M.MANDT = M1.MANDT
--AND M.POSID = M1.POSID
--
--UNION
--
---- 발주처 건축담당자
--SELECT '현대엘리베이터입니다. '||M1.ZSITE_NM||' 착공 3일전입니다.' AS TRAN_MSG,
--       replace(P.CELLP,'-','')  AS TRAN_PHONE,
--       (SELECT CASE WHEN LIFNR = '2168114582' OR LIFNR = '1078165792' OR LIFNR = '1108176067' OR LIFNR = '1288621802' OR LIFNR = '1268171669' OR LIFNR = '2108157564' OR LIFNR = '1388141265' THEN DTEXT2 ELSE DTEXT1 END FROM SAPHEE.ZLCODE AS M28 WHERE M28.MANDT = M.MANDT AND M28.CODE1 = 'PS003' AND M28.LANG = 'ko' AND M28.CODE2 = M1.ZZACTSS) AS TRAN_CALLBACK,
--       'PS_WEB' AS TRAN_ETC1,
--       M1.POSID AS TRAN_ETC2
--FROM  (
--        SELECT MANDT,POSID, MAX(LIFNR) AS LIFNR
--        FROM SAPHEE.ZMASTER02 AS M
--        WHERE M.MANDT = #G_MANDT#
--        AND M.ZZSHIP1 = HEX(CURRENT DATE + 3 DAY)
--        AND (M.POSID_1 LIKE '______L__' OR M.POSID_1 LIKE '______S__' OR M.POSID_1 LIKE '______W__')
--        GROUP BY MANDT,POSID
--       ) M,
--	   (
--	    SELECT T.MANDT, T.PSPID, T.CELLP
--        FROM SAPHEE.ZPST0019 AS T,
--            (SELECT MANDT,PSPID,MAX(SEQNO) AS SEQNO
--             FROM SAPHEE.ZPST0019
--             WHERE MANDT = #G_MANDT#
--             AND CELLP > ''
--             AND CELLP LIKE '0%'
--             AND CELLP NOT LIKE '00%'
--             GROUP BY MANDT,PSPID
--            ) AS T2
--        WHERE T.MANDT = T2.MANDT
--        AND T.PSPID = T2.PSPID
--        AND T.SEQNO = T2.SEQNO
--	   ) AS P,
--	   SAPHEE.ZMASTER01 M1
--WHERE  M.MANDT = P.MANDT
--AND M.POSID = P.PSPID
--AND M.MANDT = M1.MANDT
--AND M.POSID = M1.POSID


FOR FETCH ONLY
WITH UR	]]></statement>
	<input default-name="_none">
	</input>
	<output default-name="_none">
	</output>
</query>
