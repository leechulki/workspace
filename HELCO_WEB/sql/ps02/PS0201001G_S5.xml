<?xml version="1.0" encoding="euc-kr"?>
<query>
	<type>select</type>
	<description><![CDATA[]]></description>
	<reload>true</reload>
	<monitoring>true</monitoring>
	<result-count>0</result-count>
	<statement>
<![CDATA[
-- 자재반일 예상일이 나중이거나 월이 다른 경우 메일 발송 
-- 자재반입 예상일, 착공예정일,  구분, 공사번호, 현장명, 영업담당, 설치PM
-- 오더유형 ZN01, ZS01(직영) : SRM 프로젝트 호기정보 상의 “영업담당자”  / 오더유형 ZN02, ZS02(대리점) : SRM 프로젝트 호기정보 상의 “영업관리담당자”
SELECT A.MATNR_DATE, B.STADA, C.GUBUN, C.ZZPJT_ID, C.ZSITE_NM, C.ZMAN_NM, C.NAMET, C.POSID_1, D.CNT, 
CASE  WHEN C.AUART = 'ZN01' THEN C.USERMAIL
      WHEN C.AUART = 'ZS01' THEN C.USERMAIL
      WHEN C.AUART = 'ZN02' THEN E.USERMAIL
      WHEN C.AUART = 'ZS02' THEN E.USERMAIL
ELSE '' END MAILRECV, 
CASE  WHEN C.AUART = 'ZN01' THEN C.ZMAN_NM
      WHEN C.AUART = 'ZS01' THEN C.ZMAN_NM
      WHEN C.AUART = 'ZN02' THEN E.NAME1
      WHEN C.AUART = 'ZS02' THEN E.NAME1
ELSE '' END MAILRECVNM 
FROM 
(
    -- 최초등록 착준공 대상 조회 자재반입 예상일 
    SELECT MATNR_DATE
    FROM SAPHEE.ZPST0019 
    WHERE PSPID = #PSPID# AND MANDT = #G_MANDT#  AND DEL <> 'X'
            AND SEQNO = 
                      ( SELECT MIN(SEQNO)
                        FROM SAPHEE.ZPST0019 
                        WHERE PSPID = #PSPID# AND MANDT = #G_MANDT# AND DEL <> 'X'
                      )
) A INNER JOIN
(
    -- 수주변경및 조회 화면 착공예정일 
    SELECT MIN(STADA) AS STADA 
    FROM SAPHEE.ZSDT1046 A 
      INNER JOIN SAPHEE.VBAP B ON A.MANDT = B.MANDT AND A.QTNUM = B.QTNUM
    WHERE A.MANDT = #G_MANDT# AND A.VBELN = #PSPID# AND B.STADA <> '00000000'
) B ON 1 = 1
INNER JOIN 
(
    --  구분, 공사번호, 현장명, 영업담당, 설치PM, 구분, 영업담당 이메일 
    SELECT B.GUBUN, A.ZZPJT_ID, ZM01.ZSITE_NM, ZM01.ZMAN_NM, ZM02.NAMET, MIN(ZM02.POSID_1) POSID_1, A.AUART, ZUS.USERMAIL
    FROM SAPHEE.VBAK  A 
      INNER JOIN SAPHEE.ZPPT175 B ON A.VKGRP = B.VKGRP AND A.MANDT = B.MANDT
      INNER JOIN SAPHEE.TVGRT C ON B.VKGRP = C.VKGRP AND B.MANDT = C.MANDT
      INNER JOIN SAPHEE.ZMASTER01 ZM01 ON A.ZZPJT_ID = ZM01.POSID AND C.MANDT = ZM01.MANDT 
      INNER JOIN SAPHEE.ZMASTER02 ZM02  ON ZM01.POSID = ZM02.POSID AND ZM01.MANDT = ZM02.MANDT
      LEFT OUTER JOIN SAPHEE.ZUSERF ZUS ON SUBSTR(ZM01.ZMAN, 2) = ZUS.USERNUMB
    WHERE A.MANDT = #G_MANDT# AND  A.ZZPJT_ID = #PSPID#
    GROUP BY B.GUBUN, A.ZZPJT_ID, ZM01.ZSITE_NM, ZM01.ZMAN_NM, ZM02.NAMET, A.AUART, ZUS.USERMAIL
    FETCH FIRST 1 ROW ONLY
) C ON 1 = 1
INNER JOIN 
( 
    SELECT COUNT(*) AS CNT 
    FROM SAPHEE.ZPST0019
    WHERE MANDT = #G_MANDT# AND PSPID = #PSPID#  AND DEL <> 'X'
) D ON 1 = 1
INNER JOIN
(
    SELECT VBAK.MANDT, VBAK.ZZPJT_ID, KNA1.NAME1, ZUSERF.USERMAIL, ZUSERF.USERMBPN
		FROM SAPHEE.VBAK AS VBAK
		  INNER JOIN SAPHEE.VBPA AS VBPA
		      ON VBAK.MANDT=VBPA.MANDT
		       AND VBAK.VBELN=VBPA.VBELN
		       AND VBPA.POSNR='000000'
		       AND VBPA.PARVW='Z2'
		LEFT JOIN SAPHEE.ZSDT0149 AS Z149
		       ON VBPA.MANDT=Z149.MANDT
		        AND VBPA.KUNNR=Z149.DEALER
		     AND Z149.SDFIELD = (CASE VBAK.SPART WHEN '20' THEN 'PRK' ELSE (CASE SUBSTR(VBAK.AUART,1,2) WHEN 'ZN' THEN 'REM' ELSE 'NI' END)   END)
		LEFT JOIN SAPHEE.KNA1 AS KNA1
		      ON Z149.MANDT=KNA1.MANDT
		    AND Z149.MANAGER=KNA1.KUNNR
		LEFT JOIN SAPHEE.ZUSERF AS ZUSERF
		       ON KNA1.MANDT=ZUSERF.MANDT
		        AND KNA1.KUNNR='H'||ZUSERF.USERNUMB

		WHERE VBAK.MANDT    = #G_MANDT#
		  AND VBAK.ZZPJT_ID = #PSPID#
		FETCH FIRST 1 ROWS ONLY
) E ON 1 = 1
FOR FETCH ONLY
WITH UR	]]></statement>
	<input default-name="ds_master">
	</input>
	<output default-name="ds_check">
	</output>
</query>
