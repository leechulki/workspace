<?xml version="1.0" encoding="euc-kr"?>
<query>
	<type>select</type>
	<description><![CDATA[]]></description>
	<reload>true</reload>
	<monitoring>true</monitoring>
	<result-count>1</result-count>
	<statement>
<![CDATA[
SELECT  T.MANDT, T.LIFNR,MAX(T.NAME1) AS NAME1 , 
              (SELECT P1.NAMEC 
                 FROM SAPHEE.ZPST0001 AS P1 
                WHERE P1.MANDT = T.MANDT 
                  AND P1.LIFNR = T.LIFNR
                  AND P1.POSIC = 'X'
                  AND P1.GBN = 'A'
                  AND P1.RETIF <> 'X'
                  FETCH FIRST 1 ROWS ONLY) AS NAMEC,
              M12.TELF1 AS TELNO_O, M12.TELFX  AS FAX_O,   MAX(M12.MCOD3||' '||M12.STRAS) AS ADDR,
              SUM(CASE WHEN VALUE(T2.TUIP_CHKA,'') = 'X' AND  VALUE(T2.TUIP_CHKB,'') <> 'X'  THEN 1 ELSE 0 END) AS TUIP_CHKA,
              SUM(CASE WHEN VALUE(T2.TUIP_CHKA,'') <> 'X' AND  VALUE(T2.TUIP_CHKB,'') = 'X'  THEN 1 ELSE 0 END) AS TUIP_CHKB,
			        SUM(CASE WHEN VALUE(T2.TUIP_CHKA,'') <> 'X' AND  VALUE(T2.TUIP_CHKB,'') <> 'X' THEN 1 ELSE 0 END) AS TUIP_CHKC
			  
   FROM
(SELECT   P1.MANDT,P1.LIFNR ,  P1.PERNO , P1.NAME1 , P1.POSIC
FROM SAPHEE.ZPST0138 AS P1
INNER JOIN SAPHEE.ZPST0034 AS B
  ON P1.MANDT = B.MANDT
  AND P1.LIFNR = B.LIFNR
  AND B.GBN = 'A'
WHERE P1.MANDT =  #G_MANDT#
  AND (SELECT CASE WHEN COUNT(P.MANDT) = 0 THEN 'B'
            ELSE CASE WHEN (SELECT COUNT(*) FROM SAPHEE.ZPST0143 P2
WHERE P2.MANDT = P1.MANDT AND P2.LIFNR = P1.LIFNR AND P2.PERNO =
P1.PERNO AND P2.SIGN > '') = 0 THEN 'A'
                      WHEN (SELECT COUNT(*) FROM SAPHEE.ZPST0143 P2
WHERE P2.MANDT = P1.MANDT AND P2.LIFNR = P1.LIFNR AND P2.PERNO =
P1.PERNO AND P2.SIGN = '반송') > 0 OR (SELECT COUNT(*) FROM
SAPHEE.ZPST0143 P2 WHERE P2.MANDT = P1.MANDT AND P2.LIFNR = P1.LIFNR
AND P2.PERNO = P1.PERNO AND P2.SIGN > '') = COUNT(P.MANDT) THEN 'D'
                 ELSE 'C' END
            END CNT
     FROM SAPHEE.ZPST0143 AS P WHERE P.MANDT = P1.MANDT AND P.LIFNR =
P1.LIFNR AND P.PERNO = P1.PERNO
    ) IN ('A' , 'C')
 AND (SELECT CASE WHEN COUNT(P.MANDT) = 0 THEN 'B'
            ELSE CASE WHEN (SELECT COUNT(*) FROM SAPHEE.ZPST0143 P2
WHERE P2.MANDT = P1.MANDT AND P2.LIFNR = P1.LIFNR AND P2.PERNO =
P1.PERNO AND P2.SIGN > '') = 0 THEN 'A'
                      WHEN (SELECT COUNT(*) FROM SAPHEE.ZPST0143 P2
WHERE P2.MANDT = P1.MANDT AND P2.LIFNR = P1.LIFNR AND P2.PERNO =
P1.PERNO AND P2.SIGN = '반송') > 0 OR (SELECT COUNT(*) FROM
SAPHEE.ZPST0143 P2 WHERE P2.MANDT = P1.MANDT AND P2.LIFNR = P1.LIFNR
AND P2.PERNO = P1.PERNO AND P2.SIGN > '') = COUNT(P.MANDT) THEN 'D'
                 ELSE 'C' END
            END CNT
     FROM SAPHEE.ZPST0143 AS P WHERE P.MANDT = P1.MANDT AND P.LIFNR =
P1.LIFNR AND P.PERNO = P1.PERNO
    ) <> 'D'
      AND P1.STATS = 'B'
      AND P1.RETIF = ''
   --   AND ( P1.POSIE  = 'X' OR  P1.POSIT = 'X')
      AND  P1.GUBUN IN ('01','02')
      AND  P1.TYPE = '1'  AND  P1.DIRECT = 'X'
      AND  P1.ACTSS NOT IN ('00', '15', '16')
       AND (P1.RETID = '' OR P1.RETID = '00000000'
                OR P1.RETID >= #INP_DT#)
     AND B.SO5 <> 'X'
	 AND P1.LIFNR = #LIFNR#	
UNION ALL


SELECT   P1.MANDT,P1.LIFNR ,  P1.PERNO , P1.NAME1 , P1.POSIC
FROM SAPHEE.ZPST0001 AS P1
WHERE P1.MANDT = #G_MANDT#
AND P1.LIFNR = #LIFNR#
AND P1.RETIF = ''
--AND ( P1.POSIE  = 'X' OR  P1.POSIT = 'X')
AND  P1.GUBUN IN ('01','02')
AND  P1.TYPE = '1'  AND  P1.DIRECT = 'X'
AND  P1.ACTSS NOT IN ('00', '15', '16')
AND (P1.RETID = '' OR P1.RETID = '00000000' OR P1.RETID >= #INP_DT#)
AND P1.GBN = 'A'

) AS T

LEFT OUTER JOIN SAPHEE.ZPSTW0301 AS T2
  ON T.MANDT = T2.MANDT
  AND T.LIFNR = T2.LIFNR
  AND T.PERNO = T2.PERNO 
  AND T2.INP_DT =  #INP_DT#

 LEFT OUTER JOIN SAPHEE.ZMMT012 AS M12
  ON T.MANDT = M12.MANDT
 AND T.LIFNR = M12.LIFNR

GROUP BY T.MANDT,T.LIFNR  ,M12.TELF1, M12.TELFX

FOR FETCH ONLY WITH UR	]]></statement>
	<input default-name="ds_cond">
		<col name="G_MANDT" size="255" type="VARCHAR" description="" /> 
		<col name="LIFNR" size="255" type="VARCHAR" description="" /> 
	</input>
	<output default-name="ds_head">
	</output>
</query>
