<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" 
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="hdel.sd.ses.dao.Ses0560D"> 
  
	<resultMap id="selectListHeaderMap" type="hdel.sd.ses.domain.Ses0560"> 
	    <result property="mandt" column="MANDT"/>
	    <result property="qtnum" column="QTNUM"/>
	    <result property="qtser" column="QTSER"/>
	    <result property="qtdat" column="QTDAT"/>
	    <result property="spart" column="SPART"/>
	    <result property="qtgbn" column="QTGBN"/>
	    <result property="zbdtyp" column="ZBDTYP"/>
	    <result property="zprgflg" column="ZPRGFLG"/>
	    <result property="vkbur" column="VKBUR"/>
	    <result property="vkgrp" column="VKGRP"/>
	    <result property="zkunnr" column="ZKUNNR"/>
	    <result property="zagnt" column="ZAGNT"/>
	    <result property="kunnr" column="KUNNR"/>
	    <result property="zcst" column="ZCST"/>
	    <result property="zgnm" column="ZGNM"/>
	    <result property="zdev" column="ZDEV"/>
	    <result property="gsnam" column="GSNAM"/>
	    <result property="zregn" column="ZREGN"/>
	    <result property="zpid" column="ZPID"/>
	    <result property="ztel" column="ZTEL"/>
	    <result property="zaddr_zpost" column="ZADDR_ZPOST"/>
	    <result property="zaddr_adr1" column="ZADDR_ADR1"/>
	    <result property="zaddr_adr2" column="ZADDR_ADR2"/>
	    <result property="soable" column="SOABLE"/>
	    <result property="zestdat" column="ZESTDAT"/>
	    <result property="deldat" column="DELDAT"/>
	    <result property="zdvmts" column="ZDVMTS"/>
	    <result property="zsum_znumber" column="ZSUM_ZNUMBER"/>
	    <result property="zsum_zcost" column="ZSUM_ZCOST"/>
	    <result property="zsum_zeam" column="ZSUM_ZEAM"/>
	    <result property="zsum_shang" column="ZSUM_SHANG"/>
	    <result property="inco" column="INCO"/>
	    <result property="zicif_pprt" column="ZICIF_PPRT"/>
	    <result property="zicif_ppct" column="ZICIF_PPCT"/>
	    <result property="zicif_ppcd" column="ZICIF_PPCD"/>
	    <result property="zicif_1strt" column="ZICIF_1STRT"/>
	    <result property="zicif_1stct" column="ZICIF_1STCT"/>
	    <result property="zicif_1stcd" column="ZICIF_1STCD"/>
	    <result property="zicif_2strt" column="ZICIF_2STRT"/>
	    <result property="zicif_2stct" column="ZICIF_2STCT"/>
	    <result property="zicif_2stcd" column="ZICIF_2STCD"/>
	    <result property="zicif_rmrt" column="ZICIF_RMRT"/>
	    <result property="zicif_rmct" column="ZICIF_RMCT"/>
	    <result property="zicif_rmcd" column="ZICIF_RMCD"/>
	    <result property="sprmk1" column="SPRMK1"/>
	    <result property="sprmk2" column="SPRMK2"/>
	    <result property="sprmk3" column="SPRMK3"/>
	    <result property="sprmk4" column="SPRMK4"/>
	    <result property="sprmk5" column="SPRMK5"/>
	    <result property="sprmk6" column="SPRMK6"/>
	    <result property="sprmk7" column="SPRMK7"/>
	    <result property="sprmk8" column="SPRMK8"/>
	    <result property="sprmk9" column="SPRMK9"/>
	    <result property="sprmk10" column="SPRMK10"/>
	    <result property="zsoflg" column="ZSOFLG"/>
	    <result property="sonnr" column="SONNR"/>
	    <result property="vbeln" column="VBELN"/>
	    <result property="waerk" column="WAERK"/>
	    <result property="auart" column="AUART"/>
	    <result property="co_ddvrtq" column="CO_DDVRTQ"/>
	    <result property="co_dephtq" column="CO_DEPHTQ"/>
	    <result property="co_dssq" column="CO_DSSQ"/>
	    <result property="co_bclcdtq" column="CO_BCLCDTQ"/>
	    <result property="co_chpitq" column="CO_CHPITQ"/>
	    <result property="co_aspc" column="CO_ASPC"/>
	    <result property="co_dsv1" column="CO_DSV1"/>
	    <result property="co_dsv1tq" column="CO_DSV1TQ"/>
	    <result property="co_dsv2" column="CO_DSV2"/>
	    <result property="co_dsv2tq" column="CO_DSV2TQ"/>
	    <result property="cdate" column="CDATE"/>
	    <result property="ctime" column="CTIME"/>
	    <result property="uuser" column="CUSER"/>
	    <result property="udate" column="UDATE"/>
	    <result property="utime" column="UTIME"/>
	    <result property="uuser" column="UUSER"/>
	    <result property="ddate" column="DDATE"/>
	    <result property="dtime" column="DTIME"/>
	    <result property="duser" column="DUSER"/>
	    <result property="zlzone" column="ZLZONE"/>
	    <result property="region" column="REGION"/>
	    <result property="zkunnr_nm" column="ZKUNNR_NM"/>
	    <result property="buyr_nm" column="BUYR_NM"/>
	    <result property="zagnt_nm" column="ZAGNT_NM"/>
	    <result property="zeam" column="ZEAM"/>
	    <result property="zattpath" column="ZATTPATH"/>
	    <result property="zattfn" column="ZATTFN"/>
	    <result property="zattfn_or" column="ZATTFN_OR"/>
	    <result property="part_cnt" column="PART_CNT"/>
	    <result property="fa_byrgbn" column="FA_BYRGBN"/>
	    <result property="zdeli" column="ZDELI"/>
	    <result property="tel" column="TEL"/>
	    <result property="fax" column="FAX"/>
	    <result property="mail" column="MAIL"/>
	    <result property="land1" column="LAND1"/>
	    <result property="landx" column="LANDX"/>
	    <result property="jgbn" column="JGBN"/>
	    <result property="aqtnum" column="AQTNUM"/>
	    <result property="oppid" column="OPPID"/>
	    <result property="uch_duty" column="UCH_DUTY"/>
	    <result property="frcmfcdat" column="FRCMFCDAT"/>
	</resultMap>
	
	<select id="selectListHeader" parameterType="hdel.sd.ses.domain.Ses0560ParamVO" resultMap="selectListHeaderMap">
		select z1046.qtnum, z1046.qtser,z1046.gsnam, z1046.zkunnr, kna1z.name1 as zkunnr_nm, z1046.zagnt, lfa1.name1 as zagnt_nm, z1046.kunnr, kna1.name1 as kunnr_nm, z1046.zsum_zcost, z1046.zsum_zeam
		from saphee.zsdt1046 as z1046
			left join saphee.kna1 as kna1z on z1046.mandt = kna1z.mandt and z1046.zkunnr=kna1z.kunnr
			left join saphee.lfa1 as lfa1 on z1046.mandt = lfa1.mandt and z1046.zagnt=lfa1.lifnr
			left join saphee.kna1 as kna1 on z1046.mandt = kna1.mandt and z1046.kunnr=kna1.kunnr
		where z1046.mandt = #{mandt} 
			<if test="frqtdat !=null and frqtdat !=''"> and z1046.qtdat between #{frqtdat} and #{toqtdat} </if>
			<if test="vkbur !=null and vkbur !=''">  and z1046.vkbur = #{vkbur} </if>
			<if test="vkgrp !=null and vkgrp !=''">  and z1046.vkgrp = #{vkgrp} </if>
			<if test="zkunnr !=null and zkunnr !=''">  and z1046.zkunnr = #{zkunnr} </if>
			<if test="qtnum !=null and qtnum !=''">  and z1046.qtnum = #{qtnum} </if>
			and z1046.qtser = ( select max(qtser) from saphee.zsdt1046 where mandt = z1046.mandt and qtnum = z1046.qtnum )
			and not exists (select mandt from saphee.zsdt1164 where mandt = z1046.mandt and sml_qtnum = z1046.qtnum and sml_qtser = z1046.qtser ) /* 모의견적 제외 추가 21.06.21 */ 
	</select>

	<update id="updateZSDT1046" parameterType="map">
		update saphee.zsdt1046 as z1046
			set 
			vkbur = (case qtnum
                           <foreach collection="changeZkunnr" item="item">
                                  when #{item.qtnum} then #{item.ch_vkbur}
                           </foreach>
                           else vkbur end)
					
				,vkgrp = (case qtnum
                           <foreach collection="changeZkunnr" item="item">
                                  when #{item.qtnum} then #{item.ch_vkgrp}
                           </foreach>
                           else vkgrp end)
						
				,zkunnr = (case qtnum
                           <foreach collection="changeZkunnr" item="item">
                                  when #{item.qtnum} then #{item.ch_zkunnr}
                           </foreach>
                           else zkunnr end)			
			
				,zagnt = (case qtnum
                           <foreach collection="changeZkunnr" item="item">
                                  when #{item.qtnum}                      
                                  then (select usercode from saphee.zuserf where mandt = z1046.mandt and usernumb = substr(#{item.ch_zkunnr},2,8))
                           </foreach>
                           else zagnt end)

		where mandt = #{entity.mandt}
					and qtnum in <foreach collection="changeZkunnr" item="item" open="(" close=")" separator=","> #{item.qtnum} </foreach>
	</update>
</mapper>  
